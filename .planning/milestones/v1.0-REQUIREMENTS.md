# Requirements Archive: v1.0 Foundation & Import Pipeline

**Archived:** 2026-02-10
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: Phase 1 — Architectural Foundation & Thread Safety

**Milestone scope:** Phase 1 only (of 8 identified phases)
**Goal:** Decompose the god class, establish thread-safe infrastructure, and fix relevant existing bugs/debt — creating a solid foundation for all future feature phases.

## Functional Requirements

### R1: Decompose Application God Class
- Extract concerns from Application.cpp (1,071 lines) into focused classes
- Target: Application.cpp reduced to ~300 lines (thin coordinator)
- Extract at minimum: UI management, file I/O dispatch, panel lifecycle
- Maintain identical external behavior — no visible UX changes
- **Weaves in:** DEBT-01 (Application god class)
- **Mapped to:** Sub-phase 1.4

### R2: EventBus for Cross-Subsystem Communication
- Publish/subscribe system for decoupled component communication
- Type-safe event dispatch (compile-time event type checking)
- Weak references to prevent subscriber memory leaks
- Main-thread-only execution (no cross-thread event dispatch)
- Used by existing subsystems (import pipeline notifications, workspace changes)
- **Mapped to:** Sub-phase 1.1

### R3: SQLite Connection Pool & WAL Mode
- Enable WAL (Write-Ahead Logging) mode for concurrent read/write
- Connection pool with 2-4 worker connections
- Per-thread connection access (no connection sharing across threads)
- Existing ImportQueue uses pooled connections instead of shared single connection
- **Weaves in:** DEBT-04 (single SQLite connection not thread-safe), BUG-06 (import pipeline race condition)
- **Mapped to:** Sub-phase 1.2

### R4: Main Thread Queue for Worker Communication
- Thread-safe queue for background workers to post results to main thread
- Main thread processes queue during frame update (ImGui-safe)
- Replace any direct cross-thread UI updates
- Document threading contract: all ImGui calls on main thread only
- **Mapped to:** Sub-phase 1.3

### R5: Threading Contracts
- Document which thread owns which resources
- Enforce main-thread-only for ImGui calls
- Define safe patterns for worker threads (queue results, never touch UI)
- Add assertions or runtime checks for thread ownership violations in debug builds
- **Mapped to:** Sub-phase 1.3

## Bug Fixes (Woven In)

### R6: Fix Existing Bugs Relevant to Foundation
- **BUG-01**: Cache ViewCube geometry, recompute on camera change only
- **BUG-02**: Use fmod for camera angle wrapping instead of O(n) loop
- **BUG-03**: Zero dimensions in framebuffer move constructor source
- **BUG-04**: Use std::optional for shader uniform cache (distinguish not-found from valid)
- **BUG-05**: Escape LIKE wildcards in database searches
- **BUG-06**: Fix ImportProgress race condition (covered by R3/R4)
- **BUG-07**: Fix normal matrix for non-uniform scaling
- **Mapped to:** Sub-phase 1.5

## Dead Code Cleanup (Woven In)

### R7: Remove Dead Code
- **DEAD-01**: Remove unused ViewportPanel drag/pan fields
- **DEAD-02**: Remove unused LibraryPanel contextMenuModelIndex
- **DEAD-03**: Remove empty ProjectPanel::refresh()
- **DEAD-04**: Either implement or remove UIManager file dialog stubs
- **DEAD-05**: Either load icon font or remove icons.h constants
- **DEAD-06**: Consolidate duplicate theme code (theme.cpp vs ui_manager.cpp)
- **Mapped to:** Sub-phase 1.6

## Non-Functional Requirements

### NR1: No Behavioral Changes
- All existing functionality works identically after refactoring
- Existing tests continue to pass
- No new UI elements or changed workflows
- **Applies to:** All sub-phases

### NR2: File Size Limits
- .cpp files max 800 lines
- .h files max 400 lines
- One class per header (per rulebook)
- **Applies to:** All sub-phases

### NR3: Performance
- No measurable performance regression
- Connection pool should improve import throughput under concurrent access
- **Applies to:** Sub-phases 1.2, 1.5

### NR4: Test Coverage
- Unit tests for EventBus (publish, subscribe, unsubscribe, weak refs)
- Unit tests for ConnectionPool (acquire, release, concurrent access)
- Unit tests for MainThreadQueue (post, process, ordering)
- Existing tests continue to pass
- **Weaves in:** TEST-02 (database concurrent access)
- **Applies to:** Sub-phases 1.1, 1.2, 1.3, 1.5

## Out of Scope (Deferred to Later Phases)

- CommandManager / undo-redo (Phase 2)
- New domain databases — tools, materials (Phase 3)
- Business workflow — customers, quotes (Phase 4)
- Enhanced cut list (Phase 5)
- CNC machine control (Phase 6)
- Watch folders, advanced search (Phase 7)
- Inventory, time tracking, PBR (Phase 8)
- CI/CD improvements (CI-01 through CI-05)
- Incomplete implementation items not related to foundation (IMPL-01 through IMPL-16 except where they intersect with threading/database)

## Success Criteria

1. Application.cpp is under 400 lines
2. All existing tests pass
3. New unit tests for EventBus, ConnectionPool, MainThreadQueue
4. SQLite WAL mode enabled, concurrent import + UI query works without SQLITE_BUSY
5. No dead code items from DEAD-01 through DEAD-06 remain
6. All 7 bugs (BUG-01 through BUG-07) fixed
7. Threading contract document exists and is enforced by debug assertions

---

## Traceability

| Requirement | Sub-Phase | Status |
|-------------|-----------|--------|
| R1 - God Class Decomposition | 1.4 | Not Started |
| R2 - EventBus | 1.1 | Not Started |
| R3 - ConnectionPool & WAL | 1.2 | Not Started |
| R4 - MainThreadQueue | 1.3 | Not Started |
| R5 - Threading Contracts | 1.3 | Not Started |
| R6 - Bug Fixes (7 bugs) | 1.5 | Not Started |
| R7 - Dead Code Cleanup (6 items) | 1.6 | Not Started |
| NR1 - No Behavioral Changes | All | Not Started |
| NR2 - File Size Limits | All | Not Started |
| NR3 - Performance | 1.2, 1.5 | Not Started |
| NR4 - Test Coverage | 1.1-1.3, 1.5 | Not Started |

**Coverage:** 7 functional requirements + 4 non-functional requirements = 11 requirements mapped to 6 sub-phases

**Verification:**
- All requirements mapped to at least one sub-phase: YES
- No orphaned requirements: YES
- No duplicate mappings (except NR1, NR2 which apply to all): YES

---
*Scoped: 2026-02-08*
*Source: research/SUMMARY.md + TODOS.md*
*Traceability updated: 2026-02-08*

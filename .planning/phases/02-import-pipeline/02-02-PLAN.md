---
phase: 02-import-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/database/schema.h
  - src/core/database/schema.cpp
  - src/core/database/gcode_repository.h
  - src/core/database/gcode_repository.cpp
autonomous: true

must_haves:
  truths:
    - "G-code files can be stored in the database with metadata"
    - "G-code files can be organized in operation groups under models"
    - "CNC Router Basic template exists as a pre-defined template"
  artifacts:
    - path: "src/core/database/gcode_repository.h"
      provides: "CRUD operations for G-code records and operation groups"
      contains: "class GCodeRepository"
    - path: "src/core/database/schema.cpp"
      provides: "Schema v3 with gcode_files, operation_groups, gcode_templates tables"
      contains: "gcode_files"
  key_links:
    - from: "src/core/database/gcode_repository.h"
      to: "src/core/database/database.h"
      via: "GCodeRepository takes Database& like ModelRepository"
      pattern: "GCodeRepository.*Database"
    - from: "src/core/database/schema.cpp"
      to: "gcode_files table"
      via: "CREATE TABLE gcode_files"
      pattern: "CREATE TABLE IF NOT EXISTS gcode_files"
---

<objective>
Create database schema extensions and repository for G-code files with hierarchy support.

Purpose: G-code files need their own storage with metadata (bounding box, travel distance, estimated time, feed rates, tool numbers) and organizational hierarchy (Model -> Operation Groups -> ordered G-code files). This is foundation for G-code import and library management.

Output: Schema v3 with gcode_files and operation_groups tables, GCodeRepository with full CRUD, CNC Router Basic template seeded.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-import-pipeline/02-CONTEXT.md
@.planning/phases/02-import-pipeline/02-RESEARCH.md
@src/core/database/schema.h
@src/core/database/schema.cpp
@src/core/database/model_repository.h
@src/core/database/model_repository.cpp
@src/core/database/database.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend database schema to v3 with G-code tables</name>
  <files>
    src/core/database/schema.h
    src/core/database/schema.cpp
  </files>
  <action>
**Schema version bump (schema.h):**
Change `CURRENT_VERSION` from 2 to 3.

**New tables in createTables() (schema.cpp):**

1. **gcode_files** table:
```sql
CREATE TABLE IF NOT EXISTS gcode_files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    hash TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    file_path TEXT NOT NULL,
    file_size INTEGER DEFAULT 0,
    bounds_min_x REAL DEFAULT 0,
    bounds_min_y REAL DEFAULT 0,
    bounds_min_z REAL DEFAULT 0,
    bounds_max_x REAL DEFAULT 0,
    bounds_max_y REAL DEFAULT 0,
    bounds_max_z REAL DEFAULT 0,
    total_distance REAL DEFAULT 0,
    estimated_time REAL DEFAULT 0,
    feed_rates TEXT DEFAULT '[]',
    tool_numbers TEXT DEFAULT '[]',
    imported_at TEXT DEFAULT CURRENT_TIMESTAMP,
    thumbnail_path TEXT
)
```

2. **operation_groups** table (hierarchy: model -> groups -> ordered gcode):
```sql
CREATE TABLE IF NOT EXISTS operation_groups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    model_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    sort_order INTEGER DEFAULT 0,
    FOREIGN KEY (model_id) REFERENCES models(id) ON DELETE CASCADE
)
```

3. **gcode_group_members** junction table:
```sql
CREATE TABLE IF NOT EXISTS gcode_group_members (
    group_id INTEGER NOT NULL,
    gcode_id INTEGER NOT NULL,
    sort_order INTEGER DEFAULT 0,
    PRIMARY KEY (group_id, gcode_id),
    FOREIGN KEY (group_id) REFERENCES operation_groups(id) ON DELETE CASCADE,
    FOREIGN KEY (gcode_id) REFERENCES gcode_files(id) ON DELETE CASCADE
)
```

4. **gcode_templates** table:
```sql
CREATE TABLE IF NOT EXISTS gcode_templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    groups TEXT NOT NULL
)
```

**Seed data:** Insert the CNC Router Basic template:
```sql
INSERT OR IGNORE INTO gcode_templates (name, groups)
VALUES ('CNC Router Basic', '["Roughing","Finishing","Profiling","Drilling"]')
```

**Indexes:**
```sql
CREATE INDEX IF NOT EXISTS idx_gcode_hash ON gcode_files(hash)
CREATE INDEX IF NOT EXISTS idx_gcode_name ON gcode_files(name)
CREATE INDEX IF NOT EXISTS idx_operation_groups_model ON operation_groups(model_id)
CREATE INDEX IF NOT EXISTS idx_gcode_group_members_group ON gcode_group_members(group_id)
```

**Migration note:** The schema currently has no migration system ("We don't do migrations, just recreate if needed" per comment in schema.cpp). Follow the same pattern — createTables uses `CREATE TABLE IF NOT EXISTS`, so adding new tables is safe on existing databases. The version bump from 2 to 3 is handled by the existing version check logic. However, for existing databases at version 2, the version mismatch will log a warning but still call createTables() which will create the new tables without destroying existing ones (because of IF NOT EXISTS). This is the correct behavior.
  </action>
  <verify>
Build: `cd /data/DW && cmake --build build --target dw 2>&1 | tail -10` — compiles cleanly. Run tests: `cd /data/DW/build && ctest --output-on-failure 2>&1 | tail -20` — all existing tests pass (schema changes are additive, not breaking).
  </verify>
  <done>
Schema version is 3. gcode_files, operation_groups, gcode_group_members, and gcode_templates tables are created. CNC Router Basic template is seeded. All existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GCodeRepository with CRUD and hierarchy operations</name>
  <files>
    src/core/database/gcode_repository.h
    src/core/database/gcode_repository.cpp
  </files>
  <action>
Create `GCodeRepository` following the exact same patterns as `ModelRepository`.

**Data structure (gcode_repository.h):**

```cpp
struct GCodeRecord {
    i64 id = 0;
    std::string hash;
    std::string name;
    Path filePath;
    u64 fileSize = 0;
    Vec3 boundsMin;
    Vec3 boundsMax;
    f32 totalDistance = 0.0f;
    f32 estimatedTime = 0.0f;
    std::vector<f32> feedRates;
    std::vector<int> toolNumbers;
    std::string importedAt;
    Path thumbnailPath;
};

struct OperationGroup {
    i64 id = 0;
    i64 modelId = 0;
    std::string name;
    int sortOrder = 0;
};

struct GCodeTemplate {
    i64 id = 0;
    std::string name;
    std::vector<std::string> groups;
};
```

**GCodeRepository class:**
Constructor: `explicit GCodeRepository(Database& db)`

CRUD methods:
- `std::optional<i64> insert(const GCodeRecord& record)` — insert G-code file
- `std::optional<GCodeRecord> findById(i64 id)`
- `std::optional<GCodeRecord> findByHash(std::string_view hash)`
- `std::vector<GCodeRecord> findAll()`
- `std::vector<GCodeRecord> findByName(std::string_view searchTerm)`
- `bool update(const GCodeRecord& record)`
- `bool updateThumbnail(i64 id, const Path& thumbnailPath)`
- `bool remove(i64 id)`
- `bool exists(std::string_view hash)` — for duplicate detection
- `i64 count()`

Hierarchy methods:
- `std::optional<i64> createGroup(i64 modelId, const std::string& name, int sortOrder)`
- `std::vector<OperationGroup> getGroups(i64 modelId)`
- `bool addToGroup(i64 groupId, i64 gcodeId, int sortOrder)`
- `bool removeFromGroup(i64 groupId, i64 gcodeId)`
- `std::vector<GCodeRecord> getGroupMembers(i64 groupId)`
- `bool deleteGroup(i64 groupId)`

Template methods:
- `std::vector<GCodeTemplate> getTemplates()`
- `bool applyTemplate(i64 modelId, const std::string& templateName)` — creates groups from template

**Implementation notes:**
- feedRates and toolNumbers stored as JSON arrays in the DB (same pattern as tags in ModelRepository — use simple JSON serialization: `"[100.0, 200.0]"`)
- GCodeTemplate.groups also stored as JSON array
- Follow ModelRepository patterns for Statement usage, bind/step/get
- The `rowToGCode` private method maps Statement columns to GCodeRecord fields
- `applyTemplate` reads the template, then calls `createGroup` for each group name
  </action>
  <verify>
Build: `cd /data/DW && cmake --build build --target dw 2>&1 | tail -10` — compiles cleanly. Ensure gcode_repository.cpp is added to the CMakeLists.txt build if not auto-discovered.
  </verify>
  <done>
GCodeRepository compiles and provides full CRUD for G-code records, operation group management, and template application. Data structures (GCodeRecord, OperationGroup, GCodeTemplate) are defined. Repository follows same patterns as ModelRepository.
  </done>
</task>

</tasks>

<verification>
1. `cd /data/DW && cmake --build build 2>&1 | grep -i error` — no compilation errors
2. Schema version is 3 in schema.h
3. All 4 new tables appear in createTables()
4. GCodeRepository has insert/find/update/remove plus hierarchy methods
5. Existing tests still pass
</verification>

<success_criteria>
- Schema v3 creates gcode_files, operation_groups, gcode_group_members, gcode_templates tables
- CNC Router Basic template seeded with Roughing/Finishing/Profiling/Drilling groups
- GCodeRepository provides full CRUD for G-code records
- GCodeRepository provides hierarchy operations (groups, template application)
- All existing tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/02-import-pipeline/02-02-SUMMARY.md`
</output>

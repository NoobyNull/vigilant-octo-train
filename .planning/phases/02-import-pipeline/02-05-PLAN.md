---
phase: 02-import-pipeline
plan: 05
type: execute
wave: 3
depends_on: ["02-04"]
files_modified:
  - src/ui/widgets/status_bar.h
  - src/ui/widgets/status_bar.cpp
  - src/ui/widgets/toast.h
  - src/ui/widgets/toast.cpp
  - src/ui/dialogs/import_summary_dialog.h
  - src/ui/dialogs/import_summary_dialog.cpp
  - src/managers/ui_manager.h
  - src/managers/ui_manager.cpp
autonomous: true

must_haves:
  truths:
    - "Import runs in background with progress indicator in status bar"
    - "User can continue working during import (no modal overlay)"
    - "Toast notifications appear for import errors when enabled"
    - "Batch completion shows summary dialog with duplicates and errors"
  artifacts:
    - path: "src/ui/widgets/status_bar.h"
      provides: "Status bar widget showing import progress"
      contains: "class StatusBar"
    - path: "src/ui/widgets/toast.h"
      provides: "Toast notification system"
      contains: "class ToastManager"
    - path: "src/ui/dialogs/import_summary_dialog.h"
      provides: "Post-import summary showing duplicates and errors"
      contains: "class ImportSummaryDialog"
  key_links:
    - from: "src/ui/widgets/status_bar.h"
      to: "src/core/import/import_task.h"
      via: "StatusBar reads ImportProgress for display"
      pattern: "ImportProgress"
    - from: "src/ui/widgets/toast.h"
      to: "src/managers/ui_manager.cpp"
      via: "UIManager renders toasts each frame"
      pattern: "renderToasts"
    - from: "src/managers/ui_manager.cpp"
      to: "src/ui/dialogs/import_summary_dialog.h"
      via: "UIManager shows summary when batch completes"
      pattern: "ImportSummaryDialog"
---

<objective>
Replace modal import overlay with background status bar indicator, add toast notifications for errors, and create import summary dialog.

Purpose: Per user decision, import must be non-blocking. Status bar shows progress, toast notifications alert on errors (configurable), and a summary dialog appears at batch completion listing duplicates and errors. User can keep working throughout.

Output: StatusBar widget, ToastManager, ImportSummaryDialog, integrated into UIManager render loop.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-import-pipeline/02-CONTEXT.md
@.planning/phases/02-import-pipeline/02-04-SUMMARY.md
@src/managers/ui_manager.h
@src/managers/ui_manager.cpp
@src/core/import/import_task.h
@src/ui/panels/panel.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatusBar widget and ToastManager</name>
  <files>
    src/ui/widgets/status_bar.h
    src/ui/widgets/status_bar.cpp
    src/ui/widgets/toast.h
    src/ui/widgets/toast.cpp
  </files>
  <action>
**StatusBar (status_bar.h/cpp):**

Simple ImGui widget rendered at the bottom of the main window.

```cpp
class StatusBar {
public:
    // Render the status bar. Call each frame from UIManager.
    void render();

    // Set import progress reference (called once when import starts)
    void setImportProgress(const ImportProgress* progress);

    // Clear import progress (called when batch completes)
    void clearImportProgress();

private:
    const ImportProgress* m_progress = nullptr;
};
```

Render implementation:
- Use `ImGui::BeginChild("StatusBar", ImVec2(-1, 24), true)` or similar fixed-height area at bottom
- When m_progress is set and active:
  - Show progress bar: `ImGui::ProgressBar(pct / 100.0f, ImVec2(200, 16))`
  - Show text: "Importing N/M files... [current_file_name] [stage_name]"
  - Show cancel button: small "X" button that sets a cancel flag
- When no import active:
  - Show general status text (e.g., model count from library, or just empty)

**Important:** StatusBar is NOT a Panel subclass. It's a standalone widget rendered by UIManager in the main dockspace area. Place it below the dockspace but above any bottom-docked panels. Use `ImGui::SetNextWindowPos` and `ImGui::SetNextWindowSize` to anchor it.

Alternative simpler approach: Render in the existing ImGui main menu bar as a right-aligned section, or as an overlay at the bottom using `ImGui::GetIO().DisplaySize`. Choose the approach that integrates cleanest with existing UIManager rendering.

**ToastManager (toast.h/cpp):**

Self-contained ImGui-based toast notification system (per research: ImGui-notify pattern).

```cpp
enum class ToastType { Info, Warning, Error, Success };

struct Toast {
    ToastType type;
    std::string title;
    std::string message;
    float duration;    // seconds
    float elapsed = 0; // seconds since creation
    float opacity = 1.0f;
};

class ToastManager {
public:
    static ToastManager& instance();

    void show(ToastType type, const std::string& title, const std::string& message = "", float duration = 3.0f);

    // Call each frame from UIManager to render active toasts
    void render(float deltaTime);

private:
    std::vector<Toast> m_toasts;
    static constexpr int MAX_VISIBLE = 5;
    static constexpr float FADE_DURATION = 0.5f;
};
```

Render implementation:
- Position toasts in top-right corner, stacked vertically
- Each toast is an `ImGui::SetNextWindowPos` overlay with `ImGuiWindowFlags_NoDecoration | ImGuiWindowFlags_AlwaysAutoResize | ImGuiWindowFlags_NoFocusOnAppearing | ImGuiWindowFlags_NoNav`
- Color based on type (red for error, yellow for warning, green for success, blue for info)
- Fade out in last FADE_DURATION seconds by adjusting window alpha
- Remove toasts that exceed duration
- Limit visible toasts to MAX_VISIBLE (oldest get removed if exceeded)

**Rate limiting for import errors (per research Pitfall 6):**
- Track toast count per batch. After 10 error toasts, stop showing individual toasts and show a single "Multiple errors occurred — see summary" toast instead.
  </action>
  <verify>
Build: `cd /data/DW && cmake --build build --target dw 2>&1 | tail -10` — compiles. Check that toast.cpp and status_bar.cpp are in CMakeLists.
  </verify>
  <done>
StatusBar renders import progress (bar + text + cancel button) when active, nothing when idle. ToastManager shows stacked notifications in top-right with auto-dismiss and fade. Rate limiting prevents toast flood during large batch imports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ImportSummaryDialog and wire into UIManager</name>
  <files>
    src/ui/dialogs/import_summary_dialog.h
    src/ui/dialogs/import_summary_dialog.cpp
    src/managers/ui_manager.h
    src/managers/ui_manager.cpp
  </files>
  <action>
**ImportSummaryDialog (import_summary_dialog.h/cpp):**

```cpp
class ImportSummaryDialog {
public:
    void open(const ImportBatchSummary& summary);
    void render();
    bool isOpen() const { return m_open; }

private:
    bool m_open = false;
    ImportBatchSummary m_summary;
};
```

Render as an ImGui modal popup ("Import Complete"):
- Header: "Import Complete" or "Import Complete (with issues)" based on hasIssues()
- Stats section:
  - "Total files: N"
  - "Successfully imported: N"
  - "Duplicates skipped: N" (only if > 0)
  - "Errors: N" (only if > 0)
- If duplicates > 0: Collapsible section "Skipped Duplicates" listing each name
- If errors > 0: Collapsible section "Errors" listing each (filename, error) pair
- "OK" button to close

**UIManager integration:**

Add to UIManager:
- `StatusBar m_statusBar` member
- `ToastManager&` reference (or just call singleton)
- `ImportSummaryDialog m_importSummary` member
- In `UIManager::render()`, after rendering all panels:
  - Call `m_statusBar.render()`
  - Call `ToastManager::instance().render(deltaTime)` (calculate deltaTime from ImGui::GetIO().DeltaTime)
  - Call `m_importSummary.render()`

Add callback setters:
- `void setOnImportProgress(const ImportProgress* progress)` — passes to m_statusBar
- `void showImportSummary(const ImportBatchSummary& summary)` — opens m_importSummary

**Remove existing modal import overlay:**
Search UIManager and Application for any existing modal progress display during import (the research mentions replacing "current modal overlay"). If found, remove it and replace with the StatusBar approach. If the modal is in Application::update() or Application::render(), remove it there.

**Wiring note for Application (not done in this plan, documented for Plan 06/07):**
- Application sets `m_uiManager.setOnImportProgress(&m_importQueue.progress())` when import starts
- Application's batch complete callback calls `m_uiManager.showImportSummary(summary)`
- Application's per-error callback calls `ToastManager::instance().show(Error, filename, error)` if Config allows

**Per user decision:** After batch completes, viewport focus does NOT change. Do not add any auto-focus behavior in the summary dialog.
  </action>
  <verify>
Build: `cd /data/DW && cmake --build build --target dw 2>&1 | tail -10` — compiles cleanly. Verify UIManager render function calls StatusBar, ToastManager, and ImportSummaryDialog render methods.
  </verify>
  <done>
ImportSummaryDialog shows batch results with duplicate/error listings. StatusBar integrated into UIManager render loop showing progress during imports. ToastManager renders notifications overlay. UIManager has setter methods for Application to wire import progress and summary display. No modal overlay — import is fully non-blocking.
  </done>
</task>

</tasks>

<verification>
1. `cd /data/DW && cmake --build build 2>&1 | grep -i error` — no errors
2. StatusBar renders in UIManager frame cycle
3. ToastManager renders overlay notifications
4. ImportSummaryDialog displays batch summary in modal
5. No modal import overlay exists (replaced by background StatusBar)
6. All existing tests pass
</verification>

<success_criteria>
- Status bar shows import progress (bar, text, cancel) during active import
- Toast notifications appear for import errors (rate-limited to prevent flood)
- Import summary dialog shows at batch completion with duplicate/error details
- Import is fully non-blocking (no modal overlay)
- Viewport focus unchanged after import completes
</success_criteria>

<output>
After completion, create `.planning/phases/02-import-pipeline/02-05-SUMMARY.md`
</output>

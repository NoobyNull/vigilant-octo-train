---
phase: 02-import-pipeline
plan: 08
type: execute
wave: 5
depends_on: ["02-05", "02-06", "02-07"]
files_modified:
  - src/core/loaders/stl_loader.cpp
  - src/core/loaders/obj_loader.cpp
  - src/core/loaders/threemf_loader.cpp
autonomous: false

must_haves:
  truths:
    - "Corrupt or truncated mesh files return descriptive error messages without crashing"
    - "Empty mesh files (zero vertices/triangles) are rejected with a clear error"
    - "Malformed vertex data (NaN, Inf, extreme coordinates) is detected and reported"
    - "Missing MTL references in OBJ files log a warning but loading continues"
    - "Corrupt 3MF archives are caught and reported without crash"
  artifacts:
    - path: "src/core/loaders/stl_loader.cpp"
      provides: "Hardened STL loader with truncation, empty, and corrupt data checks"
      contains: "truncated"
    - path: "src/core/loaders/obj_loader.cpp"
      provides: "Hardened OBJ loader with negative index, polygon fan, and MTL fallback handling"
      contains: "error"
    - path: "src/core/loaders/threemf_loader.cpp"
      provides: "Hardened 3MF loader with archive validation and missing file handling"
      contains: "error"
  key_links:
    - from: "src/core/loaders/stl_loader.cpp"
      to: "src/core/import/import_queue.cpp"
      via: "Loaders called by import pipeline workers"
      pattern: "LoaderFactory"
---

<objective>
Harden existing mesh loaders (STL/OBJ/3MF) and verify complete import pipeline end-to-end.

Purpose: Per user decision, improve robustness of existing loaders (error handling, edge cases). This also serves as the integration verification point for the entire Phase 2 pipeline — everything wired together and tested.

Output: Hardened loaders, verified end-to-end import for mesh and G-code.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-import-pipeline/02-CONTEXT.md
@.planning/phases/02-import-pipeline/02-05-SUMMARY.md
@.planning/phases/02-import-pipeline/02-06-SUMMARY.md
@.planning/phases/02-import-pipeline/02-07-SUMMARY.md
@src/core/loaders/stl_loader.cpp
@src/core/loaders/obj_loader.cpp
@src/core/loaders/threemf_loader.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden STL/OBJ/3MF loaders with improved error handling</name>
  <files>
    src/core/loaders/stl_loader.cpp
    src/core/loaders/obj_loader.cpp
    src/core/loaders/threemf_loader.cpp
  </files>
  <action>
Review and improve each loader for robustness. For each loader:

**STL Loader improvements:**
- Validate file size before parsing (minimum size for valid binary STL: 84 bytes header + triangle count)
- Handle truncated binary STL (triangle count claims more data than file contains) — return error: "STL file truncated: expected N triangles but file too short"
- Handle empty STL (0 triangles) — return error: "STL file contains no geometry (0 triangles)"
- Handle ASCII STL with malformed vertex lines — skip bad lines, log warning
- Wrap all float parsing in try/catch for NaN/Inf detection — reject with: "STL contains invalid vertex data (NaN or Inf values)"
- Add bounds check on vertex data: reject vertices with any coordinate > 1e6 with: "STL contains extreme coordinates (>1e6), likely corrupt"
- Return descriptive error messages: "STL file truncated: expected N triangles, got M" not just "parse failed"

**OBJ Loader improvements:**
- Handle OBJ files with no vertex normals (already may be handled — verify and add if missing)
- Handle OBJ faces with >4 vertices (fan triangulate, not just skip)
- Handle OBJ with negative indices (relative to end of list)
- Handle lines with excessive whitespace or mixed line endings (\\r\\n, \\n, \\r)
- Handle missing material files (MTL reference) gracefully — log warning "MTL file not found: [name], continuing without materials", continue without
- Handle empty OBJ (no vertices) — return error: "OBJ file contains no vertices"
- Return descriptive error messages

**3MF Loader improvements:**
- Validate ZIP structure before parsing (3MF is ZIP-based) — return error: "3MF file has invalid archive structure" on corrupt ZIP
- Handle missing mandatory files in 3MF archive (content_types.xml, model.xml) — return error: "3MF archive missing required [filename]"
- Handle 3MF with multiple model parts — combine or take first (document choice)
- Handle corrupt/truncated archives — catch decompression errors with: "3MF archive is corrupt or truncated"
- Handle empty mesh within valid 3MF — return error: "3MF model contains no geometry"
- Return descriptive error messages

**General patterns across all loaders:**
- Every parse path should have a catch-all try/catch returning LoadResult with error string
- No raw pointer arithmetic without bounds checking
- Log warnings for non-fatal issues (e.g., degenerate triangles found and removed)
- Validate output mesh: check vertexCount > 0 && triangleCount > 0 before returning success
  </action>
  <verify>
Build: `cd /data/DW && cmake --build build --target dw 2>&1 | tail -10` — compiles cleanly. Run all tests: `cd /data/DW/build && ctest --output-on-failure 2>&1 | tail -30` — all pass. Specifically run loader-related tests if they exist.
  </verify>
  <done>
All three mesh loaders (STL, OBJ, 3MF) have comprehensive error handling for truncated files, malformed data, edge cases. Descriptive error messages returned for every failure mode. No crashes on corrupt input. Existing valid files continue to load correctly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end import pipeline verification</name>
  <files>n/a</files>
  <action>
Human verification of the complete Phase 2 import pipeline. All automated work is complete from Plans 01-08 Task 1. This checkpoint verifies the integrated system works correctly from a user perspective.

What was built:
- Parallel multi-worker import with configurable thread count (Auto/Fixed/Expert tiers)
- G-code import with toolpath visualization and metadata extraction
- File handling modes (copy/move/leave-in-place) configured in Settings
- Non-blocking import with status bar progress, toast notifications, and summary dialog
- G-code files in library panel alongside mesh models
- Hardened STL/OBJ/3MF loaders
- Database schema v3 with G-code tables and operation group hierarchy
  </action>
  <verify>
1. Build and launch: `cd /data/DW && cmake --build build && ./build/dw`
2. Settings check: Open Settings app (`./build/dw_settings`), verify Import tab shows parallelism tier dropdown, file handling mode radio buttons, editable library path field, toast notification toggle
3. Mesh import (parallel): Drop 3+ STL/OBJ files — status bar shows progress (not modal), user can interact, summary dialog at completion, files appear in library
4. G-code import: Drop a .gcode or .nc file — imports successfully, appears in library G-code tab, clicking shows toolpath in viewport, rapid/cutting moves visually distinct
5. Duplicate handling: Re-import same file — summary shows "duplicate skipped"
6. Error handling: Import corrupt file — toast notification appears, summary lists error, other files continue
7. Properties: Select imported G-code, verify metadata (bounds, distance, time, feed rates, tools)
  </verify>
  <done>
Human has verified: parallel import works, G-code imports and renders toolpath, settings configurable, non-blocking UX, duplicates/errors handled correctly. Phase 2 import pipeline complete.
  </done>
</task>

</tasks>

<verification>
1. All tests pass: `cd /data/DW/build && ctest --output-on-failure`
2. Application compiles and runs without crashes
3. Human verification of complete import pipeline
</verification>

<success_criteria>
- Corrupt mesh files return descriptive errors without crashing
- Empty/truncated files rejected with clear messages
- Missing MTL references handled gracefully
- Parallel import processes multiple files simultaneously
- G-code files import with metadata and render toolpath in viewport
- Non-blocking UX: status bar progress, toasts, summary dialog
- Duplicate detection and error handling work correctly
- Settings app Import tab configures all pipeline options
- Human verification confirms end-to-end functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-import-pipeline/02-08-SUMMARY.md`
</output>

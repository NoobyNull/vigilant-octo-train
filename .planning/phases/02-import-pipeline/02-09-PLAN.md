---
phase: 02-import-pipeline
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - src/managers/file_io_manager.h
  - src/managers/file_io_manager.cpp
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can drag-drop a folder onto the application and all supported files within it (recursively) are imported"
    - "Nested subfolders within a dropped folder are scanned for supported files"
    - "Unsupported files and non-file entries within dropped folders are silently skipped"
    - "Dropping a mix of files and folders works correctly - files import directly, folders are scanned"
  artifacts:
    - path: "src/managers/file_io_manager.cpp"
      provides: "Recursive directory scanning in onFilesDropped"
      contains: "recursive_directory_iterator"
  key_links:
    - from: "src/managers/file_io_manager.cpp"
      to: "LoaderFactory::isSupported"
      via: "Extension check on recursively discovered files"
      pattern: "isSupported"
---

<objective>
Add recursive directory scanning to drag-and-drop file handling so users can drop folders of STL/OBJ/3MF/G-code files and have them all imported.

Purpose: Gap closure for user-reported issue: "I cannot drop a folder of STLs into the app and have it import." Currently onFilesDropped() only processes individual file paths and skips directories entirely.

Output: Updated FileIOManager::onFilesDropped() that detects directory paths and recursively scans them for supported file extensions before enqueuing.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-import-pipeline/02-CONTEXT.md
@src/managers/file_io_manager.h
@src/managers/file_io_manager.cpp
@src/core/loaders/loader_factory.h
@src/core/utils/file_utils.h
@src/core/types.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add recursive directory scanning to onFilesDropped</name>
  <files>src/managers/file_io_manager.cpp, src/managers/file_io_manager.h</files>
  <action>
  Modify FileIOManager::onFilesDropped() in file_io_manager.cpp to handle directories.

  Current code (lines 86-105) iterates `paths`, checks each one's extension via LoaderFactory::isSupported(), and skips anything without a supported extension. Directories have no extension, so they are silently skipped.

  Changes needed:

  1. Add a private helper method to FileIOManager:
     ```
     void collectSupportedFiles(const Path& directory, std::vector<Path>& outPaths);
     ```
     This method uses `std::filesystem::recursive_directory_iterator` (available via the `fs` namespace alias in types.h: `namespace fs = std::filesystem`) to walk the directory tree. For each entry:
     - Skip if not a regular file (`!entry.is_regular_file()`)
     - Get extension via `file::getExtension(entry.path())`
     - If `LoaderFactory::isSupported(ext)` is true, add to `outPaths`
     - Wrap the iterator in try/catch for `std::filesystem::filesystem_error` (permission denied, broken symlinks). On error, log warning and continue.

  2. Modify onFilesDropped() to check each dropped path:
     - If `file::isDirectory(path)` is true, call `collectSupportedFiles(path, importPaths)`
     - Otherwise, do the existing extension check and add if supported
     - The existing guard (`if (!importPaths.empty()) { m_importQueue->enqueue(...) }`) remains unchanged

  3. Add the `collectSupportedFiles` declaration in file_io_manager.h under the private section.

  4. Include `"core/utils/log.h"` if not already included (for log::warning on filesystem errors).

  Do NOT add any new dependencies beyond what's already available (std::filesystem is already in types.h).
  Do NOT change the ImportQueue interface or any other file.
  </action>
  <verify>
  Build the project:
  ```bash
  cd /data/DW && cmake --build build 2>&1 | tail -20
  ```
  Verify clean build with no errors or warnings related to file_io_manager.
  Run existing tests to ensure no regressions:
  ```bash
  cd /data/DW/build && ctest --output-on-failure 2>&1 | tail -20
  ```
  </verify>
  <done>
  - FileIOManager::onFilesDropped() detects directory paths and recursively scans them
  - Supported files found in directories are added to the import queue
  - Permission errors and broken symlinks are handled gracefully (logged, not crashed)
  - Dropping a mix of files and folders works correctly
  - All existing tests pass
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with no errors
2. All existing tests pass
3. Code review: onFilesDropped() has directory detection branch
4. Code review: collectSupportedFiles() uses recursive_directory_iterator with error handling
5. Code review: LoaderFactory::isSupported() is used for extension filtering in both paths
</verification>

<success_criteria>
- Directories dropped onto the app are recursively scanned for supported files (STL, OBJ, 3MF, G-code)
- Individual files dropped alongside directories are still handled correctly
- Filesystem errors (permission denied, broken symlinks) are logged but do not crash
- Clean build, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-import-pipeline/02-09-SUMMARY.md`
</output>

---
phase: 02-import-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/threading/thread_pool.h
  - src/core/threading/thread_pool.cpp
  - src/core/config/config.h
  - src/core/config/config.cpp
  - settings/settings_app.h
  - settings/settings_app.cpp
autonomous: true

must_haves:
  truths:
    - "ThreadPool can execute tasks in parallel across multiple worker threads"
    - "User can configure parallelism tier (Auto/Fixed/Expert) in Settings"
    - "User can configure file handling mode (leave/copy/move) in Settings"
    - "User can toggle toast notifications on/off in Settings"
  artifacts:
    - path: "src/core/threading/thread_pool.h"
      provides: "Generic bounded thread pool with configurable worker count"
      contains: "class ThreadPool"
    - path: "src/core/threading/thread_pool.cpp"
      provides: "Thread pool implementation with worker loop, task queue, shutdown"
      contains: "ThreadPool::workerLoop"
    - path: "src/core/config/config.h"
      provides: "New config fields for parallelism tier, file handling mode, library path, toast toggle"
      contains: "ParallelismTier"
    - path: "settings/settings_app.cpp"
      provides: "Settings UI for new import-related configuration"
      contains: "renderImportTab"
  key_links:
    - from: "src/core/threading/thread_pool.h"
      to: "src/core/threading/main_thread_queue.h"
      via: "Same threading directory, compatible patterns"
      pattern: "std::condition_variable"
    - from: "src/core/config/config.h"
      to: "settings/settings_app.cpp"
      via: "Settings reads/writes Config singleton"
      pattern: "Config::instance"
---

<objective>
Create the ThreadPool infrastructure and extend Config/Settings with import pipeline configuration options.

Purpose: The thread pool is the foundation for parallel import processing. Config extensions let users control parallelism tier, file handling mode, and notification preferences. These must exist before the ImportQueue overhaul.

Output: ThreadPool class ready for use by ImportQueue, Config with new import settings, Settings app with Import tab.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-import-pipeline/02-CONTEXT.md
@.planning/phases/02-import-pipeline/02-RESEARCH.md
@src/core/threading/main_thread_queue.h
@src/core/config/config.h
@src/core/config/config.cpp
@settings/settings_app.h
@settings/settings_app.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ThreadPool with configurable worker count</name>
  <files>
    src/core/threading/thread_pool.h
    src/core/threading/thread_pool.cpp
  </files>
  <action>
Create a generic bounded thread pool in `src/core/threading/thread_pool.h` and `.cpp`.

**Header (thread_pool.h):**
- Class `ThreadPool` in namespace `dw`
- Constructor: `ThreadPool(size_t numThreads)` — creates worker threads
- `void enqueue(std::function<void()> task)` — add task to queue, notify one worker
- `void shutdown()` — signal workers to stop, join all threads
- `bool isIdle() const` — true when no pending tasks and no active workers
- `size_t pendingCount() const` — number of queued tasks
- `size_t activeCount() const` — number of currently executing tasks
- Destructor calls `shutdown()`

**Also add helper:**
- Enum `ParallelismTier { Auto, Fixed, Expert }` in this header or a separate types header
- Free function `size_t calculateThreadCount(ParallelismTier tier)` that:
  - Calls `std::thread::hardware_concurrency()` with fallback to 4 if returns 0
  - Auto: `max(1, cores * 0.6)`
  - Fixed: `max(1, cores * 0.9)`
  - Expert: `max(1, cores)`
  - Clamp result to range [1, 64]

**Implementation (thread_pool.cpp):**
- Workers loop: wait on condition variable, dequeue task, execute outside lock
- Use `std::mutex` + `std::condition_variable` (same pattern as MainThreadQueue)
- Track active workers with `std::atomic<size_t> m_activeCount`
- Drain queue on shutdown (execute remaining tasks, do not discard)
- Use `m_shutdown` atomic flag to signal stop

**Important:** Lazy initialization pattern — ThreadPool is NOT created at app startup. It will be created on first import enqueue and destroyed on app shutdown. The constructor should create threads immediately when called.
  </action>
  <verify>
Build the project: `cd /data/DW && cmake --build build --target dw 2>&1 | tail -20` — should compile with no errors related to thread_pool files. Verify the header is properly included by checking for linker symbols.
  </verify>
  <done>
ThreadPool class compiles, creates N worker threads, executes enqueued tasks in parallel, and shuts down cleanly joining all threads. ParallelismTier enum and calculateThreadCount function produce correct thread counts for all three tiers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend Config and Settings app with import pipeline settings</name>
  <files>
    src/core/config/config.h
    src/core/config/config.cpp
    settings/settings_app.h
    settings/settings_app.cpp
  </files>
  <action>
**Config extensions (config.h):**
Add new members and accessors to the Config class:

1. `ParallelismTier m_parallelismTier = ParallelismTier::Auto` — include the thread_pool.h header or forward-declare the enum
2. `int m_fileHandlingMode = 0` — 0=LeaveInPlace, 1=CopyToLibrary, 2=MoveToLibrary (use int for serialization simplicity, or add an enum `FileHandlingMode`)
3. `Path m_libraryDir` — managed library directory path (default: empty, meaning app data dir / "library")
4. `bool m_showImportErrorToasts = true` — toast notification toggle

Add getter/setter pairs:
- `ParallelismTier getParallelismTier() / setParallelismTier()`
- `int getFileHandlingMode() / setFileHandlingMode(int)`
- `Path getLibraryDir() / setLibraryDir(const Path&)`
- `bool getShowImportErrorToasts() / setShowImportErrorToasts(bool)`

**Config serialization (config.cpp):**
Add load/save for the new fields in the existing INI format:
- Section `[import]`
- Keys: `parallelism_tier`, `file_handling_mode`, `library_dir`, `show_error_toasts`
- Use existing patterns from the file for reading/writing INI values

**Settings app (settings_app.h/cpp):**
Add a new `renderImportTab()` method and call it from the main render function where other tabs are rendered.

The Import tab should contain:
1. **Parallelism** section:
   - Combo box with "Auto (60% cores)", "Performance (90% cores)", "Expert (100% cores)"
   - Display actual thread count below: "Will use N threads on this machine"
2. **File Handling** section:
   - Radio buttons: "Leave in place (default)", "Copy to library", "Move to library"
   - When copy or move is selected, show the library directory path in an editable `ImGui::InputText` field (pre-populated with the default library directory if not yet configured)
   - Add a "Validate" or inline validation: check that the entered path exists or can be created, show a green checkmark or red warning icon next to the input. Use `std::filesystem::exists()` and `std::filesystem::create_directories()` to validate.
   - **Note:** A full "Browse" folder dialog is NOT implemented in this phase (would require platform-specific or NFD library). The text input with validation is sufficient. The path field is editable, not read-only.
3. **Notifications** section:
   - Checkbox: "Show toast notifications for import errors"

Add cached settings members to SettingsApp for the new fields (same pattern as existing cached fields like m_themeIndex). Wire into applySettings() to save to Config.

**Important:** The settings app is a separate executable that shares Config. Follow existing patterns exactly — cached members, load from Config in constructor or init, apply to Config on save.
  </action>
  <verify>
1. Build both targets: `cd /data/DW && cmake --build build --target dw 2>&1 | tail -5` and `cmake --build build --target dw_settings 2>&1 | tail -5` — both compile cleanly.
2. Run settings app briefly to verify it doesn't crash on startup (the new tab should appear).
  </verify>
  <done>
Config has parallelism tier, file handling mode, library directory, and toast toggle fields that persist to INI file. Settings app shows Import tab with combo, radio buttons, editable library path text input with validation, and checkbox for all settings. Library path is editable via text input (not read-only). Both main app and settings app compile without errors.
  </done>
</task>

</tasks>

<verification>
1. `cd /data/DW && cmake --build build 2>&1 | grep -i error` — no compilation errors
2. ThreadPool header is includable from other translation units
3. Config new fields have default values matching user decisions (Auto tier, leave-in-place, toasts on)
4. Settings app renders Import tab without crashes
5. Library directory path is editable in Settings when copy/move mode selected
</verification>

<success_criteria>
- ThreadPool class exists and compiles with enqueue/shutdown/isIdle API
- ParallelismTier enum with calculateThreadCount produces correct counts
- Config has 4 new import settings with INI persistence
- Settings app has Import tab with parallelism, file handling, and notification controls
- Library directory path is user-editable via text input with validation feedback
- Both dw and dw_settings targets compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-import-pipeline/02-01-SUMMARY.md`
</output>

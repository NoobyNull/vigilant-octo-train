---
phase: 02-import-pipeline
plan: 10
type: execute
wave: 2
depends_on: [02-09]
files_modified:
  - src/managers/file_io_manager.cpp
  - src/managers/file_io_manager.h
  - src/core/library/library_manager.cpp
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Importing large meshes does not block the UI - user can continue interacting while imports complete"
    - "Only one completed import is processed per frame to spread GL work across frames"
    - "Viewport focus does not change when imports complete (per user decision)"
    - "Thumbnail generation failures are reported to the user via toast notification"
    - "Failed thumbnails are retried once before reporting failure"
    - "Null thumbnail generator returns false (not true) indicating failure"
  artifacts:
    - path: "src/managers/file_io_manager.cpp"
      provides: "Throttled per-frame import completion processing"
      contains: "pollCompleted"
    - path: "src/core/library/library_manager.cpp"
      provides: "Correct null generator return value and retry logic"
      contains: "generateThumbnail"
  key_links:
    - from: "src/managers/file_io_manager.cpp"
      to: "src/core/library/library_manager.cpp"
      via: "generateThumbnail return value checked and acted upon"
      pattern: "generateThumbnail.*false"
    - from: "src/managers/file_io_manager.cpp"
      to: "ToastManager"
      via: "Toast shown on thumbnail failure"
      pattern: "ToastManager.*Error.*thumbnail"
---

<objective>
Fix blocking import completion and silent thumbnail failures so that the import pipeline is truly non-blocking and users are informed when thumbnails fail to generate.

Purpose: Gap closure for two related user-reported issues:
1. "Models are loading into the main view, not allowing the user to continue, so it is blocking" -- processCompletedImports() runs synchronously on the main thread doing GPU uploads and thumbnail generation for ALL completed tasks in a single frame.
2. "Some thumbnails did not generate" -- generateThumbnail() return value is ignored, null generator returns true (masking failure), and there is no user notification on failure.

Output: Throttled import completion (1 per frame), removed viewport auto-focus, fixed thumbnail error propagation with retry and toast notification.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-import-pipeline/02-CONTEXT.md
@.planning/phases/02-import-pipeline/02-05-SUMMARY.md
@.planning/phases/02-import-pipeline/02-06-SUMMARY.md
@src/managers/file_io_manager.h
@src/managers/file_io_manager.cpp
@src/core/library/library_manager.cpp
@src/render/thumbnail_generator.h
@src/ui/widgets/toast.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Throttle processCompletedImports to one per frame and remove viewport auto-focus</name>
  <files>src/managers/file_io_manager.cpp, src/managers/file_io_manager.h</files>
  <action>
  Modify FileIOManager::processCompletedImports() to process at most ONE completed import per frame, and remove the viewport auto-focus behavior.

  Current code (lines 107-141) calls `m_importQueue->pollCompleted()` which returns ALL completed tasks, then iterates through every one of them doing thumbnail generation and GPU mesh upload synchronously. For large meshes or many completions, this blocks the main thread.

  Changes needed:

  1. **Add a pending completions queue to FileIOManager** (in file_io_manager.h):
     ```cpp
     std::vector<ImportTask> m_pendingCompletions;
     ```
     Add `#include "core/import/import_task.h"` to the header (ImportTask is currently only forward-declared via ImportQueue).

  2. **Restructure processCompletedImports()** (in file_io_manager.cpp):
     - At the start, poll for newly completed tasks and APPEND them to `m_pendingCompletions`:
       ```cpp
       auto newlyCompleted = m_importQueue->pollCompleted();
       if (!newlyCompleted.empty()) {
           setShowStartPage(false);
           m_pendingCompletions.insert(m_pendingCompletions.end(),
               std::make_move_iterator(newlyCompleted.begin()),
               std::make_move_iterator(newlyCompleted.end()));
       }
       ```
     - Then process AT MOST ONE task from `m_pendingCompletions`:
       ```cpp
       if (m_pendingCompletions.empty()) return;

       auto task = std::move(m_pendingCompletions.front());
       m_pendingCompletions.erase(m_pendingCompletions.begin());
       ```
     - For the single task:
       - Generate thumbnail (keep existing logic with the fix from Task 2)
       - Refresh library panel
       - Set mesh on workspace (for properties display)
       - **REMOVE** the viewport->setMesh() call entirely. Per user decision: "After batch completes, viewport focus does not change." The workspace tracks the mesh for properties, but the viewport should NOT be forced to display each imported mesh.
       - Keep properties->setMesh() for metadata display since it's lightweight

  3. **Remove viewport auto-focus**: Delete the block:
     ```cpp
     if (viewport) {
         viewport->setMesh(task.mesh);
     }
     ```
     The ViewportPanel pointer parameter can remain in the method signature for now (removing it would change the Application call site), but it is no longer used. Add a comment: `// viewport param kept for API compatibility; focus does not change on import (user decision)`

  Do NOT change the ImportQueue interface.
  Do NOT change any other files besides file_io_manager.h and file_io_manager.cpp.
  </action>
  <verify>
  Build the project:
  ```bash
  cd /data/DW && cmake --build build 2>&1 | tail -20
  ```
  Verify clean build. Run tests:
  ```bash
  cd /data/DW/build && ctest --output-on-failure 2>&1 | tail -20
  ```
  </verify>
  <done>
  - processCompletedImports() processes at most 1 completed import per frame
  - Remaining completions are queued and processed in subsequent frames
  - Viewport focus does not change when imports complete
  - Properties panel still receives mesh for metadata display
  - Library panel still refreshes on each processed completion
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix thumbnail generation error propagation, retry, and notification</name>
  <files>src/core/library/library_manager.cpp, src/managers/file_io_manager.cpp</files>
  <action>
  Fix three thumbnail generation issues: null generator false positive, ignored return value, and missing user notification.

  **Fix 1: Null generator return value (library_manager.cpp)**

  At library_manager.cpp line 173-176, the null generator check returns `true`:
  ```cpp
  if (!m_thumbnailGen) {
      return true; // No generator set - skip silently
  }
  ```
  Change this to return `false` with a descriptive log:
  ```cpp
  if (!m_thumbnailGen) {
      log::warning("Library", "Thumbnail generation skipped - no generator available");
      return false;
  }
  ```
  This correctly signals to callers that the thumbnail was NOT generated.

  **Fix 2: Check return value and retry (file_io_manager.cpp)**

  In processCompletedImports(), the call to generateThumbnail at the point where the single task is processed currently ignores the return value:
  ```cpp
  m_libraryManager->generateThumbnail(task.modelId, *task.mesh);
  ```

  Replace with retry logic:
  ```cpp
  bool thumbnailOk = m_libraryManager->generateThumbnail(task.modelId, *task.mesh);
  if (!thumbnailOk) {
      // Retry once - framebuffer creation can fail transiently
      thumbnailOk = m_libraryManager->generateThumbnail(task.modelId, *task.mesh);
  }
  ```

  **Fix 3: Toast notification on failure (file_io_manager.cpp)**

  After the retry, if still failed, show a toast:
  ```cpp
  if (!thumbnailOk) {
      ToastManager::instance().show(
          ToastType::Warning,
          "Thumbnail Failed",
          "Could not generate thumbnail for: " + task.record.name
      );
  }
  ```

  Add `#include "ui/widgets/toast.h"` to file_io_manager.cpp if not already present.

  Do NOT change the ThumbnailGenerator class itself.
  Do NOT add complex retry mechanisms (one retry is sufficient for transient GL failures).
  </action>
  <verify>
  Build the project:
  ```bash
  cd /data/DW && cmake --build build 2>&1 | tail -20
  ```
  Verify clean build. Run tests:
  ```bash
  cd /data/DW/build && ctest --output-on-failure 2>&1 | tail -20
  ```
  Verify the null generator fix:
  ```bash
  grep -n "return false" /data/DW/src/core/library/library_manager.cpp | head -5
  ```
  Verify the return value is checked:
  ```bash
  grep -n "thumbnailOk" /data/DW/src/managers/file_io_manager.cpp
  ```
  Verify toast notification is present:
  ```bash
  grep -n "Thumbnail Failed" /data/DW/src/managers/file_io_manager.cpp
  ```
  </verify>
  <done>
  - Null thumbnail generator returns false (not true), correctly signaling failure
  - generateThumbnail() return value is checked in processCompletedImports()
  - Failed thumbnail generation is retried once before reporting
  - User sees a warning toast when a thumbnail fails to generate
  - Toast includes the model name for identification
  - All existing tests pass
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with no errors
2. All existing tests pass
3. Code review: processCompletedImports() processes at most 1 task per frame via m_pendingCompletions queue
4. Code review: No viewport->setMesh() call in processCompletedImports()
5. Code review: library_manager.cpp null generator check returns false
6. Code review: generateThumbnail return value checked with retry
7. Code review: ToastManager notification on thumbnail failure
</verification>

<success_criteria>
- Large mesh imports do not block the UI (one completion per frame)
- Viewport focus stays unchanged during imports (user decision honored)
- Thumbnail failures produce a user-visible toast notification
- Null thumbnail generator correctly reports failure
- Failed thumbnails get one retry attempt
- Clean build, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-import-pipeline/02-10-SUMMARY.md`
</output>

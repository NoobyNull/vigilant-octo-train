# Plan 19-02: Job Control, Progress Reporting, and G-code File Export

**Phase**: 19 — Streaming Integration
**Requirements**: DC-27, DC-28, DC-30

## Overview

Wire the CarveStreamer into the G-code panel for progress display, implement pause/resume/abort with safety guarantees matching G-code streaming, and add the option to save the generated toolpath as a .nc file.

## Modifications

### `src/ui/panels/gcode_panel.h` — Add Direct Carve streaming state

```cpp
// Direct Carve streaming
void onCarveStreamStart(carve::CarveStreamer* streamer);
void onCarveStreamComplete();

private:
    carve::CarveStreamer* m_carveStreamer = nullptr;
    bool m_carveStreamActive = false;
```

### `src/ui/panels/gcode_panel.cpp` — Progress display for Direct Carve

In the existing progress bar / job status rendering section, add a branch for carve streaming:

**renderCarveProgress()** (~35 lines, new private method):
1. Check `m_carveStreamActive && m_carveStreamer`
2. Progress bar: `m_carveStreamer->progressFraction()`
3. Line counter: "Line {current} / {total}"
4. Time: elapsed from stream start, estimated remaining from progress fraction
5. Current pass indicator: "Clearing" or "Finishing"
6. Control buttons (same layout as G-code job controls):
   - Pause/Resume: delegates to `m_carveStreamer->pause()` / `resume()`
   - Abort: long-press button → `m_carveStreamer->abort()`
   - Uses same safety patterns (long-press for destructive actions)

### `src/ui/panels/direct_carve_panel.cpp` — Connect to G-code panel

In renderRunning(), after starting the stream:
- Get GcodePanel pointer from UIManager
- Call `gcodePanel->onCarveStreamStart(m_carveJob->streamer())`
- On completion/abort: `gcodePanel->onCarveStreamComplete()`

### `src/app/application_wiring.cpp` — Wire Direct Carve panel

Add DirectCarvePanel to the wiring:
```cpp
auto* dcp = m_uiManager->directCarvePanel();
if (dcp) {
    dcp->setCncController(m_cncController.get());
    dcp->setToolDatabase(m_toolDatabase.get());
}
```

Add to onConnectionChanged and onStatusUpdate fan-out lambdas.

### Safety guarantees (matching G-code streaming)

**Pause**:
- Send GRBL feed hold (`!` character)
- CarveStreamer stops providing new lines
- Spindle continues at current speed (GRBL behavior)
- UI shows "Paused" state with resume button

**Resume**:
- Send GRBL cycle start (`~` character)
- CarveStreamer resumes providing lines
- Controller character-counting continues from where it left off

**Abort**:
- Send feed hold, wait for acknowledgment
- Send soft reset (`\x18`)
- CarveStreamer marks as aborted
- UI shows retract warning: "Tool may be in workpiece — jog Z up before moving XY"

### G-code file export

The `exportGcode()` function from Plan 18-03 handles file writing. Add an export button to the Direct Carve panel commit step and to the completion screen:

In `renderCommit()`:
- "Save as G-code" button opens FileDialog
- Calls `carve::exportGcode(path, toolpath, config, modelName, toolName)`
- Shows success/error notification

In `renderRunning()` after completion:
- "Save G-code" button for post-run export
- Same flow as above

### Tests

`src/core/carve/carve_integration_test.cpp` (~100 lines):

- `TEST(CarveIntegration, FullPipeline)` — heightmap → analysis → recommendation → toolpath → streaming
  - Use a simple test mesh (flat plane with one pit)
  - Verify each stage produces valid output
  - Verify streamer produces valid G-code lines
  - Verify line count matches expectation

- `TEST(CarveIntegration, PauseResumeConsistency)` — pause/resume doesn't skip or duplicate lines
- `TEST(CarveIntegration, AbortCleansUp)` — abort stops stream and reports final position

## Coding Standards Compliance

- renderCarveProgress ~35 lines (within 50)
- Safety behavior matches existing G-code streaming patterns
- No new threading (CarveStreamer is polled by CncController IO thread)
- Export function is pure I/O (tested in 18-03)
- Abort safety warning prevents common "tool buried" mistake

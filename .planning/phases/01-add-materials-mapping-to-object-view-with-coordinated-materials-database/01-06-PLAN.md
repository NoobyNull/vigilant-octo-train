---
phase: 01-add-materials-mapping-to-object-view-with-coordinated-materials-database
plan: 06
type: execute
wave: 4
depends_on: ["01-03", "01-04", "01-05"]
files_modified:
  - src/ui/panels/properties_panel.h
  - src/ui/panels/properties_panel.cpp
  - src/app/application.h
  - src/app/application.cpp
  - src/managers/ui_manager.h
  - src/managers/ui_manager.cpp
autonomous: false

must_haves:
  truths:
    - "User can assign a wood species from MaterialsPanel to the currently loaded model"
    - "Assigned material texture is displayed on the 3D object in the viewport"
    - "Material replaces the color selector in PropertiesPanel as the primary surface appearance"
    - "Objects with no material assigned show no material info (blank/hidden)"
    - "Material assignment persists across app restarts (stored in database)"
    - "MaterialsPanel is accessible from the View menu and dockable"
    - "Default materials are seeded on first launch"
    - "Grain direction slider rotates texture on the 3D object"
  artifacts:
    - path: "src/ui/panels/properties_panel.h"
      provides: "Material display section replacing color picker"
    - path: "src/app/application.cpp"
      provides: "MaterialManager creation, MaterialsPanel wiring, texture binding on render"
    - path: "src/managers/ui_manager.h"
      provides: "MaterialsPanel ownership and visibility management"
  key_links:
    - from: "src/app/application.cpp"
      to: "src/core/materials/material_manager.h"
      via: "Application creates and owns MaterialManager, seeds defaults on init"
      pattern: "MaterialManager"
    - from: "src/app/application.cpp"
      to: "src/ui/panels/materials_panel.h"
      via: "MaterialsPanel wired with onMaterialAssigned callback"
      pattern: "onMaterialAssigned"
    - from: "src/app/application.cpp"
      to: "src/render/renderer.h"
      via: "renderMesh called with material Texture when material assigned"
      pattern: "renderMesh.*texture"
    - from: "src/ui/panels/properties_panel.cpp"
      to: "src/core/materials/material.h"
      via: "Displays MaterialRecord properties instead of color picker"
      pattern: "MaterialRecord"
---

<objective>
Wire the complete materials system end-to-end: integrate MaterialManager into Application, connect MaterialsPanel callbacks, replace PropertiesPanel color picker with material display, bind textures during rendering, and add human verification checkpoint.

Purpose: Complete the materials system integration so a user can browse materials, assign them to objects, and see wood grain textures rendered in the viewport.
Output: Fully functional materials system with end-to-end workflow.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-RESEARCH.md
@.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-01-SUMMARY.md
@.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-02-SUMMARY.md
@.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-03-SUMMARY.md
@.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-04-SUMMARY.md
@.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-05-SUMMARY.md

# Key files to modify
@src/app/application.h
@src/app/application.cpp
@src/managers/ui_manager.h
@src/managers/ui_manager.cpp
@src/ui/panels/properties_panel.h
@src/ui/panels/properties_panel.cpp
@src/ui/panels/viewport_panel.h
@src/ui/panels/viewport_panel.cpp
@src/core/materials/material_manager.h
@src/ui/panels/materials_panel.h
@src/render/renderer.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire MaterialManager and MaterialsPanel into Application</name>
  <files>
    src/app/application.h
    src/app/application.cpp
    src/managers/ui_manager.h
    src/managers/ui_manager.cpp
  </files>
  <action>
    1. Add to Application (application.h):
       - #include for MaterialManager (forward-declare in header, include in .cpp)
       - std::unique_ptr<MaterialManager> m_materialManager member
       - std::unique_ptr<Texture> m_activeMaterialTexture member (cached GPU texture for current material)
       - i64 m_activeMaterialId = -1 member (tracks currently assigned material for loaded model)

    2. In Application::init() (application.cpp):
       - Create MaterialManager after Database is initialized: m_materialManager = make_unique<MaterialManager>(*m_database)
       - Call m_materialManager->seedDefaults() to populate default species on first run
       - The ordering: EventBus -> Database -> MaterialManager -> LibraryManager -> Panels

    3. Add MaterialsPanel to UIManager:
       - Add MaterialsPanel member and accessor to ui_manager.h
       - Create MaterialsPanel in UIManager init, passing MaterialManager pointer
       - Add to View menu toggle: "Materials" panel visibility
       - Render MaterialsPanel in UIManager::render() alongside other panels

    4. Wire MaterialsPanel callbacks in Application::init():
       - onMaterialSelected: update PropertiesPanel to show material info (optional preview)
       - onMaterialAssigned: assign material to current model:
         a. Call m_materialManager->assignMaterialToModel(materialId, currentModelId)
         b. Load material's texture from .dwmat archive:
            - Get MaterialRecord from materialManager
            - If archivePath exists, use MaterialArchive::load() to get texture data
            - Use TextureLoader::loadPNGFromMemory() to decode
            - Upload to m_activeMaterialTexture via Texture::upload()
         c. If mesh needs UV generation, call mesh->generatePlanarUVs(material.grainDirectionDeg)
            Then re-upload mesh to GPU (Renderer::uploadMesh)
         d. Store m_activeMaterialId = materialId
         e. Trigger viewport redraw

    5. In Application's render loop (where ViewportPanel renders the mesh):
       - When rendering the focused mesh, pass m_activeMaterialTexture.get() to Renderer::renderMesh()
       - If m_activeMaterialTexture is null or invalid, pass nullptr (solid color fallback)

    6. On model selection change (onModelSelected):
       - Check if selected model has a material assigned: m_materialManager->getModelMaterial(modelId)
       - If yes, load that material's texture (same flow as onMaterialAssigned step b-d)
       - If no, clear m_activeMaterialTexture and m_activeMaterialId

    7. Handle grain direction changes:
       - When user changes grain direction in MaterialsPanel or PropertiesPanel:
         - Regenerate UVs: mesh->generatePlanarUVs(newGrainDeg)
         - Re-upload mesh to GPU
         - Update material record in database
  </action>
  <verify>
    cd build && cmake --build . --target digital_workshop 2>&1 | tail -5
    Compiles. Application starts, MaterialsPanel appears in View menu.
  </verify>
  <done>
    MaterialManager created in Application init, defaults seeded. MaterialsPanel wired with callbacks for selection and assignment. Texture loaded and bound during rendering. Material assignment persists in database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace PropertiesPanel color picker with material display</name>
  <files>
    src/ui/panels/properties_panel.h
    src/ui/panels/properties_panel.cpp
  </files>
  <action>
    1. Update PropertiesPanel (properties_panel.h):
       - Add setMaterial(const MaterialRecord& material) method
       - Add clearMaterial() method
       - Add MaterialAssignedCallback and grain direction change callback
       - Add m_material (std::optional<MaterialRecord>) member
       - Keep m_objectColor as fallback for no-material state

    2. Modify renderMaterialInfo() in properties_panel.cpp:
       - Per user decision: "Material replaces the existing color selector as an overlay image on the object"
       - Per user decision: "Objects with no material assigned: blank/hidden (no material info shown)"

       If m_material has value (material assigned):
       - Display material name as header
       - Show category badge (Hardwood/Softwood/Domestic/Composite)
       - Show read-only info section:
         - Janka Hardness: formatted as "1,290 lbf"
         - Feed Rate: formatted as "80 in/min"
         - Spindle Speed: formatted as "18,000 RPM"
         - Depth of Cut: formatted as "0.125 in"
         - Cost: formatted as "$4.50/bf"
       - Grain Direction: ImGui::SliderFloat 0-360 degrees (editable, fires callback to update texture rotation)
       - "Change Material" button (opens MaterialsPanel or scrolls to it)
       - "Remove Material" button (clears assignment, reverts to solid color)

       If m_material is nullopt (no material):
       - Show nothing in the material section (blank/hidden per user decision)
       - Keep the existing color picker as fallback for unassigned objects
       - Note: color picker is still functional but secondary to material — shown only when no material is assigned

    3. Add callback: setOnGrainDirectionChanged(std::function<void(float degrees)>)
       - Fires when user adjusts the grain direction slider
       - Application handles re-generating UVs and re-uploading mesh

    4. Add callback: setOnMaterialRemoved(std::function<void()>)
       - Fires when user clicks "Remove Material"
       - Application clears material assignment from model
  </action>
  <verify>
    cd build && cmake --build . --target digital_workshop 2>&1 | tail -5
    Compiles. PropertiesPanel shows material info when assigned, hides section when not.
  </verify>
  <done>
    PropertiesPanel displays material properties when assigned (Janka, feed/speed, cost, grain slider). Shows blank when no material. Color picker shown only as fallback for unassigned objects. Grain direction slider fires callback for UV regeneration.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete materials workflow</name>
  <files>n/a (verification only)</files>
  <action>
    Human verification of the complete materials system. What was built:
    Complete materials system — MaterialsPanel with 32 default materials (wood species, metals, plastics, foams), material assignment to 3D objects with texture mapping, grain direction control, material property display in PropertiesPanel, .dwmat import/export.

    Steps to verify:
    1. Launch the application: `./build/digital_workshop`
    2. Open the Materials panel from the View menu — verify 32 default materials appear with category tabs
    3. Switch between category tabs (All/Hardwood/Softwood/Domestic/Composite) — verify filtering works
    4. Import a 3D model (STL file) into the library and load it into the viewport
    5. Double-click a material (e.g., "Red Oak") in the Materials panel — verify it assigns to the model
    6. Check the viewport — the model should display with texture (or solid color if no texture image in the default material)
    7. Check PropertiesPanel — material info should appear (Janka: 1,290 lbf, Feed: 80 in/min, etc.)
    8. Adjust the grain direction slider in PropertiesPanel — the texture orientation should change on the 3D model
    9. Click "Remove Material" in PropertiesPanel — model reverts to solid color, material info disappears
    10. Try importing a .dwmat file (if available) — material should appear in the panel
    11. Close and reopen the app — material assignment should persist for the model
  </action>
  <verify>User types "approved" or describes issues to fix</verify>
  <done>User confirms materials workflow is visually correct and functionally complete</done>
</task>

</tasks>

<verification>
1. `cmake --build build --target digital_workshop` compiles without errors
2. Application starts with MaterialsPanel in View menu
3. 32 default materials visible in MaterialsPanel
4. Material assignment flow: MaterialsPanel double-click -> texture on object -> info in PropertiesPanel
5. Grain direction slider rotates texture on object
6. Material assignment persists in database (survives app restart)
7. "Remove Material" reverts to solid color
8. PropertiesPanel material section hidden when no material assigned
</verification>

<success_criteria>
- End-to-end: Browse materials -> Assign to object -> See texture in viewport -> Edit grain direction -> Persists on restart
- MaterialsPanel accessible from View menu, dockable
- PropertiesPanel shows material info (replaces color picker when material assigned)
- Default species seeded on first launch
- All 422+ existing tests still pass (no regressions)
- Human verification confirms visual correctness
</success_criteria>

<output>
After completion, create `.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-06-SUMMARY.md`
</output>

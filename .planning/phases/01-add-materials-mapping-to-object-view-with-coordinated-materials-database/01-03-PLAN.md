---
phase: 01-add-materials-mapping-to-object-view-with-coordinated-materials-database
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/core/materials/default_materials.h
  - src/core/materials/default_materials.cpp
  - src/core/materials/material_manager.h
  - src/core/materials/material_manager.cpp
  - src/core/paths/app_paths.h
  - src/core/paths/app_paths.cpp
  - src/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "App ships with 20-30 built-in default wood species covering hardwoods, softwoods, and composites"
    - "Default materials are seeded into the database on first run"
    - "Materials can be imported from .dwmat files and copied to app-managed directory"
    - "Materials can be exported as .dwmat files for sharing between users/machines"
    - "Imported .dwmat files are copied to app data directory to prevent path invalidation"
  artifacts:
    - path: "src/core/materials/default_materials.h"
      provides: "getDefaultMaterials() returning vector of MaterialRecord"
    - path: "src/core/materials/material_manager.h"
      provides: "MaterialManager coordinating import/export/seeding workflows"
    - path: "src/core/materials/material_manager.cpp"
      provides: "Import pipeline: copy .dwmat to app dir, extract metadata, insert to DB"
  key_links:
    - from: "src/core/materials/material_manager.cpp"
      to: "src/core/database/material_repository.h"
      via: "Database operations for material records"
      pattern: "MaterialRepository"
    - from: "src/core/materials/material_manager.cpp"
      to: "src/core/paths/app_paths.h"
      via: "getMaterialsDir() for managed storage location"
      pattern: "getMaterialsDir"
---

<objective>
Create the default materials species list, material manager for import/export workflows, and app-managed materials directory.

Purpose: Provide the built-in wood species database and the import/export pipeline so users can browse materials immediately and share .dwmat archives.
Output: DefaultMaterials data, MaterialManager with import/export/seed, materials directory in app paths.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-RESEARCH.md
@.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-01-SUMMARY.md

# Key files
@src/core/materials/material.h
@src/core/database/material_repository.h
@src/core/paths/app_paths.h
@src/core/paths/app_paths.cpp
@src/core/library/library_manager.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create default materials list and app materials directory</name>
  <files>
    src/core/materials/default_materials.h
    src/core/materials/default_materials.cpp
    src/core/paths/app_paths.h
    src/core/paths/app_paths.cpp
    src/CMakeLists.txt
  </files>
  <action>
    1. Add getMaterialsDir() to app_paths.h/cpp:
       - Returns getDataDir() / "materials"
       - Add to ensureDirectoriesExist() call list

    2. Create default_materials.h/cpp with getDefaultMaterials() -> std::vector of MaterialRecord:
       Ship ~25 species with real Janka ratings (from Wood Database) and conservative CNC defaults:

       **Hardwoods (11):**
       - Red Oak: Janka 1290, feed 80, spindle 18000, doc 0.125, $4.50/bf
       - White Oak: Janka 1360, feed 75, spindle 18000, doc 0.100, $5.00/bf
       - Hard Maple: Janka 1450, feed 70, spindle 18000, doc 0.100, $5.50/bf
       - Soft Maple: Janka 950, feed 90, spindle 18000, doc 0.150, $3.50/bf
       - Cherry: Janka 995, feed 85, spindle 18000, doc 0.125, $6.00/bf
       - Black Walnut: Janka 1010, feed 85, spindle 18000, doc 0.125, $8.00/bf
       - White Ash: Janka 1320, feed 75, spindle 18000, doc 0.100, $4.00/bf
       - Yellow Birch: Janka 1260, feed 80, spindle 18000, doc 0.125, $4.50/bf
       - Hickory: Janka 1820, feed 60, spindle 18000, doc 0.075, $5.00/bf
       - Poplar: Janka 540, feed 120, spindle 16000, doc 0.200, $2.50/bf
       - Mahogany: Janka 800, feed 90, spindle 18000, doc 0.150, $7.00/bf

       **Softwoods (7):**
       - White Pine: Janka 380, feed 150, spindle 16000, doc 0.250, $2.00/bf
       - Yellow Pine: Janka 870, feed 100, spindle 18000, doc 0.150, $2.50/bf
       - Douglas Fir: Janka 660, feed 110, spindle 16000, doc 0.200, $3.00/bf
       - Western Red Cedar: Janka 350, feed 150, spindle 14000, doc 0.250, $4.00/bf
       - Spruce: Janka 490, feed 130, spindle 16000, doc 0.200, $2.00/bf
       - Eastern Hemlock: Janka 500, feed 120, spindle 16000, doc 0.200, $2.50/bf
       - Redwood: Janka 420, feed 140, spindle 14000, doc 0.250, $6.00/bf

       **Composites (5):**
       - MDF: Janka 0 (N/A), feed 100, spindle 18000, doc 0.125, $1.50/bf
       - Baltic Birch Plywood: Janka 0, feed 90, spindle 18000, doc 0.100, $3.00/bf
       - Hardwood Plywood: Janka 0, feed 90, spindle 18000, doc 0.100, $2.50/bf
       - Particle Board: Janka 0, feed 110, spindle 16000, doc 0.150, $1.00/bf
       - OSB: Janka 0, feed 100, spindle 16000, doc 0.150, $1.00/bf

       All with grainDirectionDeg = 0.0, no archivePath or thumbnailPath (defaults have no .dwmat files).

    3. Add default_materials.cpp to src/CMakeLists.txt.
  </action>
  <verify>
    cd build && cmake --build . --target digital_workshop 2>&1 | tail -5
    Compiles. getDefaultMaterials() returns 23 materials.
  </verify>
  <done>
    Default materials list with 23 species defined. getMaterialsDir() added to app_paths. All compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement MaterialManager for import, export, and seeding</name>
  <files>
    src/core/materials/material_manager.h
    src/core/materials/material_manager.cpp
    src/CMakeLists.txt
  </files>
  <action>
    1. Create material_manager.h following LibraryManager pattern:
       - Constructor takes Database& (creates internal MaterialRepository)
       - seedDefaults() — insert default materials if database is empty (count() == 0)
       - importMaterial(const Path& dwmatPath) -> std::optional of i64:
         a. Copy .dwmat file to getMaterialsDir() (prevent path invalidation per Pitfall 3 in RESEARCH.md)
         b. Use unique filename if collision (append _1, _2, etc.)
         c. Load metadata from copied .dwmat via MaterialArchive::load()
         d. Set archivePath to the managed copy location
         e. Insert into database via MaterialRepository
         f. Return new material ID
       - exportMaterial(i64 materialId, const Path& outputPath) -> bool:
         a. Find material by ID
         b. If material has archivePath, copy .dwmat to outputPath
         c. If material has no archive (default species), create .dwmat from metadata (no texture)
         d. Return success
       - getAllMaterials() -> vector of MaterialRecord (delegates to repo.findAll())
       - getMaterialsByCategory(MaterialCategory) -> vector of MaterialRecord
       - getMaterial(i64 id) -> std::optional of MaterialRecord
       - updateMaterial(const MaterialRecord&) -> bool (all fields editable per user decision)
       - removeMaterial(i64 id) -> bool (also delete .dwmat file from managed dir if exists)
       - assignMaterialToModel(i64 materialId, i64 modelId) -> bool:
         Update models table SET material_id = ? WHERE id = ?
       - getModelMaterial(i64 modelId) -> std::optional of MaterialRecord:
         SELECT material_id FROM models WHERE id = ?, then findById

    2. Implement material_manager.cpp:
       - seedDefaults(): Check count, if 0 call getDefaultMaterials() and insert each
       - importMaterial(): filesystem::copy_file to managed dir, MaterialArchive::load for metadata, repo.insert
       - exportMaterial(): filesystem::copy_file from managed archive, or MaterialArchive::create for defaults
       - assignMaterialToModel/getModelMaterial: Direct SQL via Database& since these touch models table

    3. Add material_manager.cpp to src/CMakeLists.txt.

    4. Write tests: test_material_manager.cpp — test seedDefaults populates DB, importMaterial round-trips, updateMaterial changes fields, removeMaterial cleans up.
  </action>
  <verify>
    cd build && cmake --build . --target digital_workshop 2>&1 | tail -5
    cd build && cmake --build . --target dw_tests && ./dw_tests --gtest_filter="MaterialManager*" 2>&1
    All tests pass.
  </verify>
  <done>
    MaterialManager seeds defaults on first run, imports .dwmat with copy-to-managed-dir, exports .dwmat for sharing, assigns materials to models. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build --target digital_workshop` compiles without errors
2. MaterialManager tests pass (seed, import, export, assign, remove)
3. Default species list has ~23 entries covering hardwoods, softwoods, composites
4. Import copies .dwmat to getMaterialsDir(), not leaving reference to user's original path
5. seedDefaults() only runs when database is empty (idempotent)
</verification>

<success_criteria>
- 23 built-in wood species with real Janka hardness ratings
- MaterialManager seeds defaults on first run
- .dwmat import copies to app-managed directory
- .dwmat export creates shareable archive
- Material assignment persists in models table via material_id
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-03-SUMMARY.md`
</output>

---
phase: 01-add-materials-mapping-to-object-view-with-coordinated-materials-database
plan: 05
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/ui/panels/materials_panel.h
  - src/ui/panels/materials_panel.cpp
  - src/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Materials panel displays all materials as a browsable thumbnail grid"
    - "Materials panel has category tabs: All, Hardwood, Softwood, Domestic, Composite"
    - "User can select a material by clicking it in the panel"
    - "User can double-click a material to assign it to the current object"
    - "All material fields are editable in the panel (Janka, feed/speed, cost, grain direction)"
    - "Materials can be imported (.dwmat) and exported from the panel toolbar"
  artifacts:
    - path: "src/ui/panels/materials_panel.h"
      provides: "MaterialsPanel class extending Panel"
    - path: "src/ui/panels/materials_panel.cpp"
      provides: "ImGui rendering with category tabs, thumbnail grid, edit form, import/export"
  key_links:
    - from: "src/ui/panels/materials_panel.cpp"
      to: "src/core/materials/material_manager.h"
      via: "MaterialManager for getAllMaterials, importMaterial, updateMaterial"
      pattern: "MaterialManager"
    - from: "src/ui/panels/materials_panel.cpp"
      to: "src/render/texture.h"
      via: "Texture objects for thumbnail display in ImGui::Image"
      pattern: "ImGui::Image"
---

<objective>
Create the dedicated MaterialsPanel for browsing, selecting, editing, importing, and exporting wood species materials.

Purpose: Provide the primary user interface for the materials system — a standalone panel (per user decision: "gets its own dedicated panel") with all material management functionality.
Output: MaterialsPanel with category tabs, thumbnail grid, property editor, and import/export toolbar.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-RESEARCH.md
@.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-01-SUMMARY.md
@.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-02-SUMMARY.md

# Key files to reference
@src/ui/panels/library_panel.h
@src/ui/panels/library_panel.cpp
@src/ui/panels/panel.h
@src/core/materials/material.h
@src/core/materials/material_manager.h
@src/render/texture.h
@src/ui/icons.h
@src/ui/theme.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MaterialsPanel with category tabs and thumbnail grid</name>
  <files>
    src/ui/panels/materials_panel.h
    src/ui/panels/materials_panel.cpp
    src/CMakeLists.txt
  </files>
  <action>
    1. Create materials_panel.h following LibraryPanel pattern:
       - class MaterialsPanel : public Panel
       - Constructor takes MaterialManager* pointer
       - render() override
       - Callbacks:
         - MaterialSelectedCallback = std::function<void(i64 materialId)> — single click selects
         - MaterialAssignedCallback = std::function<void(i64 materialId)> — double click assigns to object
         - setOnMaterialSelected(callback), setOnMaterialAssigned(callback)
       - refresh() — reload materials from database
       - selectedMaterialId() const -> i64 (-1 if none)

    2. Implement materials_panel.cpp with these sections:

       **render():**
       - ImGui::Begin("Materials", &m_open) with docking support
       - Call renderToolbar(), separator, renderCategoryTabs()
       - ImGui::End()

       **renderToolbar():**
       - Import button (folder icon): opens file dialog for .dwmat files, calls m_materialManager->importMaterial()
       - Export button (save icon): if material selected, opens save dialog, calls m_materialManager->exportMaterial()
       - Add button: create new empty material (opens edit form)
       - Delete button: if selected, confirm dialog then m_materialManager->removeMaterial()
       - Search filter: ImGui::InputText for filtering by name

       **renderCategoryTabs():**
       - ImGui::BeginTabBar("MaterialCategories")
       - Tabs: "All", "Hardwood", "Softwood", "Domestic", "Composite"
       - Each tab calls renderMaterialGrid() with appropriate filter
       - ImGui::EndTabBar()

       **renderMaterialGrid(const vector<MaterialRecord>& materials):**
       - Calculate columns from available width and thumbnail size (96px thumbnails, 112px cells)
       - For each material:
         - ImGui::BeginGroup()
         - If material has thumbnailPath and texture is cached, show ImGui::Image(textureId, size)
         - Else show colored placeholder rectangle with category initial (H/S/D/C)
         - ImGui::TextWrapped for material name (truncated to fit cell)
         - Single-click: set selected, fire m_onMaterialSelected
         - Double-click: fire m_onMaterialAssigned
         - Highlight selected material (ImGui::GetColorU32 with selection color)
         - Right-click: context menu with Edit, Export, Delete
         - ImGui::EndGroup()
         - Grid layout via ImGui::SameLine() with column wrapping

       **renderEditForm():**
       - Modal or inline section when editing a material
       - All fields editable (per user decision: "All fields in the material record must be editable"):
         - Name: ImGui::InputText
         - Category: ImGui::Combo (Hardwood/Softwood/Domestic/Composite)
         - Janka Hardness: ImGui::InputFloat (lbf)
         - Feed Rate: ImGui::InputFloat (inches/min)
         - Spindle Speed: ImGui::InputFloat (RPM)
         - Depth of Cut: ImGui::InputFloat (inches)
         - Cost per Board Foot: ImGui::InputFloat ($)
         - Grain Direction: ImGui::SliderFloat (0-360 degrees)
       - Save button: calls m_materialManager->updateMaterial()
       - Cancel button: discard changes

       **Thumbnail cache:**
       - std::unordered_map<i64, GLuint> for material ID -> GL texture
       - Load thumbnail textures lazily (on first render)
       - If material has no thumbnail, generate colored placeholder

    3. Private members:
       - MaterialManager* m_materialManager
       - vector<MaterialRecord> m_allMaterials (cached list)
       - string m_searchQuery
       - i64 m_selectedMaterialId = -1
       - bool m_showEditForm = false
       - MaterialRecord m_editBuffer (copy for editing)
       - unordered_map<i64, GLuint> m_thumbnailCache
       - Callbacks: m_onMaterialSelected, m_onMaterialAssigned
       - float m_thumbnailSize = 96.0f

    4. Add materials_panel.cpp to src/CMakeLists.txt DW_SOURCES (in UI Panels section).
  </action>
  <verify>
    cd build && cmake --build . --target digital_workshop 2>&1 | tail -5
    Compiles without errors.
  </verify>
  <done>
    MaterialsPanel renders with category tabs (All/Hardwood/Softwood/Domestic/Composite), thumbnail grid, toolbar (import/export/add/delete), search filter, and inline edit form for all material properties. Single-click selects, double-click assigns. All material fields editable.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build --target digital_workshop` compiles without errors
2. MaterialsPanel has all 5 category tabs
3. Toolbar has import, export, add, delete buttons
4. Edit form exposes all material fields (Janka, feed/speed, cost, grain direction)
5. Panel follows existing LibraryPanel patterns (docking, callbacks, thumbnail cache)
</verification>

<success_criteria>
- MaterialsPanel is a standalone dockable panel (per user decision)
- All 5 category tabs present and filtering correctly
- Material grid shows thumbnails or colored placeholders
- Single-click selects, double-click assigns (via callbacks)
- All material properties editable in edit form
- Import/export buttons in toolbar
- Search filter works for material names
</success_criteria>

<output>
After completion, create `.planning/phases/01-add-materials-mapping-to-object-view-with-coordinated-materials-database/01-05-SUMMARY.md`
</output>

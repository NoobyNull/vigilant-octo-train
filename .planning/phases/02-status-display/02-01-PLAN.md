---
phase: 02-status-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/panels/cnc_status_panel.h
  - src/ui/panels/cnc_status_panel.cpp
autonomous: true
requirements: [CUI-01, CUI-02, CUI-03]

must_haves:
  truths:
    - "DRO shows X, Y, Z work position with large readable digits"
    - "DRO shows X, Y, Z machine position (secondary display)"
    - "Machine state is displayed as color-coded indicator (green=Idle, red=Alarm, blue=Run, yellow=Hold)"
    - "Feed rate in mm/min and spindle RPM are visible"
    - "Panel shows Disconnected state when no machine is connected"
  artifacts:
    - path: "src/ui/panels/cnc_status_panel.h"
      provides: "CncStatusPanel class declaration"
      contains: "class CncStatusPanel : public Panel"
    - path: "src/ui/panels/cnc_status_panel.cpp"
      provides: "CNC status panel rendering implementation"
      min_lines: 150
  key_links:
    - from: "src/ui/panels/cnc_status_panel.h"
      to: "src/core/cnc/cnc_types.h"
      via: "MachineStatus struct for state storage"
      pattern: "MachineStatus"
    - from: "src/ui/panels/cnc_status_panel.h"
      to: "src/ui/panels/panel.h"
      via: "Panel base class inheritance"
      pattern: "class CncStatusPanel : public Panel"
---

<objective>
Create the CncStatusPanel — a dockable ImGui panel that displays real-time CNC machine status including DRO position readout, machine state indicator, feed rate, and spindle RPM.

Purpose: Satisfy CUI-01, CUI-02, CUI-03 — the operator needs at-a-glance visibility of machine state while running. This is the core display component; wiring to the live CNC controller happens in Plan 02.
Output: `cnc_status_panel.h` and `cnc_status_panel.cpp` in `src/ui/panels/`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/02-status-display/02-RESEARCH.md
@.planning/phases/02-status-display/02-CONTEXT.md
@src/ui/panels/panel.h
@src/ui/panels/tool_browser_panel.h
@src/ui/panels/tool_browser_panel.cpp
@src/core/cnc/cnc_types.h
@src/ui/theme.h
@src/ui/icons.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CncStatusPanel header</name>
  <files>src/ui/panels/cnc_status_panel.h</files>
  <action>
Create `src/ui/panels/cnc_status_panel.h` declaring `CncStatusPanel : public Panel`.

**Class members:**
- `MachineStatus m_status{}` — latest status (updated via callback, rendered every frame)
- `bool m_connected = false` — connection state
- `std::string m_version` — GRBL firmware version string

**Public methods:**
- Constructor: `CncStatusPanel()` — calls `Panel("CNC Status")`
- `void render() override` — main ImGui render
- `void onStatusUpdate(const MachineStatus& status)` — called from main thread callback
- `void onConnectionChanged(bool connected, const std::string& version)` — called from main thread callback

**Private render helpers (keep render() clean):**
- `void renderStateIndicator()` — color-coded state badge
- `void renderDRO()` — large XYZ position readout (work + machine)
- `void renderFeedSpindle()` — feed rate and spindle RPM display
- `void renderOverrides()` — feed/rapid/spindle override percentages

**Static helpers (in .cpp, anonymous namespace):**
- `const char* machineStateName(MachineState)` — state enum to display string
- `ImVec4 machineStateColor(MachineState)` — state enum to color

Include: `panel.h`, `../../core/cnc/cnc_types.h`, `<string>`

Follow the same include path style as `tool_browser_panel.h` (relative `../../core/` paths).
  </action>
  <verify>File exists, compiles (header-only check: include in a .cpp and verify no syntax errors)</verify>
  <done>CncStatusPanel.h declares the panel class with all methods needed for rendering and callback integration</done>
</task>

<task type="auto">
  <name>Task 2: Implement CncStatusPanel rendering</name>
  <files>src/ui/panels/cnc_status_panel.cpp</files>
  <action>
Create `src/ui/panels/cnc_status_panel.cpp` implementing the CNCjs-inspired status display.

**Include:** `ui/panels/cnc_status_panel.h`, `<imgui.h>`, `ui/icons.h`, `ui/theme.h`

Follow the same include path convention as `tool_browser_panel.cpp` (use `ui/panels/` prefix, not `../../`).

**Anonymous namespace helpers:**

1. `machineStateName(MachineState)` — returns display string:
   - Idle, Run, Hold, Jog, Alarm, Door, Check, Homing, Sleep, Unknown

2. `machineStateColor(MachineState)` — returns ImVec4:
   - Idle: green (0.3, 0.8, 0.3, 1.0)
   - Run: blue (0.3, 0.5, 1.0, 1.0)
   - Hold: yellow (1.0, 0.8, 0.2, 1.0)
   - Jog: light blue (0.3, 0.7, 1.0, 1.0)
   - Alarm: red (1.0, 0.3, 0.3, 1.0)
   - Door: orange (1.0, 0.5, 0.2, 1.0)
   - Check: lavender (0.6, 0.6, 0.8, 1.0)
   - Home: cyan (0.5, 0.8, 1.0, 1.0)
   - Sleep: gray (0.5, 0.5, 0.5, 1.0)
   - Unknown/default: gray

**Constructor:** `CncStatusPanel() : Panel("CNC Status") {}`

**render():**
- Early return if `!m_open`
- `ImGui::Begin(m_title.c_str(), &m_open)` — standard dockable panel pattern
- If `!m_connected`: show `Icons::Unlink + " Disconnected"` in gray, version if available, `ImGui::TextDisabled("Connect to see machine status")`, then `ImGui::End(); return;`
- If connected: call `renderStateIndicator()`, separator, `renderDRO()`, separator, `renderFeedSpindle()`, separator, `renderOverrides()`
- `ImGui::End()`

**renderStateIndicator():**
- Get color from `machineStateColor(m_status.state)`
- Draw a filled colored rectangle using `ImGui::GetWindowDrawList()->AddRectFilled()` as a background bar spanning the content width, ~30px tall
- Overlay the state name text centered on the bar using `ImGui::SetCursorPos` and `ImGui::TextColored(white, "%s %s", Icons::Info, machineStateName(m_status.state))`
- This creates a CNCjs-style prominent state banner

**renderDRO():**
- Section header: `ImGui::SeparatorText("Position")`
- Use `ImGui::SetWindowFontScale(2.0f)` for large DRO digits (avoids font atlas complexity)
- Display axis colors: X=red (1,0.3,0.3), Y=green (0.3,1,0.3), Z=blue (0.3,0.5,1)
- For each axis (X, Y, Z):
  - `ImGui::TextColored(axisColor, "X")` then `ImGui::SameLine()` then `ImGui::Text("%+10.3f", workPos[i])`
- Reset `ImGui::SetWindowFontScale(1.0f)`
- Show machine position in smaller text below:
  - `ImGui::TextDisabled("Machine:")` then for each axis: `ImGui::SameLine(); ImGui::TextDisabled("%c %+.3f", 'X'+i, machPos[i])`
- Use `m_status.workPos.x/y/z` and `m_status.machinePos.x/y/z` (Vec3 members)

**renderFeedSpindle():**
- Section header: `ImGui::SeparatorText("Feed & Spindle")`
- Two-column layout using `ImGui::Columns(2)` or `ImGui::BeginTable`
- Left column: Feed rate icon + `"%.0f mm/min"` from `m_status.feedRate`
- Right column: Spindle icon + `"%.0f RPM"` from `m_status.spindleSpeed`
- Use `ImGui::SetWindowFontScale(1.5f)` for these values to make them prominent but not as large as DRO

**renderOverrides():**
- Only show if any override != 100
- `ImGui::SeparatorText("Overrides")`
- Three items on one line: `"Feed %d%%" m_status.feedOverride`, `"Rapid %d%%" m_status.rapidOverride`, `"Spindle %d%%" m_status.spindleOverride`
- Color yellow if != 100, white if 100

**onStatusUpdate(const MachineStatus&):** Simply copy: `m_status = status;`

**onConnectionChanged(bool, const std::string&):** Set `m_connected = connected; m_version = version;` If disconnecting, optionally reset status to default.

NOTE: No mutex needed — these callbacks fire on the main thread via MainThreadQueue (see research pitfall #1).
  </action>
  <verify>
File compiles. Check that:
1. render() follows the Panel pattern (early return on !m_open, ImGui::Begin/End)
2. DRO shows XYZ with work and machine positions
3. State indicator uses color coding
4. Feed/spindle values are displayed
5. Disconnected state is handled gracefully
  </verify>
  <done>
CncStatusPanel renders a CNCjs-inspired status display with:
- Color-coded state banner (visible from across a shop)
- Large DRO digits for XYZ work position
- Secondary machine position readout
- Feed rate and spindle RPM display
- Override percentages when active
- Clean "Disconnected" state when no machine
  </done>
</task>

</tasks>

<verification>
- [ ] `cnc_status_panel.h` declares CncStatusPanel inheriting from Panel
- [ ] `cnc_status_panel.cpp` implements all render methods
- [ ] Panel follows the same pattern as ToolBrowserPanel (Begin/End, early returns)
- [ ] DRO displays X, Y, Z work position with large readable digits
- [ ] Machine position shown as secondary readout
- [ ] Machine state shown as color-coded indicator
- [ ] Feed rate and spindle RPM displayed
- [ ] Disconnected state shows appropriate placeholder
- [ ] No mutex or threading code in the panel (callbacks are main-thread)
- [ ] Code compiles clean
</verification>

<success_criteria>
CncStatusPanel class exists with complete rendering logic. When instantiated and given MachineStatus data via callbacks, it renders a polished CNCjs-inspired status display with DRO, state indicator, feed/spindle readout, and override display. Disconnected state is handled gracefully.
</success_criteria>

<output>
After completion, create `.planning/phases/02-status-display/02-01-SUMMARY.md`
</output>

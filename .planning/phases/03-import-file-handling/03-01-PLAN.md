---
phase: 03-import-file-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/import/filesystem_detector.h
  - src/core/import/filesystem_detector.cpp
  - src/ui/dialogs/import_options_dialog.h
  - src/ui/dialogs/import_options_dialog.cpp
  - src/CMakeLists.txt
  - tests/test_filesystem_detector.cpp
  - tests/CMakeLists.txt
autonomous: true
requirements: [STOR-04, IMPORT-02]

must_haves:
  truths:
    - "Application can detect whether a file path is on a local or network filesystem"
    - "A dialog exists that shows keep/copy/move radio buttons with recommendation text"
    - "Non-local paths trigger a visible recommendation to copy"
  artifacts:
    - path: "src/core/import/filesystem_detector.h"
      provides: "StorageLocation enum and detectFilesystem() function declaration"
      contains: "StorageLocation"
    - path: "src/core/import/filesystem_detector.cpp"
      provides: "Platform-specific filesystem detection using statfs (Linux), f_fstypename (macOS), GetDriveTypeW (Windows)"
      min_lines: 30
    - path: "src/ui/dialogs/import_options_dialog.h"
      provides: "ImportOptionsDialog class with open() accepting paths and a result callback"
      contains: "ImportOptionsDialog"
    - path: "src/ui/dialogs/import_options_dialog.cpp"
      provides: "ImGui modal with radio buttons for file handling mode and recommendation text"
      min_lines: 60
    - path: "tests/test_filesystem_detector.cpp"
      provides: "Unit tests for filesystem detection"
      contains: "TEST"
  key_links:
    - from: "src/ui/dialogs/import_options_dialog.cpp"
      to: "src/core/import/filesystem_detector.h"
      via: "includes detectFilesystem() to auto-select mode"
      pattern: "detectFilesystem"
    - from: "src/ui/dialogs/import_options_dialog.cpp"
      to: "src/core/config/config.h"
      via: "uses FileHandlingMode enum"
      pattern: "FileHandlingMode"
---

<objective>
Create the filesystem detection utility and import options dialog for Phase 3.

Purpose: Enable the application to detect non-local filesystems (NAS, cloud drives, FUSE mounts) and present the user with an informed file handling choice during import. This is the foundation for smart import defaults.

Output: FilesystemDetector utility (cross-platform), ImportOptionsDialog (ImGui modal), and unit tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md (Section 3: Cross-Platform Filesystem Detection)
@.planning/research/PITFALLS.md (Pitfall 3: NAS File Operations)

@src/core/config/config.h (FileHandlingMode enum at line 23-27)
@src/core/import/file_handler.h (existing FileHandler pattern)
@src/ui/dialogs/dialog.h (Dialog base class)
@src/ui/dialogs/import_summary_dialog.h (reference for dialog pattern)
@src/ui/dialogs/import_summary_dialog.cpp (reference for ImGui modal rendering)
@src/CMakeLists.txt (source file listing)
@tests/CMakeLists.txt (test registration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Filesystem detector with cross-platform detection and tests</name>
  <files>
    src/core/import/filesystem_detector.h
    src/core/import/filesystem_detector.cpp
    tests/test_filesystem_detector.cpp
    src/CMakeLists.txt
    tests/CMakeLists.txt
  </files>
  <action>
Create `src/core/import/filesystem_detector.h`:
- Define `enum class StorageLocation { Local, Network, Unknown }` inside `namespace dw`
- Define `struct FilesystemInfo { StorageLocation location; std::string fsTypeName; }`
- Declare free function: `FilesystemInfo detectFilesystem(const Path& path)` (in `namespace dw`)
- Include `<filesystem>` and `<string>`, use `../types.h` for Path alias

Create `src/core/import/filesystem_detector.cpp`:
- Single file with `#ifdef` platform dispatch (NOT separate per-platform files -- keeps CMakeLists simple since all sources are in one flat list)
- **Linux** (`#elif defined(__linux__)`): Use `statfs(2)` from `<sys/vfs.h>`. Walk up to find existing ancestor if path doesn't exist. Check `f_type` against magic numbers: NFS=0x6969, SMB=0x517B, CIFS=0xFF534D42, SMB2=0xFE534D42, FUSE=0x65735546. Return Network if any match, Local otherwise.
- **macOS** (`#elif defined(__APPLE__)`): Use `statfs` from `<sys/mount.h>`. Check `f_fstypename` string against "nfs", "smbfs", "afpfs", "webdav". Return Network if match.
- **Windows** (`#ifdef _WIN32`): Use `GetDriveTypeW()`. Extract root path via `path.root_path().wstring()`. Return Network if `DRIVE_REMOTE`.
- **Fallback**: Return `StorageLocation::Unknown` if platform not recognized or syscall fails.
- Walk up parent directories if the given path doesn't exist yet (for paths that will be created).

Add `core/import/filesystem_detector.cpp` to `DW_SOURCES` in `src/CMakeLists.txt` (in the Import section, after `core/import/file_handler.cpp`).

Create `tests/test_filesystem_detector.cpp`:
- Test that `detectFilesystem("/")` returns `StorageLocation::Local` (root is always local)
- Test that `detectFilesystem("/tmp")` returns `StorageLocation::Local`
- Test that `detectFilesystem("/nonexistent/path/that/doesnt/exist")` doesn't crash and returns a valid result (walks up to `/`)
- Test that `detectFilesystem("")` returns `StorageLocation::Unknown`
- Add the test file to `tests/CMakeLists.txt` following the existing pattern for test registration

Keep filesystem_detector.cpp under 200 lines. Keep the header under 40 lines.
  </action>
  <verify>
Build: `cd /data/DW/build_debug && cmake .. && cmake --build . 2>&1 | tail -20` (compiles without errors)
Tests: `cd /data/DW/build_debug && ctest --test-dir . -R filesystem_detector --output-on-failure` (all pass)
  </verify>
  <done>
detectFilesystem() compiles on Linux, returns Local for local paths like /tmp, handles nonexistent paths without crashing, and all unit tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Import options dialog with radio buttons and NAS recommendation</name>
  <files>
    src/ui/dialogs/import_options_dialog.h
    src/ui/dialogs/import_options_dialog.cpp
    src/CMakeLists.txt
  </files>
  <action>
Create `src/ui/dialogs/import_options_dialog.h`:
- Class `ImportOptionsDialog` extending `Dialog` (from `ui/dialogs/dialog.h`)
- Public method: `void open(const std::vector<Path>& paths)` -- stores the paths, runs detectFilesystem on the first path to determine recommendation, opens the ImGui popup
- Public method: `void render() override` -- renders the modal each frame
- Result callback: `using ResultCallback = std::function<void(FileHandlingMode mode, const std::vector<Path>& paths)>` -- called when user confirms
- Public method: `void setOnConfirm(ResultCallback callback)`
- Private members: stored paths, detected StorageLocation, selected FileHandlingMode (int for ImGui radio), ResultCallback
- Max 50 lines for header

Create `src/ui/dialogs/import_options_dialog.cpp`:
- In `open()`: Run `detectFilesystem()` on the first file's parent directory. If Network detected, auto-select CopyToLibrary and set recommendation flag. If Local, default to MoveToLibrary. Store the detected location.
- In `render()`:
  - Modal popup titled "Import Options" (follow ImportSummaryDialog pattern for centering/sizing)
  - Show file count: "Importing N file(s)"
  - Show source location info: If Network detected, show warning-colored text: "Source appears to be a network/remote drive (NAS, cloud sync, etc.)" with icon
  - Radio buttons section "Where should imported files live?":
    - `( ) Keep in original location` -- with helper text: "Files stay where they are. Path stored as-is -- may break if files move."
    - `( ) Copy to library` -- with helper text: "Safe copy to local library folder."
    - `( ) Move to library` -- with helper text: "Moves files from current location to library."
  - If Network detected, show recommendation below radio group: "Recommended: Copy to library. Network files should be copied locally for reliable access." (yellow/warning color)
  - If Network detected AND user selects MoveToLibrary, show additional warning: "Moving files from a network drive is not recommended -- connection drops can cause data loss."
  - Two buttons: "Import" (calls ResultCallback with selected mode + paths, closes popup) and "Cancel" (closes popup, no callback)
- Use ImGui:: RadioButton with int cast of FileHandlingMode values
- Follow the exact ImGui modal pattern from ImportSummaryDialog (BeginPopupModal, SetNextWindowPos center, etc.)
- Max 200 lines for cpp

Add `ui/dialogs/import_options_dialog.cpp` to `DW_SOURCES` in `src/CMakeLists.txt` (in the UI Dialogs section, after `ui/dialogs/import_summary_dialog.cpp`).
  </action>
  <verify>
Build: `cd /data/DW/build_debug && cmake --build . 2>&1 | tail -20` (compiles without errors)
Grep check: `grep -c "ImportOptionsDialog" src/ui/dialogs/import_options_dialog.h` returns non-zero
Grep check: `grep -c "detectFilesystem" src/ui/dialogs/import_options_dialog.cpp` returns non-zero (dialog uses detection)
  </verify>
  <done>
ImportOptionsDialog compiles, inherits from Dialog, has radio buttons for all three FileHandlingMode values, calls detectFilesystem to determine recommendation, and shows warning text for network sources.
  </done>
</task>

</tasks>

<verification>
1. Full build succeeds: `cd /data/DW/build_debug && cmake .. && cmake --build .`
2. Filesystem detector tests pass: `ctest -R filesystem_detector`
3. New files follow project conventions: one class per header, headers under 400 lines, cpp under 800 lines
4. No new external dependencies added (only platform syscalls)
</verification>

<success_criteria>
- detectFilesystem() returns Local for local paths, handles edge cases gracefully
- ImportOptionsDialog shows three radio buttons matching FileHandlingMode enum values
- Network sources auto-select "Copy to library" with visible recommendation text
- All existing tests still pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-import-file-handling/03-01-SUMMARY.md`
</output>

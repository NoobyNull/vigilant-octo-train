---
phase: 03-import-file-handling
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/managers/file_io_manager.h
  - src/managers/file_io_manager.cpp
  - src/managers/ui_manager.h
  - src/managers/ui_manager.cpp
  - src/app/application.cpp
  - src/core/import/import_queue.h
  - src/core/import/import_queue.cpp
autonomous: false
requirements: [IMPORT-01, IMPORT-02, STOR-04]

must_haves:
  truths:
    - "User sees the import options dialog when importing files via menu or drag-and-drop"
    - "User can choose keep/copy/move and the choice is applied to the import batch"
    - "Importing from a NAS auto-selects copy and shows recommendation"
    - "Importing from a local drive defaults to move (user can override)"
    - "Files imported via copy or move land in the library directory; keep-in-place preserves original path"
  artifacts:
    - path: "src/managers/file_io_manager.cpp"
      provides: "Import flow that shows ImportOptionsDialog before enqueuing"
      contains: "ImportOptionsDialog"
    - path: "src/core/import/import_queue.h"
      provides: "Overloaded enqueue accepting FileHandlingMode"
      contains: "FileHandlingMode"
    - path: "src/app/application.cpp"
      provides: "Wiring of ImportOptionsDialog into UIManager and callbacks"
      contains: "importOptionsDialog"
  key_links:
    - from: "src/managers/file_io_manager.cpp"
      to: "src/ui/dialogs/import_options_dialog.h"
      via: "opens dialog with selected paths"
      pattern: "importOptionsDialog.*open"
    - from: "src/app/application.cpp"
      to: "src/ui/dialogs/import_options_dialog.h"
      via: "creates dialog, wires confirm callback to enqueue"
      pattern: "setOnConfirm"
    - from: "src/core/import/import_queue.cpp"
      to: "src/core/import/file_handler.h"
      via: "passes per-batch mode to handleImportedFile instead of reading global config"
      pattern: "handleImportedFile.*mode"
---

<objective>
Wire the ImportOptionsDialog into the import flow so users see file handling choices before import begins.

Purpose: Complete the import file handling feature by connecting the dialog (from Plan 01) to the actual import pipeline. The user's choice must flow from the dialog through to the file handler.

Output: Working end-to-end flow: user selects files -> dialog appears with smart defaults -> user confirms -> files imported with chosen mode.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-import-file-handling/03-01-SUMMARY.md

@src/managers/file_io_manager.h
@src/managers/file_io_manager.cpp
@src/managers/ui_manager.h
@src/managers/ui_manager.cpp
@src/app/application.cpp
@src/core/import/import_queue.h
@src/core/import/import_queue.cpp
@src/core/import/file_handler.h
@src/core/import/file_handler.cpp
@src/core/config/config.h (FileHandlingMode enum)
@src/ui/dialogs/import_options_dialog.h (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add per-batch FileHandlingMode to ImportQueue and wire dialog into import flow</name>
  <files>
    src/core/import/import_queue.h
    src/core/import/import_queue.cpp
    src/managers/ui_manager.h
    src/managers/ui_manager.cpp
    src/managers/file_io_manager.h
    src/managers/file_io_manager.cpp
    src/app/application.cpp
  </files>
  <action>
**ImportQueue changes** (`src/core/import/import_queue.h` and `.cpp`):
- Add a `FileHandlingMode m_batchMode` member (default: from Config)
- Add overloaded `void enqueue(const std::vector<Path>& paths, FileHandlingMode mode)` that stores the mode before dispatching
- In `processTask()` at Stage 5.5 (around line 502-537 of import_queue.cpp), replace `auto mode = Config::instance().getFileHandlingMode()` with `auto mode = m_batchMode` so the per-batch choice is used instead of the global config
- The existing single-arg `enqueue(paths)` should continue to read from Config as fallback (backward compat for drag-and-drop before dialog is wired)

**UIManager changes** (`src/managers/ui_manager.h` and `.cpp`):
- Add `#include "ui/dialogs/import_options_dialog.h"` (or forward-declare and include in .cpp)
- Add `std::unique_ptr<ImportOptionsDialog> m_importOptionsDialog` member
- Create in `init()`: `m_importOptionsDialog = std::make_unique<ImportOptionsDialog>()`
- Add accessor: `ImportOptionsDialog* importOptionsDialog() { return m_importOptionsDialog.get(); }`
- Call `m_importOptionsDialog->render()` in `renderPanels()` (alongside other dialog renders)

**FileIOManager changes** (`src/managers/file_io_manager.h` and `.cpp`):
- Add `ImportOptionsDialog* m_importOptionsDialog = nullptr` member
- Add setter: `void setImportOptionsDialog(ImportOptionsDialog* dialog)`
- In `importModel()`: After collecting paths from file dialog, instead of directly calling `m_importQueue->enqueue(importPaths)`, call `m_importOptionsDialog->open(importPaths)` to show the options dialog first. If m_importOptionsDialog is null, fall back to direct enqueue (backward compat).
- In `onFilesDropped()`: Same change -- show dialog instead of direct enqueue. Drag-and-drop should also present the choice.

**Application wiring** (`src/app/application.cpp`):
- After creating UIManager and FileIOManager, wire the import options dialog:
  ```
  m_fileIOManager->setImportOptionsDialog(m_uiManager->importOptionsDialog());
  ```
- Wire the confirm callback on the ImportOptionsDialog:
  ```
  if (m_uiManager->importOptionsDialog()) {
      m_uiManager->importOptionsDialog()->setOnConfirm(
          [this](FileHandlingMode mode, const std::vector<Path>& paths) {
              if (m_importQueue && !paths.empty()) {
                  m_importQueue->enqueue(paths, mode);
              }
          });
  }
  ```
- Place this wiring after the existing ImportSummaryDialog wiring (around line 249-255 of application.cpp)

**Important constraints:**
- Do NOT remove the global Config FileHandlingMode setting -- it remains as the default for the dialog's initial selection and as fallback
- Do NOT change the FileHandler class itself -- it already accepts FileHandlingMode as a parameter
- The dialog must appear for BOTH menu-triggered imports AND drag-and-drop imports
- Keep all file changes under the line limits (800 cpp, 400 h)
  </action>
  <verify>
Build: `cd /data/DW/build_debug && cmake --build . 2>&1 | tail -20` (compiles without errors)
All tests pass: `cd /data/DW/build_debug && ctest --output-on-failure`
Grep: `grep -n "enqueue.*FileHandlingMode" src/core/import/import_queue.h` shows the new overload
Grep: `grep -n "importOptionsDialog" src/app/application.cpp` shows wiring
  </verify>
  <done>
ImportQueue accepts per-batch FileHandlingMode. FileIOManager shows ImportOptionsDialog before enqueuing. Application wires the dialog's confirm callback to ImportQueue::enqueue with the chosen mode. Build succeeds, all existing tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify import options dialog end-to-end</name>
  <what-built>
Complete import file handling flow: filesystem detection, import options dialog with keep/copy/move choices, smart defaults based on source filesystem, and wiring into both menu import and drag-and-drop.
  </what-built>
  <how-to-verify>
1. Launch the application: `cd /data/DW/build_debug && ./digital_workshop`
2. **Test menu import (local file):**
   - Click File > Import Model (or use keyboard shortcut)
   - Select one or more local model files (e.g., from /tmp or home directory)
   - Verify the "Import Options" dialog appears with:
     - File count shown
     - Three radio buttons: "Keep in original location", "Copy to library", "Move to library"
     - "Move to library" should be pre-selected (local file default)
     - No NAS warning shown
   - Click "Import" and verify the import proceeds normally
3. **Test drag-and-drop:**
   - Drag a model file onto the application window
   - Verify the same "Import Options" dialog appears before import starts
4. **Test cancel:**
   - Open import dialog, click "Cancel"
   - Verify no import occurs
5. **Test NAS behavior (if NAS available):**
   - Import from a network mount
   - Verify "Copy to library" is pre-selected
   - Verify recommendation text is visible (yellow warning about network source)
   - Verify selecting "Move to library" shows additional warning
6. **Test keep-in-place:**
   - Import a file with "Keep in original location" selected
   - Verify the file stays at its original path (check in library panel properties)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Full build succeeds with no warnings: `cd /data/DW/build_debug && cmake .. && cmake --build .`
2. All existing tests pass: `ctest --output-on-failure`
3. Import via menu shows options dialog before importing
4. Drag-and-drop shows options dialog before importing
5. NAS detection auto-selects "Copy" with visible recommendation
6. Local files default to "Move" (user can override)
7. Selected mode flows through to ImportQueue and FileHandler
</verification>

<success_criteria>
- User sees file handling choice dialog on every import (menu and drag-and-drop)
- Network sources auto-select "Copy to library" with recommendation text
- Local sources default to "Move to library"
- User's choice is applied to the actual file handling (copy/move/leave)
- Cancel dismisses without importing
- All existing functionality (duplicates, thumbnails, batch summary) still works
</success_criteria>

<output>
After completion, create `.planning/phases/03-import-file-handling/03-02-SUMMARY.md`
</output>

---
phase: 04-organization-and-graph
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/database/schema.h
  - src/core/database/schema.cpp
  - src/core/database/model_repository.h
  - src/core/database/model_repository.cpp
  - cmake/Dependencies.cmake
autonomous: true
requirements: [ORG-01, ORG-02]

must_haves:
  truths:
    - "Categories table exists with parent_id for 2-level hierarchy"
    - "model_categories junction table enables many-to-many category assignment"
    - "FTS5 virtual table indexes model name, tags, and category"
    - "FTS5 triggers keep index in sync on INSERT, UPDATE, DELETE"
    - "ModelRecord includes category and genus fields"
    - "ModelRepository can search via FTS5 and filter by category"
  artifacts:
    - path: "src/core/database/schema.h"
      provides: "Schema version bump to 7"
      contains: "CURRENT_VERSION = 7"
    - path: "src/core/database/schema.cpp"
      provides: "Categories table, model_categories table, FTS5 virtual table, triggers"
      contains: "models_fts"
    - path: "src/core/database/model_repository.h"
      provides: "searchFTS, findByCategory, category CRUD methods"
      exports: ["searchFTS", "findByCategory", "assignCategory"]
    - path: "src/core/database/model_repository.cpp"
      provides: "Implementation of FTS5 search and category operations"
      min_lines: 30
  key_links:
    - from: "src/core/database/schema.cpp"
      to: "models_fts virtual table"
      via: "CREATE VIRTUAL TABLE"
      pattern: "CREATE VIRTUAL TABLE.*models_fts.*fts5"
    - from: "src/core/database/schema.cpp"
      to: "FTS5 triggers"
      via: "BEFORE UPDATE trigger for delete phase"
      pattern: "BEFORE UPDATE ON models"
---

<objective>
Schema v7: categories tables, FTS5 search, and repository methods

Purpose: Establish the data foundation for category organization (ORG-01) and full-text search (ORG-02). All subsequent plans depend on these schema additions and repository methods.

Output: Updated schema with categories + FTS5, ModelRepository with search and category methods, FTS5 enabled in CMake.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS.md
@.planning/research/FEATURES.md
@.planning/research/ARCHITECTURE.md
@src/core/database/schema.h
@src/core/database/schema.cpp
@src/core/database/model_repository.h
@src/core/database/model_repository.cpp
@src/core/database/database.h
@cmake/Dependencies.cmake
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable FTS5 compile flag and create schema v7 with categories + FTS5</name>
  <files>
    cmake/Dependencies.cmake
    src/core/database/schema.h
    src/core/database/schema.cpp
  </files>
  <action>
1. In `cmake/Dependencies.cmake`, add `SQLITE_ENABLE_FTS5` compile definition to the sqlite3 target. After the `add_library(sqlite3 STATIC ...)` block (around line 88-92), add:
   ```
   target_compile_definitions(sqlite3 PRIVATE SQLITE_ENABLE_FTS5)
   ```
   Also add it for the system SQLite case (when SQLite3_FOUND) by adding after the `if(SQLite3_FOUND)` block:
   ```
   target_compile_definitions(SQLite::SQLite3 INTERFACE SQLITE_ENABLE_FTS5)
   ```
   Note: System SQLite on most Linux distros already has FTS5 compiled in, but the flag is needed for the FetchContent case.

2. In `schema.h`, bump `CURRENT_VERSION` from 6 to 7.

3. In `schema.cpp` `createTables()`, add after the models table creation:

   a. Categories table:
   ```sql
   CREATE TABLE IF NOT EXISTS categories (
       id INTEGER PRIMARY KEY AUTOINCREMENT,
       name TEXT NOT NULL,
       parent_id INTEGER DEFAULT NULL REFERENCES categories(id) ON DELETE CASCADE,
       sort_order INTEGER DEFAULT 0,
       UNIQUE(name, parent_id)
   );
   ```

   b. Model-categories junction table (many-to-many):
   ```sql
   CREATE TABLE IF NOT EXISTS model_categories (
       model_id INTEGER NOT NULL REFERENCES models(id) ON DELETE CASCADE,
       category_id INTEGER NOT NULL REFERENCES categories(id) ON DELETE CASCADE,
       PRIMARY KEY (model_id, category_id)
   );
   ```

   c. FTS5 virtual table (external content from models):
   ```sql
   CREATE VIRTUAL TABLE IF NOT EXISTS models_fts USING fts5(
       name,
       tags,
       content='models',
       content_rowid='id',
       tokenize='unicode61'
   );
   ```
   Use `unicode61` tokenizer (NOT porter) per Pitfall 7 -- porter corrupts non-English model names.

   d. FTS5 triggers. CRITICAL: Use BEFORE UPDATE for the delete phase per Pitfall 2. The trigger pattern is:
   ```sql
   -- AFTER INSERT: add to FTS
   CREATE TRIGGER IF NOT EXISTS models_fts_ai AFTER INSERT ON models BEGIN
       INSERT INTO models_fts(rowid, name, tags) VALUES (new.id, new.name, new.tags);
   END;

   -- BEFORE UPDATE: delete old tokens (MUST be BEFORE, not AFTER -- see Pitfall 2)
   CREATE TRIGGER IF NOT EXISTS models_fts_bu BEFORE UPDATE ON models BEGIN
       INSERT INTO models_fts(models_fts, rowid, name, tags)
       VALUES ('delete', old.id, old.name, old.tags);
   END;

   -- AFTER UPDATE: insert new tokens
   CREATE TRIGGER IF NOT EXISTS models_fts_au AFTER UPDATE ON models BEGIN
       INSERT INTO models_fts(rowid, name, tags) VALUES (new.id, new.name, new.tags);
   END;

   -- AFTER DELETE: delete tokens
   CREATE TRIGGER IF NOT EXISTS models_fts_ad AFTER DELETE ON models BEGIN
       INSERT INTO models_fts(models_fts, rowid, name, tags)
       VALUES ('delete', old.id, old.name, old.tags);
   END;
   ```

   e. Add indexes for categories:
   ```sql
   CREATE INDEX IF NOT EXISTS idx_categories_parent ON categories(parent_id);
   CREATE INDEX IF NOT EXISTS idx_model_categories_model ON model_categories(model_id);
   CREATE INDEX IF NOT EXISTS idx_model_categories_category ON model_categories(category_id);
   ```

4. In `schema.cpp` `migrate()`, add a `fromVersion < 7` block that:
   - Creates the categories and model_categories tables (same SQL as createTables)
   - Creates the FTS5 virtual table and all 4 triggers
   - Creates the indexes
   - Runs `INSERT INTO models_fts(models_fts) VALUES('rebuild')` to index existing rows
   - Per project rule: "no migrations, delete and recreate" -- but the migrate function already exists with v5 and v6 migrations, so follow the established pattern. The rebuild step handles existing data.
  </action>
  <verify>
Build the project: `cd /data/DW/build && cmake .. && make -j$(nproc) 2>&1 | head -50` -- should compile without errors. Run existing tests to confirm no regressions.
  </verify>
  <done>Schema version is 7. categories, model_categories, models_fts tables created. Four FTS5 triggers exist (ai, bu, au, ad). BEFORE UPDATE trigger used for delete phase. Existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add FTS5 search and category methods to ModelRepository and ModelRecord</name>
  <files>
    src/core/database/model_repository.h
    src/core/database/model_repository.cpp
  </files>
  <action>
1. In `model_repository.h`, add to ModelRecord struct:
   ```cpp
   // Category (populated from model_categories join)
   std::vector<std::string> categories; // Category names this model belongs to
   ```

2. Add new methods to ModelRepository class:
   ```cpp
   // FTS5 full-text search with BM25 ranking
   std::vector<ModelRecord> searchFTS(const std::string& query);

   // Category operations
   bool assignCategory(i64 modelId, i64 categoryId);
   bool removeCategory(i64 modelId, i64 categoryId);
   std::vector<ModelRecord> findByCategory(i64 categoryId);

   // Category CRUD
   std::optional<i64> createCategory(const std::string& name, std::optional<i64> parentId = std::nullopt);
   bool deleteCategory(i64 categoryId);
   struct CategoryRecord {
       i64 id = 0;
       std::string name;
       std::optional<i64> parentId;
       int sortOrder = 0;
   };
   std::vector<CategoryRecord> getAllCategories();
   std::vector<CategoryRecord> getChildCategories(i64 parentId);
   std::vector<CategoryRecord> getRootCategories();
   ```
   Define CategoryRecord as a nested struct or at namespace level (namespace level preferred for clarity, place above ModelRepository class).

3. In `model_repository.cpp`, implement:

   a. `searchFTS`: Use FTS5 MATCH with BM25 ranking. Support prefix search for search-as-you-type by appending `*` if the query does not already end with `*`. Weight name higher than tags with `bm25(models_fts, 10.0, 3.0)`:
   ```cpp
   std::vector<ModelRecord> ModelRepository::searchFTS(const std::string& query) {
       std::vector<ModelRecord> results;
       if (query.empty()) return results;

       // Sanitize: wrap each word in quotes, append * for prefix matching
       std::string ftsQuery = query;
       // Add prefix wildcard for search-as-you-type if not already present
       if (!ftsQuery.empty() && ftsQuery.back() != '*') {
           ftsQuery += '*';
       }

       auto stmt = m_db.prepare(
           "SELECT m.* FROM models m "
           "INNER JOIN models_fts ON models_fts.rowid = m.id "
           "WHERE models_fts MATCH ? "
           "ORDER BY bm25(models_fts, 10.0, 3.0) "
           "LIMIT 500");
       if (!stmt.isValid()) return results;
       if (!stmt.bindText(1, ftsQuery)) return results;
       while (stmt.step()) {
           results.push_back(rowToModel(stmt));
       }
       return results;
   }
   ```

   b. `assignCategory` / `removeCategory`: Simple INSERT/DELETE on model_categories junction table.

   c. `findByCategory`: JOIN models with model_categories WHERE category_id = ?.

   d. Category CRUD: Standard INSERT/SELECT/DELETE on categories table. `getRootCategories` queries WHERE parent_id IS NULL. `getChildCategories` queries WHERE parent_id = ?.

   e. `getAllCategories`: SELECT * FROM categories ORDER BY parent_id, sort_order, name.

   Note: Do NOT modify the existing `rowToModel` to populate categories by default (it would add a query per row). Categories are loaded on-demand when needed.
  </action>
  <verify>
Build: `cd /data/DW/build && make -j$(nproc)` -- compiles without errors. Run `./build/tests/dw_tests` to confirm existing tests pass.
  </verify>
  <done>ModelRepository has searchFTS (BM25 ranked, prefix search), category CRUD (create, delete, get root/children), and model-category assignment (assign, remove, findByCategory). CategoryRecord struct defined. Existing tests pass.</done>
</task>

</tasks>

<verification>
1. `cd /data/DW/build && cmake .. && make -j$(nproc)` compiles cleanly
2. `./build/tests/dw_tests` -- all existing tests pass
3. Schema version is 7 in schema.h
4. `grep -c "BEFORE UPDATE" src/core/database/schema.cpp` returns 1 (confirming correct trigger pattern)
5. `grep "SQLITE_ENABLE_FTS5" cmake/Dependencies.cmake` confirms FTS5 enabled
</verification>

<success_criteria>
- Schema v7 with categories, model_categories, models_fts tables and 4 triggers
- FTS5 BEFORE UPDATE trigger for delete phase (Pitfall 2 prevention)
- unicode61 tokenizer (Pitfall 7 prevention)
- ModelRepository::searchFTS with BM25 ranking and prefix search
- Category CRUD and model-category assignment methods
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-organization-and-graph/04-01-SUMMARY.md`
</output>

# Plan 08-01: CutOptimizer Save/Load & G-code Project Association UI

## Goal
Add Save/Load buttons to CutOptimizerPanel for persisting cut plans to the database (linked to current project). Add "Add to Project" UI for G-code files from the GCode panel and context menus.

## Context

**After Phase 6:** `CutPlanRepository` exists with full CRUD and JSON serialization helpers.
**After Phase 7:** ProjectPanel shows Cut Plans and G-code sections. Navigation callbacks are wired. "Add to Project" exists in Library panel for models.

**CutOptimizerPanel current state:**
- Has `m_parts`, `m_sheet`, `m_result`, `m_hasResults`, `m_algorithm`, `m_kerf`, `m_margin`, `m_allowRotation`
- `renderToolbar()` has "Run" button
- No persistence — results lost when panel closes

**GCodePanel current state:**
- Has `loadFile(path)` and `m_filePath`
- No concept of gcode database record ID

**Files to read before implementing:**
- `src/ui/panels/cut_optimizer_panel.h` — current state
- `src/ui/panels/cut_optimizer_panel.cpp` — renderToolbar(), runOptimization()
- `src/ui/panels/gcode_panel.h` — current state
- `src/ui/panels/gcode_panel.cpp` — loadFile(), renderToolbar()
- `src/core/database/cut_plan_repository.h` — CutPlanRecord, serialization helpers
- `src/core/database/gcode_repository.h` — GCodeRecord, project methods

## Tasks

### Task 1: Add CutPlanRepository and ProjectManager to CutOptimizerPanel

**cut_optimizer_panel.h:**
```cpp
// Add forward declarations
class CutPlanRepository;
class ProjectManager;

// Add members
CutPlanRepository* m_cutPlanRepo = nullptr;
ProjectManager* m_projectManager = nullptr;
i64 m_loadedPlanId = -1;  // Track which plan is loaded for updates

// Add setter methods
void setCutPlanRepository(CutPlanRepository* repo);
void setProjectManager(ProjectManager* pm);

// Add methods
void saveCutPlan();
void loadCutPlan(const CutPlanRecord& record);  // from Phase 7
```

### Task 2: Implement Save/Load in CutOptimizerPanel toolbar

**cut_optimizer_panel.cpp — renderToolbar():**
After the existing "Run" button, add:

```cpp
// Save button — enabled when we have results
if (!m_hasResults) ImGui::BeginDisabled();
if (ImGui::Button("Save")) {
    ImGui::OpenPopup("Save Cut Plan");
}
if (!m_hasResults) ImGui::EndDisabled();

ImGui::SameLine();

// Load button — show list of saved plans
if (ImGui::Button("Load")) {
    ImGui::OpenPopup("Load Cut Plan");
}

// Save popup
if (ImGui::BeginPopup("Save Cut Plan")) {
    static char planName[128] = {};
    ImGui::InputText("Name", planName, sizeof(planName));
    if (ImGui::Button("Save") && planName[0] != '\0') {
        saveCutPlan(planName);
        planName[0] = '\0';
        ImGui::CloseCurrentPopup();
    }
    ImGui::SameLine();
    if (ImGui::Button("Cancel")) {
        ImGui::CloseCurrentPopup();
    }
    ImGui::EndPopup();
}

// Load popup
if (ImGui::BeginPopup("Load Cut Plan")) {
    auto plans = m_cutPlanRepo ? m_cutPlanRepo->findAll() : std::vector<CutPlanRecord>{};
    if (plans.empty()) {
        ImGui::TextDisabled("No saved plans");
    } else {
        for (const auto& plan : plans) {
            std::string label = plan.name + " (" +
                std::to_string(plan.sheetsUsed) + " sheets, " +
                std::to_string(static_cast<int>(plan.efficiency * 100)) + "%)";
            if (ImGui::Selectable(label.c_str())) {
                loadCutPlan(plan);
                ImGui::CloseCurrentPopup();
            }
        }
    }
    ImGui::EndPopup();
}
```

### Task 3: Implement saveCutPlan()

```cpp
void CutOptimizerPanel::saveCutPlan(const char* name) {
    if (!m_cutPlanRepo || !m_hasResults) return;

    CutPlanRecord record;
    record.name = name;
    record.algorithm = (m_algorithm == optimizer::Algorithm::Guillotine)
        ? "guillotine" : "first_fit_decreasing";
    record.sheetConfigJson = CutPlanRepository::sheetToJson(m_sheet);
    record.partsJson = CutPlanRepository::partsToJson(m_parts);
    record.resultJson = CutPlanRepository::cutPlanToJson(m_result);
    record.allowRotation = m_allowRotation;
    record.kerf = m_kerf;
    record.margin = m_margin;
    record.sheetsUsed = m_result.sheetsUsed;
    record.efficiency = m_result.overallEfficiency();

    // Link to current project if one is open
    if (m_projectManager && m_projectManager->currentProject()) {
        record.projectId = m_projectManager->currentProject()->id();
    }

    auto id = m_cutPlanRepo->insert(record);
    if (id) {
        m_loadedPlanId = *id;
        ToastManager::instance().show(ToastType::Success,
            "Saved", "Cut plan saved");
    }
}
```

### Task 4: Implement loadCutPlan()

```cpp
void CutOptimizerPanel::loadCutPlan(const CutPlanRecord& record) {
    m_sheet = CutPlanRepository::jsonToSheet(record.sheetConfigJson);
    m_parts = CutPlanRepository::jsonToParts(record.partsJson);
    m_result = CutPlanRepository::jsonToCutPlan(record.resultJson);
    m_hasResults = true;
    m_loadedPlanId = record.id;
    m_allowRotation = record.allowRotation;
    m_kerf = record.kerf;
    m_margin = record.margin;
    m_algorithm = (record.algorithm == "guillotine")
        ? optimizer::Algorithm::Guillotine
        : optimizer::Algorithm::FirstFitDecreasing;
}
```

### Task 5: Add G-code "Add to Project" in GCodePanel

**gcode_panel.h:**
```cpp
// Add members
GCodeRepository* m_gcodeRepo = nullptr;
ProjectManager* m_projectManager = nullptr;
i64 m_currentGCodeId = -1;

// Add setters
void setGCodeRepository(GCodeRepository* repo);
void setProjectManager(ProjectManager* pm);
```

**gcode_panel.cpp — renderToolbar():**
After existing toolbar buttons:

```cpp
if (m_projectManager && m_projectManager->currentProject() && m_currentGCodeId > 0) {
    ImGui::SameLine();
    bool alreadyInProject = m_gcodeRepo &&
        m_gcodeRepo->isInProject(m_projectManager->currentProject()->id(), m_currentGCodeId);
    if (alreadyInProject) {
        ImGui::BeginDisabled();
        ImGui::Button("In Project");
        ImGui::EndDisabled();
    } else {
        if (ImGui::Button("Add to Project")) {
            m_gcodeRepo->addToProject(
                m_projectManager->currentProject()->id(), m_currentGCodeId);
            ToastManager::instance().show(ToastType::Success,
                "Added", "G-code added to project");
        }
    }
}
```

**gcode_panel.cpp — loadFile():**
After successfully loading a gcode file, look up its database ID:

```cpp
// After parsing succeeds, look up or create gcode record
if (m_gcodeRepo) {
    auto existing = m_gcodeRepo->findByName(/* filename from path */);
    if (!existing.empty()) {
        m_currentGCodeId = existing.front().id;
    }
}
```

### Task 6: Wire dependencies in application_wiring.cpp

Inject the new dependencies:

```cpp
m_uiManager->cutOptimizerPanel()->setCutPlanRepository(m_cutPlanRepo.get());
m_uiManager->cutOptimizerPanel()->setProjectManager(m_projectManager.get());
m_uiManager->gcodePanel()->setGCodeRepository(m_gcodeRepo.get());
m_uiManager->gcodePanel()->setProjectManager(m_projectManager.get());
```

## Verification

1. `cmake --build build -j$(nproc)` — compiles cleanly
2. `build/tests/dw_tests` — all tests pass
3. Run optimizer → click Save → enter name → plan saved (toast confirms)
4. Click Load → see saved plan → click → parts/sheet/results restored
5. Load gcode file → "Add to Project" button appears → click → gcode appears in Project Panel
6. Save a cut plan with project open → appears in Project Panel Cut Plans section

## Files Modified

| File | Change |
|------|--------|
| `src/ui/panels/cut_optimizer_panel.h` | Add repo/pm pointers, save/load methods |
| `src/ui/panels/cut_optimizer_panel.cpp` | Save/Load UI, saveCutPlan(), loadCutPlan() |
| `src/ui/panels/gcode_panel.h` | Add repo/pm, currentGCodeId |
| `src/ui/panels/gcode_panel.cpp` | "Add to Project" button, ID tracking |
| `src/app/application_wiring.cpp` | Wire new dependencies |

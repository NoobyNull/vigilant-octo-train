---
phase: 05-project-export
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - src/managers/file_io_manager.h
  - src/managers/file_io_manager.cpp
  - src/ui/panels/project_panel.h
  - src/ui/panels/project_panel.cpp
  - src/app/application.h
  - src/app/application.cpp
autonomous: false
requirements: [EXPORT-01, EXPORT-02]

must_haves:
  truths:
    - "User can click an Export button in the ProjectPanel to export the current project as .dwproj"
    - "Export progress is visible via ProgressDialog and does not block the UI"
    - "User can import a .dwproj file via File menu or drag-and-drop"
    - "After import, the imported project is opened and its models appear in the library"
  artifacts:
    - path: "src/managers/file_io_manager.h"
      provides: "exportProjectArchive() and importProjectArchive() methods"
    - path: "src/ui/panels/project_panel.cpp"
      provides: "Export .dwproj button in project info section"
      contains: "Export .dwproj"
    - path: "src/app/application.h"
      provides: "ProjectExportManager owned by Application"
      contains: "ProjectExportManager"
  key_links:
    - from: "src/ui/panels/project_panel.cpp"
      to: "src/managers/file_io_manager.h"
      via: "export callback invocation"
      pattern: "ExportProjectCallback|m_exportProjectCallback"
    - from: "src/managers/file_io_manager.cpp"
      to: "src/core/export/project_export_manager.h"
      via: "delegation to ProjectExportManager"
      pattern: "m_projectExportManager->exportProject|m_projectExportManager->importProject"
    - from: "src/managers/file_io_manager.cpp"
      to: "src/ui/dialogs/progress_dialog.h"
      via: "progress reporting during export/import"
      pattern: "ProgressDialog|m_progressDialog"
---

<objective>
Wire ProjectExportManager into the UI layer so users can export and import .dwproj archives with visible progress.

Purpose: The core export/import logic from Plan 01 needs UI entry points — an Export button in ProjectPanel, import via file dialog, progress feedback via ProgressDialog, and ownership in Application.

Output: Modified `file_io_manager`, `project_panel`, and `application` files with full export/import UI flow.
</objective>

<context>
@.planning/ROADMAP.md
@.planning/phases/05-project-export/05-01-SUMMARY.md
@src/core/export/project_export_manager.h (created in Plan 01)
@src/managers/file_io_manager.h
@src/managers/file_io_manager.cpp
@src/ui/panels/project_panel.h
@src/ui/panels/project_panel.cpp
@src/ui/dialogs/progress_dialog.h (thread-safe progress dialog)
@src/ui/dialogs/progress_dialog.cpp
@src/app/application.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire ProjectExportManager into Application and FileIOManager</name>
  <files>
    src/app/application.h
    src/app/application.cpp
    src/managers/file_io_manager.h
    src/managers/file_io_manager.cpp
  </files>
  <action>
**application.h changes:**
- Add forward declaration: `class ProjectExportManager;`
- Add member: `std::unique_ptr<ProjectExportManager> m_projectExportManager;`

**application.cpp changes:**
- `#include "core/export/project_export_manager.h"`
- In `init()`, after Database is initialized: construct `m_projectExportManager = std::make_unique<ProjectExportManager>(*m_database);`
- Pass `m_projectExportManager.get()` to FileIOManager constructor (add parameter).

**file_io_manager.h changes:**
- Add forward declaration: `class ProjectExportManager;` and `class ProgressDialog;`
- Add constructor parameter: `ProjectExportManager* projectExportManager`
- Add member: `ProjectExportManager* m_projectExportManager;`
- Add member: `ProgressDialog* m_progressDialog = nullptr;`
- Add setter: `void setProgressDialog(ProgressDialog* dialog) { m_progressDialog = dialog; }`
- Add two new public methods:
  ```cpp
  void exportProjectArchive();     // Shows save dialog, exports current project
  void importProjectArchive(std::function<void(bool)> setShowStartPage);  // Shows open dialog, imports .dwproj
  ```

**file_io_manager.cpp changes:**
- `#include "core/export/project_export_manager.h"`
- `#include "ui/dialogs/progress_dialog.h"`
- Store `m_projectExportManager` in constructor initializer list.

- Implement `exportProjectArchive()`:
  1. Check `m_projectManager->currentProject()` exists, show warning if not.
  2. Show save file dialog with filter `"*.dwproj"` and default name `project->name() + ".dwproj"`.
  3. In the dialog callback, run export on the ThreadPool (use `std::thread` for simplicity since this is a one-off operation):
     a. If `m_progressDialog`, call `m_progressDialog->start("Exporting Project...", modelCount, true)`.
     b. Call `m_projectExportManager->exportProject(project, path, progressCallback)` where progressCallback calls `m_progressDialog->advance(itemName)` and checks `m_progressDialog->isCancelled()`.
     c. On completion, call `m_progressDialog->finish()`.
     d. Show toast on success ("Project exported to <filename>") or error.
  4. The export runs in a detached thread. Use MainThreadQueue to post toast/finish calls back to the main thread.

- Implement `importProjectArchive()`:
  1. Show open file dialog with filter `"*.dwproj"`.
  2. In callback, similar async pattern:
     a. Start progress dialog.
     b. Call `m_projectExportManager->importProject(path, progressCallback)`.
     c. On success, open the imported project via `m_projectManager->open(newProjectId)` and `setCurrentProject()`.
     d. Post toast and library refresh back to main thread.
     e. Call `setShowStartPage(false)`.

- Also update `onFilesDropped()` to detect `.dwproj` extension and route to `importProjectArchive()` logic instead of the model import queue.

**Constructor update in application.cpp:**
Update FileIOManager construction to pass `m_projectExportManager.get()`.
  </action>
  <verify>
Run `cmake --build build --target digital_workshop 2>&1 | tail -20` — builds cleanly with no errors or warnings in modified files.
  </verify>
  <done>
Application owns ProjectExportManager. FileIOManager has exportProjectArchive() and importProjectArchive() methods that delegate to ProjectExportManager with progress reporting via ProgressDialog. Drag-and-drop of .dwproj files triggers import.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Export button to ProjectPanel and wire import to File menu</name>
  <files>
    src/ui/panels/project_panel.h
    src/ui/panels/project_panel.cpp
  </files>
  <action>
**project_panel.h changes:**
- Add callback type: `using ExportProjectCallback = std::function<void()>;`
- Add setter: `void setExportProjectCallback(ExportProjectCallback cb) { m_exportProjectCallback = std::move(cb); }`
- Add member: `ExportProjectCallback m_exportProjectCallback;`

**project_panel.cpp changes in `renderProjectInfo()`:**
After the existing "Save" and "Close" buttons, add an "Export .dwproj" button:

```cpp
// Export button — only enabled when project has models
if (ImGui::GetContentRegionAvail().x > 100.0f) {
    ImGui::SameLine();
}

bool hasModels = !project->modelIds().empty();
if (!hasModels) ImGui::BeginDisabled();
if (ImGui::Button("Export .dwproj")) {
    if (m_exportProjectCallback) {
        m_exportProjectCallback();
    }
}
if (!hasModels) ImGui::EndDisabled();
if (!hasModels && ImGui::IsItemHovered(ImGuiHoveredFlags_AllowWhenDisabled)) {
    ImGui::SetTooltip("Add models to project before exporting");
}
```

The button should be visually distinct — place it after a small spacing or on a new line below Save/Close if the panel is narrow. Use the pattern already established with the Save/Close buttons for responsive wrapping.

**Wiring in application.cpp:**
In the section where ProjectPanel callbacks are set up (search for `setSaveProjectCallback` or `setOpenProjectCallback`), add:
```cpp
projectPanel->setExportProjectCallback([this]() {
    m_fileIOManager->exportProjectArchive();
});
```

**File menu import entry (in ui_manager.cpp or wherever the menu bar is rendered):**
Find the existing File menu rendering. Add a menu item "Import .dwproj..." that calls `m_fileIOManager->importProjectArchive(setShowStartPage)`. This follows the pattern of the existing "Import Model..." menu item.
  </action>
  <verify>
Build the application. Launch it. Verify:
1. With a project open that has models, the "Export .dwproj" button is visible and clickable.
2. With a project open that has NO models, the button is grayed out with tooltip.
3. File menu has "Import .dwproj..." entry.
  </verify>
  <done>
Export .dwproj button appears in ProjectPanel when a project is open. Button is disabled when project has no models. File menu has Import .dwproj entry. Both trigger the FileIOManager methods which show file dialogs and progress.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete .dwproj export/import flow: Export button in ProjectPanel, Import via File menu and drag-drop, progress dialog during operations, round-trip of project with models between export and import.</what-built>
  <how-to-verify>
    1. Launch Digital Workshop
    2. Open or create a project and add at least 2 models to it
    3. Click "Export .dwproj" button in the Project panel
    4. Choose a save location — observe progress dialog during export
    5. Verify the .dwproj file is created on disk
    6. Close the current project
    7. Use File > Import .dwproj... and select the exported file
    8. Observe progress dialog during import
    9. Verify the imported project opens with the same models and metadata
    10. Alternatively, drag the .dwproj file onto the application window to test drag-and-drop import
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Application compiles cleanly with ProjectExportManager ownership
2. Export .dwproj button visible in ProjectPanel (disabled when no models)
3. File menu has Import .dwproj entry
4. Export shows progress dialog and creates valid .dwproj file
5. Import shows progress dialog and creates project with all models
6. Drag-and-drop of .dwproj triggers import flow
7. Export progress does not block the UI (runs on background thread)
</verification>

<success_criteria>
- User can export current project to .dwproj via button click
- User can import .dwproj via File menu or drag-and-drop
- Progress is visible during both operations via ProgressDialog
- Export/import runs on background thread (UI remains responsive)
- Round-trip export then import preserves project name, model names, hashes, and metadata
</success_criteria>

<output>
After completion, create `.planning/phases/05-project-export/05-02-SUMMARY.md`
</output>

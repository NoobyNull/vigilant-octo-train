# Plan 17-01: Raster Scan Generation, Axis Selection, Stepover, Milling Direction

**Phase**: 17 — Toolpath Generation
**Requirements**: DC-14, DC-15, DC-16

## Overview

Generate raster scan toolpath lines from the heightmap. The operator selects scan axis, stepover percentage, and milling direction. The toolpath is a sequence of 3D points that will later be converted to G-code commands.

## New Files

### `src/core/carve/toolpath_types.h` (~60 lines)

```cpp
namespace dw {
namespace carve {

enum class ScanAxis {
    XOnly,     // Parallel lines along X
    YOnly,     // Parallel lines along Y
    XThenY,    // Two passes: X first, then Y
    YThenX     // Two passes: Y first, then X
};

enum class MillDirection {
    Climb,          // All lines in same direction
    Conventional,   // All lines in opposite direction
    Alternating     // Bidirectional (zigzag)
};

enum class StepoverPreset {
    UltraFine,  // 1% of tip diameter
    Fine,       // 8%
    Basic,      // 12%
    Rough,      // 25%
    Roughing    // 40%
};

struct ToolpathConfig {
    ScanAxis axis = ScanAxis::XOnly;
    MillDirection direction = MillDirection::Alternating;
    StepoverPreset stepoverPreset = StepoverPreset::Basic;
    f32 customStepoverPct = 0.0f;  // If non-zero, overrides preset
    f32 safeZMm = 5.0f;
    f32 feedRateMmMin = 1000.0f;
    f32 plungeRateMmMin = 300.0f;
};

// Single toolpath move
struct ToolpathPoint {
    Vec3 position;
    bool rapid = false;  // G0 (true) vs G1 (false)
};

// Complete toolpath
struct Toolpath {
    std::vector<ToolpathPoint> points;
    f32 totalDistanceMm = 0.0f;
    f32 estimatedTimeSec = 0.0f;
    int lineCount = 0;  // Number of G-code lines this will produce
};

// Convert preset to percentage
f32 stepoverPercent(StepoverPreset preset);

} // namespace carve
} // namespace dw
```

### `src/core/carve/toolpath_generator.h` (~50 lines)

```cpp
namespace dw {
namespace carve {

class ToolpathGenerator {
public:
    // Generate finishing toolpath from heightmap
    Toolpath generateFinishing(const Heightmap& heightmap,
                               const ToolpathConfig& config,
                               f32 toolTipDiameter);

    // Generate clearing toolpath for islands only
    Toolpath generateClearing(const Heightmap& heightmap,
                              const IslandResult& islands,
                              const ToolpathConfig& config,
                              f32 toolDiameter);

private:
    void generateScanLines(Toolpath& path,
                           const Heightmap& heightmap,
                           const ToolpathConfig& config,
                           f32 stepoverMm,
                           bool primaryAxis);  // true=X, false=Y

    void addRetract(Toolpath& path, f32 safeZ);
    void addRapidTo(Toolpath& path, const Vec3& pos);
    void addCutTo(Toolpath& path, const Vec3& pos);
};

} // namespace carve
} // namespace dw
```

### `src/core/carve/toolpath_generator.cpp` (~300 lines)

**generateFinishing()**:
1. Compute stepover: `toolTipDiameter * stepoverPercent(config.stepoverPreset) / 100.0f`
2. Based on ScanAxis:
   - XOnly: call `generateScanLines(path, hm, config, stepover, true)`
   - YOnly: call `generateScanLines(path, hm, config, stepover, false)`
   - XThenY: call both in sequence
   - YThenX: call both in reverse sequence
3. Compute totalDistanceMm and estimatedTimeSec

**generateScanLines()** (~45 lines):
1. Determine line count: `numLines = extent / stepoverMm`
2. For each scan line:
   - Compute line position along the non-scan axis
   - Determine direction based on MillDirection:
     - Climb: all lines scan in +direction
     - Conventional: all lines scan in -direction
     - Alternating: even lines +, odd lines -
   - Retract to safeZ
   - Rapid to start of line
   - For each point along line at heightmap resolution:
     - Read Z from heightmap (atMm with bilinear interpolation)
     - `addCutTo(path, {x, y, z})`

**stepoverPercent()** (~10 lines):
```cpp
f32 stepoverPercent(StepoverPreset preset) {
    switch (preset) {
        case StepoverPreset::UltraFine: return 1.0f;
        case StepoverPreset::Fine:      return 8.0f;
        case StepoverPreset::Basic:     return 12.0f;
        case StepoverPreset::Rough:     return 25.0f;
        case StepoverPreset::Roughing:  return 40.0f;
    }
    return 12.0f;
}
```

**estimateTime()** (~15 lines helper):
- Sum distances between consecutive points
- Rapid moves: distance / rapidRate
- Cut moves: distance / feedRate
- Add retract/plunge time

### Tests

`src/core/carve/toolpath_generator_test.cpp` (~200 lines):

- `TEST(ToolpathGen, FlatSurfaceXScan)` — flat heightmap produces parallel X lines at constant Z
- `TEST(ToolpathGen, StepoverSpacing)` — line spacing matches stepover percentage * tool diameter
- `TEST(ToolpathGen, AlternatingDirection)` — even lines go +X, odd go -X
- `TEST(ToolpathGen, ClimbDirection)` — all lines go same direction
- `TEST(ToolpathGen, XThenY)` — X lines followed by Y lines
- `TEST(ToolpathGen, SafeZRetract)` — retract between scan lines at safe Z height
- `TEST(ToolpathGen, StepoverPresets)` — each preset maps to correct percentage
- `TEST(ToolpathGen, TimeEstimation)` — estimated time proportional to distance / feed rate

## Coding Standards Compliance

- toolpath_generator.cpp ~300 lines (within 800)
- generateScanLines is the largest function at ~45 lines (within 50)
- Enums for axis/direction/preset (no magic strings or numbers)
- Config struct passed by const reference
- Toolpath is a plain data struct (no behavior)

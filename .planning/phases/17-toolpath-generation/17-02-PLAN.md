# Plan 17-02: Tool Offset Compensation, Safe Z, and Travel Limits

**Phase**: 17 — Toolpath Generation
**Requirements**: DC-17, DC-19

## Overview

Apply tool geometry offset to the heightmap Z values so the tool tip (not the tool center) contacts the surface. Enforce safe Z retract behavior between scan lines and validate all positions against machine travel limits.

## Modifications

### `src/core/carve/toolpath_generator.h` — Add offset helpers

```cpp
private:
    // Compute Z offset for tool geometry at given XY position
    f32 toolOffset(const Heightmap& heightmap,
                   f32 x, f32 y,
                   const VtdbToolGeometry& tool) const;

    // Validate toolpath against machine limits, return warnings
    std::vector<std::string> validateLimits(
        const Toolpath& path,
        f32 travelX, f32 travelY, f32 travelZ) const;
```

### `src/core/carve/toolpath_generator.cpp` — Tool offset implementation

**toolOffset()** (~35 lines):

For each toolpath point, the Z value must be adjusted so the tool tip contacts the heightmap surface, not the tool center.

**V-bit offset**:
- Tool center is above the contact point by: `r / tan(angle/2)` where `r` is the radius of curvature at that point
- For V-bits on slopes: sample heightmap in a circle of radius = tool contact radius
- Take the minimum Z from the surrounding samples to prevent gouging
- Simplified: at each point, check the 4/8 neighbors and ensure the tool cone doesn't intersect below any neighbor's Z

**Ball nose offset**:
- Tool center is above contact point by: `tipRadius - sqrt(tipRadius^2 - dx^2 - dy^2)` for nearby points
- Simplified: for each point, find the maximum Z from `heightmap(x+dx, y+dy) + sqrt(R^2 - dx^2 - dy^2)` for all points within radius R
- This is the "drop cutter" algorithm

**End mill offset**:
- Tool center is above the maximum Z within the tool radius circle
- `offsetZ = max(heightmap(x+dx, y+dy)) for all (dx,dy) within diameter/2`

**Safe Z enforcement** (in generateScanLines):
- Between scan lines: retract to safeZ, rapid to next line start, plunge at plunge rate
- At start of job: retract to safeZ first
- At end of job: retract to safeZ

**validateLimits()** (~20 lines):
- Check every toolpath point against machine travel:
  - `0 <= x <= travelX`
  - `0 <= y <= travelY`
  - `0 <= z <= travelZ`
- Collect unique warnings (first violation per axis)
- Return empty vector if all clear

### Update `generateFinishing()` signature

Add `const VtdbToolGeometry& tool` parameter so offset compensation can use tool geometry data (diameter, included_angle, tip_radius).

Add machine travel validation call after toolpath generation:
```cpp
path.warnings = validateLimits(path, machineProfile.maxTravelX, ...);
```

### `src/core/carve/toolpath_types.h` — Add warnings to Toolpath

```cpp
struct Toolpath {
    // ... existing members ...
    std::vector<std::string> warnings;  // Travel limit violations
};
```

### Tests

Add to `src/core/carve/toolpath_generator_test.cpp`:

- `TEST(ToolOffset, VBitFlatSurface)` — flat surface, V-bit offset is 0 (tip touches surface)
- `TEST(ToolOffset, BallNoseCompensation)` — ball nose Z is raised by tip radius on flat surface
- `TEST(ToolOffset, EndMillCompensation)` — end mill Z raised by max Z within radius
- `TEST(ToolOffset, NoGouging)` — V-bit on slope doesn't cut below intended surface
- `TEST(TravelLimits, WithinBounds)` — valid toolpath returns no warnings
- `TEST(TravelLimits, ExceedsBounds)` — out-of-bounds toolpath returns warnings per axis

## Coding Standards Compliance

- toolOffset delegates to type-specific helpers (vBitOffset, ballNoseOffset, endMillOffset)
- Each offset helper under 25 lines
- validateLimits is a pure check with no side effects
- Warnings as strings, not error codes (user-facing messages)

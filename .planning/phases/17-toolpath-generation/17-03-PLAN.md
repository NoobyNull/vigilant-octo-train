# Plan 17-03: Surgical Island Clearing Pass Generation

**Phase**: 17 — Toolpath Generation
**Requirements**: DC-18

## Overview

Generate clearing passes that only cover identified island regions, not the entire model surface. The clearing tool removes material from enclosed depressions so the finishing tool can access all geometry.

## Modifications

### `src/core/carve/toolpath_generator.cpp` — Implement generateClearing()

**generateClearing()** (~40 lines):

1. For each island in `IslandResult`:
   - Get island bounding box (boundsMin, boundsMax) + clearing tool radius margin
   - Compute clearing stepover: `toolDiameter * 0.4` (40% for roughing)
   - Generate raster scan lines covering only the island bounding box
   - For each point along scan lines:
     - Check if point is within the island mask (`islandMask[r * cols + c] == island.id`)
     - If in island: cut to clearing depth (island.maxZ - margin)
     - If not in island: skip (rapid over)
   - Retract between islands

**clearIslandRegion()** (~35 lines, new private helper):

For a single island:
1. Determine clearing depth levels:
   - If island depth > toolDiameter: use multiple depth passes (stepdown)
   - Each pass at `stepdown` intervals until final depth
2. For each depth level:
   - Generate raster scan lines within island bounds
   - At each XY, check island mask membership
   - Cut to current depth level if in island, skip if not
   - Add lead-in/lead-out when entering/exiting island boundary
3. Final pass at full depth with finishing stepover

**Lead-in/lead-out** behavior:
- When scan line enters island boundary: ramp down over 2mm distance instead of plunging
- When scan line exits island boundary: ramp up over 2mm to avoid tool mark
- Between non-contiguous island cells on same scan line: retract to safeZ, rapid, plunge

### Combine finishing and clearing

Add to `toolpath_types.h`:

```cpp
struct MultiPassToolpath {
    Toolpath clearing;   // Run first (if needed)
    Toolpath finishing;   // Run second
    f32 totalTimeSec = 0.0f;
    int totalLineCount = 0;
};
```

### Tests

Add to `src/core/carve/toolpath_generator_test.cpp`:

- `TEST(ClearingPass, SingleIsland)` — clearing covers only island area, not surrounding surface
- `TEST(ClearingPass, DeepIslandMultiPass)` — deep island generates multiple depth passes
- `TEST(ClearingPass, NoIslandsNoClearingPath)` — empty island list produces empty clearing toolpath
- `TEST(ClearingPass, RampEntry)` — tool ramps into island boundary rather than plunging
- `TEST(ClearingPass, MultipleIslands)` — each island cleared independently with retract between

## Coding Standards Compliance

- generateClearing delegates to clearIslandRegion per island
- clearIslandRegion ~35 lines (within 50 limit)
- MultiPassToolpath is a plain struct grouping two Toolpath objects
- No full-surface clearing — only island cells are cut (key requirement)
- Lead-in distance is from config, not hardcoded

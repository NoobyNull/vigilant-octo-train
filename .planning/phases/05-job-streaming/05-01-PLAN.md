---
phase: 05-job-streaming
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/panels/cnc_job_panel.h
  - src/ui/panels/cnc_job_panel.cpp
  - src/ui/panels/cnc_tool_panel.h
  - src/core/cnc/cnc_types.h
autonomous: true
requirements: [TAC-05, TAC-06, TAC-07, TAC-08]

must_haves:
  truths:
    - During streaming, elapsed time displays in HH:MM:SS format and updates every second
    - Current line number and total line count are displayed (e.g., "142 / 1200")
    - Progress percentage is displayed as both text and a visual progress bar
    - Estimated remaining time adjusts dynamically based on recent line completion rate, not a fixed initial estimate
    - When not streaming, the panel shows "No job running" or similar placeholder
  artifacts:
    - src/ui/panels/cnc_job_panel.h
    - src/ui/panels/cnc_job_panel.cpp
  key_links:
    - CncJobPanel receives StreamProgress via callback from CncController
    - CncJobPanel receives MachineStatus via callback for feed rate display
    - CncToolPanel exposes recommended feed rate for Plan 05-02
---

<objective>
Create CncJobPanel with job progress display: elapsed time, remaining time, line counts, and progress percentage.

Purpose: Operator needs full visibility into job progress during G-code streaming. This panel provides all timing and progress information at a glance.
Output: New CncJobPanel class with progress rendering, plus CncToolPanel getter for recommended feed rate.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-job-streaming/05-RESEARCH.md

@src/core/cnc/cnc_types.h
@src/core/cnc/cnc_controller.h
@src/ui/panels/cnc_status_panel.h
@src/ui/panels/cnc_status_panel.cpp
@src/ui/panels/cnc_tool_panel.h
@src/ui/panels/gcode_panel.cpp
@src/ui/panels/panel.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CncJobPanel header and implementation with progress display</name>
  <files>
    src/ui/panels/cnc_job_panel.h
    src/ui/panels/cnc_job_panel.cpp
  </files>
  <action>
Create a new `CncJobPanel` class inheriting from `Panel`, following the exact pattern established by `CncStatusPanel`.

**Header (cnc_job_panel.h):**
- Include `cnc_types.h` and `panel.h`
- Forward declare `CncToolPanel`
- Public interface:
  - `void render() override`
  - `void onStatusUpdate(const MachineStatus& status)` — receives 5Hz GRBL status
  - `void onProgressUpdate(const StreamProgress& progress)` — receives line ack updates
  - `void setStreaming(bool streaming)` — called when streaming starts/stops
  - `void setRecommendedFeedRate(float rate)` — receives recommended feed from calculator (used by Plan 05-02)
- Private members:
  - `MachineStatus m_status{}`
  - `StreamProgress m_progress{}`
  - `bool m_streaming = false`
  - `float m_recommendedFeedRate = 0.0f` — stored for Plan 05-02
  - `float m_feedDeviation = 0.0f` — stored for Plan 05-02
  - `bool m_feedDeviationWarning = false` — stored for Plan 05-02
- Private render methods: `renderProgressBar()`, `renderTimeInfo()`, `renderLineInfo()`, `renderFeedDeviation()` (placeholder for Plan 05-02)

**Implementation (cnc_job_panel.cpp):**

`render()`:
- If not streaming AND progress.totalLines == 0: show "No active job" with TextDisabled
- Otherwise: render all sections

`renderProgressBar()`:
- Calculate fraction: `ackedLines / totalLines`
- Use `ImGui::ProgressBar(fraction, ImVec2(-1, 0), overlay)` with overlay showing percentage
- Below the bar, show percentage as colored text: green for >75%, yellow for 25-75%, white for <25%

`renderLineInfo()`:
- Display: "Line: {ackedLines} / {totalLines}" using `SeparatorText("Progress")`
- Show errors if errorCount > 0 in red

`renderTimeInfo()`:
- Display elapsed time formatted with a helper function:
  ```cpp
  static std::string formatTime(float seconds) {
      int h = (int)(seconds / 3600);
      int m = (int)(seconds / 60) % 60;
      int s = (int)(seconds) % 60;
      if (h > 0) return fmt::format("{}:{:02d}:{:02d}", h, m, s);
      return fmt::format("{:02d}:{:02d}", m, s);
  }
  ```
  Use `snprintf` not fmt (project uses snprintf pattern, not fmt library).
- Calculate remaining time using blended rate estimation:
  - If ackedLines < 5 or elapsed < 3.0f: show "Calculating..." instead of a potentially wild estimate
  - Otherwise: `rate = ackedLines / elapsed; eta = (totalLines - ackedLines) / rate`
  - Format ETA same way as elapsed
- Display: "Elapsed: HH:MM:SS" and "Remaining: ~HH:MM:SS"
- Use `ImGui::SeparatorText("Time")` header

`renderFeedDeviation()`:
- For now, just a placeholder comment `// Feed deviation warning rendered by Plan 05-02`
- No rendering in this plan — the member variables are in place for Plan 05-02 to use

Panel title: "Job Progress"
  </action>
  <verify>
  - File compiles: add to CMakeLists.txt source list, run `cmake --build build --target dw 2>&1 | head -50`
  - Class follows Panel pattern (inherits Panel, has render(), constructor sets title)
  - Time formatting produces correct output for 0s, 65s, 3723s
  </verify>
  <done>
  CncJobPanel exists with progress bar, line counts, elapsed time, and remaining time estimate. Compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expose recommended feed rate from CncToolPanel</name>
  <files>
    src/ui/panels/cnc_tool_panel.h
  </files>
  <action>
Add a public getter to `CncToolPanel` so the job panel (and wiring code) can read the recommended feed rate:

```cpp
// Public getter for recommended feed rate (used by CncJobPanel for deviation comparison)
float getRecommendedFeedRate() const {
    return m_hasCalcResult ? static_cast<float>(m_calcResult.feed_rate) : 0.0f;
}
bool hasCalcResult() const { return m_hasCalcResult; }
```

Add these as inline methods in the header. No .cpp changes needed.

Also add a getter for the full CalcResult in case Plan 05-02 needs more data:
```cpp
const CalcResult& getCalcResult() const { return m_calcResult; }
```
  </action>
  <verify>
  - Compiles with no errors
  - Getters return correct values (0.0f when no result, actual feed_rate when result exists)
  </verify>
  <done>
  CncToolPanel exposes recommended feed rate and calc result for downstream consumers.
  </done>
</task>

</tasks>

<verification>
- CncJobPanel compiles and renders without crashes
- Progress bar shows correct fraction
- Line count display shows "ackedLines / totalLines" format
- Elapsed time formats correctly for seconds, minutes, hours
- Remaining time shows "Calculating..." for first few lines, then a reasonable estimate
- No feed deviation rendering yet (deferred to Plan 05-02)
- CncToolPanel getters compile and are accessible
</verification>

<success_criteria>
- CncJobPanel class created following project Panel pattern
- All four display elements present: elapsed time (TAC-05), remaining time (TAC-06), line counts (TAC-07), progress percentage (TAC-08)
- Time estimation uses line completion rate that naturally adjusts with feed rate changes
- CncToolPanel exposes recommended feed rate for Plan 05-02
- All files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-job-streaming/05-01-SUMMARY.md`
</output>

---
phase: 05-job-streaming
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - src/ui/panels/cnc_job_panel.h
  - src/ui/panels/cnc_job_panel.cpp
  - src/managers/ui_manager.h
  - src/managers/ui_manager.cpp
  - src/app/application_wiring.cpp
autonomous: true
requirements: [TAC-04]

must_haves:
  truths:
    - During streaming, when actual feed rate deviates >20% from calculator recommendation, a visual warning appears
    - Feed deviation warning accounts for feed override percentage (50% override = 50% of recommended is normal)
    - Feed deviation warning only appears during MachineState::Run (not during idle, hold, or jog)
    - CncJobPanel is visible in the CNC workspace mode alongside other CNC panels
    - CncJobPanel receives streaming progress and machine status updates via application wiring
    - CncToolPanel calculator result changes propagate to CncJobPanel's recommended feed rate
  artifacts:
    - src/ui/panels/cnc_job_panel.h (updated with feed deviation rendering)
    - src/ui/panels/cnc_job_panel.cpp (updated with feed deviation logic)
    - src/managers/ui_manager.h (CncJobPanel added)
    - src/managers/ui_manager.cpp (CncJobPanel instantiated and rendered)
    - src/app/application_wiring.cpp (CncJobPanel wired to callbacks)
  key_links:
    - CncJobPanel wired into CncCallbacks alongside existing panels in application_wiring.cpp
    - CncJobPanel registered in UIManager for CNC workspace rendering
    - Feed deviation compares MachineStatus.feedRate against CncToolPanel.getRecommendedFeedRate()
---

<objective>
Add feed deviation warning to CncJobPanel and wire the panel into UIManager + application callbacks.

Purpose: Operator sees a clear visual warning when actual cutting feed rate deviates significantly from the calculator's recommendation, enabling real-time correction. Panel integration makes it accessible in the CNC workspace.
Output: Complete CncJobPanel with feed deviation, fully wired into the application.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-job-streaming/05-RESEARCH.md
@.planning/phases/05-job-streaming/05-01-SUMMARY.md

@src/ui/panels/cnc_job_panel.h
@src/ui/panels/cnc_job_panel.cpp
@src/ui/panels/cnc_tool_panel.h
@src/ui/panels/cnc_status_panel.h
@src/managers/ui_manager.h
@src/managers/ui_manager.cpp
@src/app/application_wiring.cpp
@src/ui/icons.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement feed deviation detection and warning display</name>
  <files>
    src/ui/panels/cnc_job_panel.h
    src/ui/panels/cnc_job_panel.cpp
  </files>
  <action>
Update the CncJobPanel to implement feed deviation detection and render warnings.

**In onStatusUpdate():**
Add feed deviation check logic:
```cpp
void CncJobPanel::onStatusUpdate(const MachineStatus& status) {
    m_status = status;

    // Feed deviation check — only meaningful during Run state while streaming
    if (m_streaming && m_recommendedFeedRate > 0.0f &&
        status.state == MachineState::Run && status.feedRate > 0.0f) {
        // Account for feed override: if user set 50% override,
        // the expected feed is 50% of recommended
        float effectiveRecommended = m_recommendedFeedRate *
            (static_cast<float>(status.feedOverride) / 100.0f);

        if (effectiveRecommended > 0.0f) {
            m_feedDeviation = std::abs(status.feedRate - effectiveRecommended) / effectiveRecommended;
            m_feedDeviationWarning = (m_feedDeviation > 0.20f);
        }
    } else {
        // Not in a state where deviation is meaningful
        m_feedDeviation = 0.0f;
        m_feedDeviationWarning = false;
    }
}
```

**Implement renderFeedDeviation():**
Replace the placeholder with actual rendering:
```cpp
void CncJobPanel::renderFeedDeviation() {
    if (m_recommendedFeedRate <= 0.0f) {
        ImGui::TextDisabled("No calculator recommendation — select tool + material");
        return;
    }

    ImGui::SeparatorText("Feed Rate");

    // Show actual vs recommended
    float actual = m_status.feedRate;
    float recommended = m_recommendedFeedRate;
    float effectiveRecommended = recommended * (static_cast<float>(m_status.feedOverride) / 100.0f);

    ImGui::Text("Actual:");
    ImGui::SameLine(120);
    ImGui::Text("%.0f mm/min", static_cast<double>(actual));

    ImGui::Text("Recommended:");
    ImGui::SameLine(120);
    ImGui::Text("%.0f mm/min", static_cast<double>(recommended));

    // Show override-adjusted if override != 100%
    if (m_status.feedOverride != 100) {
        ImGui::Text("Adjusted:");
        ImGui::SameLine(120);
        ImGui::TextDisabled("%.0f mm/min (%d%% override)",
            static_cast<double>(effectiveRecommended), m_status.feedOverride);
    }

    // Deviation display
    if (m_streaming && m_status.state == MachineState::Run && actual > 0.0f) {
        float deviationPct = m_feedDeviation * 100.0f;

        if (m_feedDeviationWarning) {
            // Red warning for >20% deviation
            ImGui::Spacing();
            ImVec4 warningColor(1.0f, 0.3f, 0.3f, 1.0f);
            ImGui::TextColored(warningColor, "%s Feed Deviation: %.0f%%",
                Icons::Warning, static_cast<double>(deviationPct));

            // Add a colored background highlight for visibility
            ImVec2 min = ImGui::GetItemRectMin();
            ImVec2 max = ImGui::GetItemRectMax();
            min.x -= 4.0f; min.y -= 2.0f;
            max.x += 4.0f; max.y += 2.0f;
            ImGui::GetWindowDrawList()->AddRectFilled(
                min, max, IM_COL32(255, 60, 60, 40), 3.0f);
        } else {
            // Normal — green indicator
            ImGui::TextColored(ImVec4(0.3f, 0.8f, 0.3f, 1.0f),
                "Deviation: %.0f%% (OK)", static_cast<double>(deviationPct));
        }
    } else if (!m_streaming) {
        ImGui::TextDisabled("Start a job to see feed comparison");
    }
}
```

Update the `render()` method to call `renderFeedDeviation()` after the progress/time sections.

Also add `#include <cmath>` for `std::abs` if not already included, and ensure `Icons::Warning` is used (check icons.h for the correct icon constant — may be `Icons::ExclamationTriangle` or similar; use whatever warning icon is defined).

**Add setStreaming() implementation** if not already implemented:
When streaming starts, reset deviation state. When streaming stops, clear warning.
  </action>
  <verify>
  - Compiles without errors
  - Feed deviation calculation: abs(800 - 1000) / 1000 = 0.2 = 20% (at threshold)
  - Feed deviation calculation: abs(750 - 1000) / 1000 = 0.25 = 25% (warning triggered)
  - Override adjustment: 1000 recommended * 50% override = 500 effective, actual 500 = 0% deviation (correct)
  </verify>
  <done>
  Feed deviation detection works correctly, accounting for feed override percentage. Visual warning appears as red text with highlight when deviation exceeds 20%.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire CncJobPanel into UIManager and application callbacks</name>
  <files>
    src/managers/ui_manager.h
    src/managers/ui_manager.cpp
    src/app/application_wiring.cpp
  </files>
  <action>
**UIManager integration (follow exact pattern of CncStatusPanel / CncToolPanel):**

In `ui_manager.h`:
- Add forward declaration: `class CncJobPanel;`
- Add member: `std::unique_ptr<CncJobPanel> m_cncJobPanel;`
- Add accessor: `CncJobPanel* cncJobPanel() { return m_cncJobPanel.get(); }`
- Add show toggle: `bool m_showCncJob = false;` (or use existing workspace mode pattern)

In `ui_manager.cpp`:
- Include: `#include "ui/panels/cnc_job_panel.h"`
- In the constructor/init section where other CNC panels are created (near line 76-80 area where `m_cncStatusPanel = std::make_unique<CncStatusPanel>()`):
  Add `m_cncJobPanel = std::make_unique<CncJobPanel>();`
- In the destroy/reset section (near line 149-153):
  Add `m_cncJobPanel.reset();`
- In the render section where CNC panels render (near line 328-365 area):
  Add rendering block following the same pattern:
  ```cpp
  if (m_showCncJob && m_cncJobPanel) {
      m_cncJobPanel->render();
      if (!m_cncJobPanel->isOpen()) {
          m_showCncJob = false;
          m_cncJobPanel->setOpen(true);
      }
  }
  ```
- In the CNC workspace mode activation (search for where `m_showCncStatus` is set to true):
  Add `m_showCncJob = true;`

**Application wiring (application_wiring.cpp):**

Add `#include "ui/panels/cnc_job_panel.h"` to includes.

In `initWiring()`, in the CNC callback wiring section (around line 545-588):
1. Get the job panel pointer:
   ```cpp
   auto* jobp = m_uiManager->cncJobPanel();
   ```
2. Add to `onStatusUpdate` lambda:
   ```cpp
   if (jobp) jobp->onStatusUpdate(status);
   ```
3. Add to `onProgressUpdate` lambda:
   ```cpp
   if (jobp) jobp->onProgressUpdate(progress);
   ```
4. After streaming starts (find where `startStream` is called, likely in `GCodePanel::buildSendProgram()`):
   - This requires adding a callback or having the wiring set streaming state
   - Alternative: In the `onProgressUpdate` callback, detect streaming state from progress.totalLines > 0 && progress.ackedLines < progress.totalLines
   - Simplest approach: `if (jobp) jobp->setStreaming(true)` when progress is received with totalLines > 0, and `setStreaming(false)` when ackedLines >= totalLines or on disconnect
5. Wire recommended feed rate: After the CncToolPanel wiring (around line 595-598), add:
   ```cpp
   if (auto* ctp = m_uiManager->cncToolPanel()) {
       if (auto* jobp2 = m_uiManager->cncJobPanel()) {
           // Push recommended feed rate when tool panel recalculates
           // For now, update on each status update since recalculation is infrequent
       }
   }
   ```

   For connecting calculator results to the job panel, the cleanest approach: In the onStatusUpdate callback (which fires at 5Hz), also push the current recommended feed rate:
   ```cpp
   cncCb.onStatusUpdate = [gcp, csp, jogp, wcsp, jobp, ctp](const MachineStatus& status) {
       gcp->onGrblStatus(status);
       if (csp) csp->onStatusUpdate(status);
       if (jogp) jogp->onStatusUpdate(status);
       if (wcsp) wcsp->onStatusUpdate(status);
       if (jobp) {
           jobp->onStatusUpdate(status);
           // Update recommended feed rate from calculator
           if (ctp && ctp->hasCalcResult())
               jobp->setRecommendedFeedRate(ctp->getRecommendedFeedRate());
       }
   };
   ```

6. Wire progress update with streaming state detection:
   ```cpp
   cncCb.onProgressUpdate = [gcp, jobp](const StreamProgress& progress) {
       gcp->onGrblProgress(progress);
       if (jobp) {
           jobp->onProgressUpdate(progress);
           // Detect streaming state from progress
           bool streaming = (progress.totalLines > 0 && progress.ackedLines < progress.totalLines);
           jobp->setStreaming(streaming);
       }
   };
   ```

7. On disconnect, clear job panel state:
   ```cpp
   cncCb.onConnectionChanged = [gcp, csp, jogp, conp, wcsp, jobp](bool connected, const std::string& version) {
       // ... existing wiring ...
       if (jobp && !connected) jobp->setStreaming(false);
   };
   ```

Also add the `CncJobPanel` to the CMakeLists.txt source list if not already done in Plan 05-01.
  </action>
  <verify>
  - Full application compiles: `cmake --build build --target dw 2>&1 | tail -20`
  - CncJobPanel appears in CNC workspace mode
  - Callbacks are wired (search application_wiring.cpp for "jobp" references)
  - UIManager has accessor and renders the panel
  </verify>
  <done>
  CncJobPanel is fully integrated: appears in CNC workspace, receives status and progress callbacks, displays feed deviation warning when >20% with override adjustment, and clears on disconnect.
  </done>
</task>

</tasks>

<verification>
- Application compiles and runs without crashes
- CncJobPanel visible in CNC workspace mode
- During simulated streaming: progress bar, line counts, elapsed time, remaining time all update
- Feed deviation shows "No calculator recommendation" when no tool/material selected
- Feed deviation shows actual vs recommended when calculator has result
- Feed deviation warning (red) appears when deviation exceeds 20%
- Feed override is correctly factored in (50% override with 50% of recommended feed = no warning)
- Warning only shows during MachineState::Run, not during idle/hold
- Disconnect clears streaming state and warnings
</verification>

<success_criteria>
- TAC-04 complete: Feed deviation warning with 20% threshold, visual red highlight, override-aware
- CncJobPanel fully wired into application via UIManager and CncCallbacks
- All five requirements (TAC-04 through TAC-08) functional when both plans are complete
- No regression in existing CNC panel functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-job-streaming/05-02-SUMMARY.md`
</output>

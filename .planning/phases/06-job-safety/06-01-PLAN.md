---
phase: 06-job-safety
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/core/gcode/gcode_modal_scanner.h
  - src/core/gcode/gcode_modal_scanner.cpp
  - tests/core/gcode/test_gcode_modal_scanner.cpp
  - src/CMakeLists.txt
  - tests/CMakeLists.txt
autonomous: true
requirements: [SAF-05]

must_haves:
  truths:
    - "Scanner produces correct modal state preamble for any given line number"
    - "Scanner tracks G90/G91, G54-G59, G20/G21, M3/M4/M5, M7/M8/M9, F, S values"
    - "Scanner handles comments, blank lines, lowercase, multiple codes per line"
    - "Preamble restores machine state in correct order (units first, then WCS, then distance mode)"
  artifacts:
    - path: "src/core/gcode/gcode_modal_scanner.h"
      provides: "ModalState struct and GCodeModalScanner class"
      contains: "scanToLine"
    - path: "src/core/gcode/gcode_modal_scanner.cpp"
      provides: "Modal state scanning implementation"
      min_lines: 60
    - path: "tests/core/gcode/test_gcode_modal_scanner.cpp"
      provides: "Comprehensive tests for modal state scanner"
      min_lines: 80
  key_links:
    - from: "tests/core/gcode/test_gcode_modal_scanner.cpp"
      to: "src/core/gcode/gcode_modal_scanner.h"
      via: "include and test invocation"
      pattern: "GCodeModalScanner::scanToLine"
---

<objective>
Implement and test the G-code modal state scanner that reconstructs machine state at any line in a program.

Purpose: SAF-05 requires rebuilding modal state (units, coordinate system, distance mode, spindle, coolant, feed rate) by scanning G-code from line 0 to a resume point. This is the most safety-critical logic in the phase -- getting it wrong means the machine resumes in an incorrect state.

Output: Tested GCodeModalScanner utility class with ModalState struct and toPreamble() method.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/06-job-safety/06-RESEARCH.md
@src/core/gcode/gcode_parser.h
@src/core/gcode/gcode_analyzer.h
</context>

<feature>
  <name>G-Code Modal State Scanner</name>
  <files>
    src/core/gcode/gcode_modal_scanner.h
    src/core/gcode/gcode_modal_scanner.cpp
    tests/core/gcode/test_gcode_modal_scanner.cpp
  </files>
  <behavior>
    GCodeModalScanner::scanToLine(program, endLine) scans lines 0..endLine-1 and returns accumulated ModalState.

    ModalState tracks:
    - distanceMode: "G90" or "G91" (default G90)
    - coordinateSystem: "G54" through "G59" (default G54)
    - units: "G20" or "G21" (default G21 -- millimeters)
    - spindleState: "M3", "M4", or "M5" (default M5 -- off)
    - coolantState: "M7", "M8", or "M9" (default M9 -- off)
    - feedRate: float F value (default 0.0)
    - spindleSpeed: float S value (default 0.0)

    ModalState::toPreamble() returns vector of G-code lines to restore state:
    Order: units, coordinateSystem, distanceMode, F value, S value, spindleState, coolantState

    Test cases:
    1. Empty program -> defaults (G90, G54, G21, M5, M9, F0, S0)
    2. Simple program with all modal codes set -> correct state at end
    3. Mid-program scan (endLine < program.size()) -> state at that point only
    4. Lowercase g-code (g90, m3) -> handled correctly
    5. Comments stripped: "(comment)" and "; comment" ignored
    6. Multiple codes per line: "G90 G21 M3 S12000" all tracked
    7. F and S values: "G1 X10 F500" -> feedRate=500, "S12000 M3" -> spindleSpeed=12000
    8. Coordinate system changes: G54, G55, G56, G57, G58, G59
    9. toPreamble() generates correct restore sequence
    10. G2/G3 arc commands don't affect modal tracking (not deferred -- arcs don't change modal state)
    11. Blank lines and comment-only lines safely skipped
    12. endLine=0 returns defaults
    13. endLine > program.size() scans entire program without error
  </behavior>
  <implementation>
    Create src/core/gcode/gcode_modal_scanner.h:
    - ModalState struct with all fields and defaults
    - ModalState::toPreamble() returns vector of string lines
    - GCodeModalScanner class with static scanToLine() method

    Create src/core/gcode/gcode_modal_scanner.cpp:
    - scanToLine implementation:
      1. For each line 0..min(endLine, program.size())-1:
         a. Strip comments: remove content between ( and ), remove everything after ;
         b. Convert to uppercase for matching
         c. Tokenize: extract G/M codes (G followed by digits, M followed by digits)
         d. Extract F and S values (F followed by number, S followed by number)
         e. Update ModalState based on recognized codes
      2. Return accumulated ModalState
    - toPreamble implementation:
      1. Push units (G20/G21)
      2. Push coordinate system (G54-G59)
      3. Push distance mode (G90/G91)
      4. Push F value if > 0
      5. Push S value if > 0
      6. Push spindle state (M3/M4/M5)
      7. Push coolant state (M7/M8/M9)
      8. Return vector

    Add both files to src/CMakeLists.txt and test to tests/CMakeLists.txt.

    Use Catch2 for tests (check existing test files for the project's test framework pattern).
  </implementation>
</feature>

<verification>
- All tests pass: run test binary with modal scanner test tag
- Scanner correctly handles all edge cases listed in behavior section
- toPreamble() output is valid G-code that GRBL would accept
</verification>

<success_criteria>
- GCodeModalScanner::scanToLine() returns correct ModalState for any valid program and line number
- ModalState::toPreamble() generates correct preamble sequence
- All 13+ test cases pass
- Edge cases (empty, comments, lowercase, multi-code lines) handled
</success_criteria>

<output>
After completion, create `.planning/phases/06-job-safety/06-01-SUMMARY.md`
</output>

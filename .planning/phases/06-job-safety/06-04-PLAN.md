---
phase: 06-job-safety
plan: 04
type: execute
wave: 3
depends_on: [01, 03]
files_modified:
  - src/ui/panels/cnc_safety_panel.h
  - src/ui/panels/cnc_safety_panel.cpp
  - src/ui/panels/gcode_panel.h
  - src/ui/panels/gcode_panel.cpp
  - src/app/application_wiring.cpp
autonomous: true
requirements: [SAF-04, SAF-05, SAF-07]

must_haves:
  truths:
    - "User can specify a line number to resume from in the safety panel"
    - "Modal state preamble is generated by scanning G-code from line 0 to resume point"
    - "User can review the preamble before confirming resume"
    - "Resume starts streaming with preamble prepended to remaining program lines"
    - "Pre-flight checks run before any streaming operation (new job or resume)"
  artifacts:
    - path: "src/ui/panels/cnc_safety_panel.h"
      provides: "Resume-from-line UI state and methods"
      contains: "m_resumeLine"
    - path: "src/ui/panels/cnc_safety_panel.cpp"
      provides: "Resume dialog rendering and streaming integration"
      contains: "renderResumeDialog"
  key_links:
    - from: "src/ui/panels/cnc_safety_panel.cpp"
      to: "src/core/gcode/gcode_modal_scanner.h"
      via: "scanToLine call for preamble generation"
      pattern: "GCodeModalScanner::scanToLine"
    - from: "src/ui/panels/cnc_safety_panel.cpp"
      to: "src/core/cnc/preflight_check.h"
      via: "runPreflightChecks before streaming"
      pattern: "runPreflightChecks"
    - from: "src/ui/panels/cnc_safety_panel.cpp"
      to: "src/core/cnc/cnc_controller.h"
      via: "startStream with preamble + remaining lines"
      pattern: "m_cnc->startStream"
---

<objective>
Add resume-from-line dialog with modal state preview and pre-flight validation to the safety panel.

Purpose: SAF-04/SAF-05 are the most complex safety features. The operator must be able to resume a job from any line with the machine in the correct modal state. SAF-07 pre-flight checks gate all streaming operations. This plan integrates the modal scanner (Plan 01), pre-flight checks (Plan 02), and safety panel (Plan 03).

Output: Working resume-from-line flow with preamble preview and pre-flight validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/06-job-safety/06-RESEARCH.md
@.planning/phases/06-job-safety/06-01-SUMMARY.md
@.planning/phases/06-job-safety/06-03-SUMMARY.md
@src/core/gcode/gcode_modal_scanner.h
@src/core/cnc/preflight_check.h
@src/core/cnc/cnc_controller.h
@src/ui/panels/cnc_safety_panel.h
@src/ui/panels/gcode_panel.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add resume-from-line dialog to CncSafetyPanel</name>
  <files>src/ui/panels/cnc_safety_panel.h, src/ui/panels/cnc_safety_panel.cpp</files>
  <action>
    Extend CncSafetyPanel with resume-from-line functionality.

    **New members in cnc_safety_panel.h:**
    ```cpp
    // Resume-from-line state
    bool m_showResumeDialog = false;
    int m_resumeLine = 1;                    // 1-based line number for user display
    std::vector<std::string> m_preambleLines; // Generated preamble preview
    std::vector<std::string> m_fullProgram;   // Cached program lines
    bool m_preambleGenerated = false;

    // Pre-flight state
    std::vector<PreflightIssue> m_preflightIssues;

    // Getters needed by wiring
    void setProgram(const std::vector<std::string>& lines) { m_fullProgram = lines; }
    bool hasProgram() const { return !m_fullProgram.empty(); }
    ```

    **New method: renderResumeDialog()**
    ImGui modal popup "Resume From Line":

    1. **Line number input:**
       - ImGui::InputInt for line number (1-based display, clamp to 1..totalLines)
       - Show total line count: "of {totalLines} lines"

    2. **Generate Preamble button:**
       - When clicked: call GCodeModalScanner::scanToLine(m_fullProgram, m_resumeLine - 1) (convert 1-based to 0-based)
       - Store result in m_preambleLines via toPreamble()
       - Set m_preambleGenerated = true

    3. **Preamble preview (shown after generation):**
       - Display preamble lines in a read-only text block or child window
       - Header: "Modal State Preamble ({N} lines):"
       - Each preamble line shown in monospace
       - Note: "These commands will be sent before resuming to restore machine state"

    4. **Pre-flight check results (run automatically when dialog opens or preamble generated):**
       - Call runPreflightChecks() and display any issues
       - Errors shown in red, warnings in yellow
       - If any errors exist, disable the "Resume" button

    5. **Action buttons:**
       - [Resume] (green, enabled only when preamble generated AND no preflight errors):
         Build combined program: preamble lines + program lines from resumeLine-1 to end
         Call m_cnc->startStream(combinedLines)
         Close dialog
       - [Cancel] (grey): close dialog, reset state

    6. **Warning text:**
       - "WARNING: Resuming from an arbitrary line is inherently risky."
       - "Verify the preamble restores correct machine state before proceeding."
       - "Arc commands (G2/G3) at the resume point may not execute correctly."

    **Add "Resume From Line..." button to renderSafetyControls():**
    - Placed below the Pause/Resume/Abort row
    - Enabled when connected AND not streaming AND hasProgram()
    - Opens the resume dialog: m_showResumeDialog = true

    **Call renderResumeDialog() from render()** alongside renderAbortConfirmDialog().
  </action>
  <verify>
    Build the project. Verify:
    - Resume dialog opens with line number input
    - Generate Preamble button produces correct preamble lines
    - Pre-flight errors disable the Resume button
    - Resume starts streaming with preamble + remaining lines
    - Dialog has appropriate warnings
  </verify>
  <done>
    Resume-from-line dialog with line input, preamble preview, pre-flight gating, and streaming integration. User can review modal state before confirming resume.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire program data to safety panel and add pre-flight to normal streaming</name>
  <files>src/ui/panels/gcode_panel.h, src/ui/panels/gcode_panel.cpp, src/app/application_wiring.cpp</files>
  <action>
    **GCodePanel changes (gcode_panel.h/cpp):**
    - Add a getter for the send program lines: `const std::vector<std::string>& sendProgram() const;`
      This returns the processed program lines that would be streamed (the same lines passed to startStream).
      If the GCodePanel already builds a send program internally (check buildSendProgram()), expose it.
      If not, add a member to cache it.

    - In the "Send" button handler (where startStream is called), add pre-flight checks BEFORE calling startStream:
      ```cpp
      #include "core/cnc/preflight_check.h"
      // ... in the send handler:
      auto issues = runPreflightChecks(*m_cnc, hasToolSelected, hasMaterialSelected);
      // Separate errors from warnings
      bool hasErrors = false;
      for (const auto& issue : issues) {
          if (issue.severity == PreflightIssue::Error) hasErrors = true;
      }
      if (hasErrors) {
          // Show error in console or status message, don't start streaming
          for (const auto& issue : issues) {
              if (issue.severity == PreflightIssue::Error)
                  addConsoleLine("PRE-FLIGHT ERROR: " + issue.message, ConsoleLine::Error);
          }
          return;
      }
      // Show warnings but proceed
      for (const auto& issue : issues) {
          if (issue.severity == PreflightIssue::Warning)
              addConsoleLine("WARNING: " + issue.message, ConsoleLine::Info);
      }
      // Then call startStream as before
      ```

    - For hasToolSelected/hasMaterialSelected: check if CncToolPanel has a selected tool/material.
      The simplest approach: add bool parameters to the GCodePanel or use the CncToolPanel pointer.
      Since GCodePanel already has m_toolDatabase, check if there's a way to determine tool selection.
      If CncToolPanel is not accessible from GCodePanel, use reasonable defaults (false for both)
      or add setter methods that application_wiring.cpp can use to push this state.

    **application_wiring.cpp changes:**
    - After creating the safety panel, push the program data when a G-code file is loaded:
      In the section where CncCallbacks are set up, after streaming starts or when program changes,
      push the program to the safety panel.
    - The simplest approach: when the GCodePanel starts streaming, also pass the program to the safety panel.
      Or: connect them so the safety panel can access the program when the resume dialog opens.
    - Practical approach: add a callback or direct setter. In the onProgressUpdate callback:
      ```cpp
      if (safetyp && !safetyp->hasProgram() && gcp->hasGCode()) {
          safetyp->setProgram(gcp->sendProgram());
      }
      ```
    - Clear program on disconnect: if (safetyp) safetyp->setProgram({});
  </action>
  <verify>
    Build the project. Verify:
    - Pre-flight checks run before normal streaming in GCodePanel
    - Pre-flight errors prevent streaming, shown in console
    - Pre-flight warnings shown but don't block streaming
    - Safety panel has access to program lines for resume dialog
  </verify>
  <done>
    Pre-flight checks integrated into normal streaming flow. Program data accessible to safety panel for resume-from-line feature. Complete end-to-end safety flow: pre-flight -> stream OR pre-flight -> resume with preamble -> stream.
  </done>
</task>

</tasks>

<verification>
- User can open resume dialog, enter a line number, generate preamble, and review it
- Resume starts streaming with preamble prepended
- Pre-flight checks block streaming on errors (no connection, alarm state)
- Pre-flight warnings shown for missing tool/material
- Normal streaming (from GCodePanel Send button) also goes through pre-flight
- Arc warning displayed in resume dialog
</verification>

<success_criteria>
- Resume-from-line dialog fully functional with preamble preview
- Modal state correctly reconstructed via GCodeModalScanner
- Pre-flight checks gate all streaming operations
- End-to-end flow works: load G-code -> pre-flight -> stream OR resume from line with preamble
</success_criteria>

<output>
After completion, create `.planning/phases/06-job-safety/06-04-SUMMARY.md`
</output>

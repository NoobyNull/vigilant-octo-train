---
phase: 06-job-safety
plan: 03
type: execute
wave: 2
depends_on: [02]
files_modified:
  - src/ui/panels/cnc_safety_panel.h
  - src/ui/panels/cnc_safety_panel.cpp
  - src/managers/ui_manager.h
  - src/managers/ui_manager.cpp
  - src/app/application_wiring.cpp
  - src/CMakeLists.txt
autonomous: true
requirements: [SAF-01, SAF-02, SAF-03, SAF-06]

must_haves:
  truths:
    - "Pause button sends feed hold and visually changes state"
    - "Resume button sends cycle start only when machine is in Hold state"
    - "Abort button sends soft reset with confirmation dialog when a job is running"
    - "Abort sends soft reset immediately without dialog when no job is running"
    - "Sensor display shows endstop, probe, and door pin states from Pn: field"
    - "Button states reflect machine state (Resume greyed out unless Hold)"
    - "Software abort button is NOT labeled E-Stop (per PITFALLS.md CRITICAL-3)"
  artifacts:
    - path: "src/ui/panels/cnc_safety_panel.h"
      provides: "CncSafetyPanel class with safety controls and sensor display"
      contains: "CncSafetyPanel"
    - path: "src/ui/panels/cnc_safety_panel.cpp"
      provides: "Safety panel rendering implementation"
      min_lines: 100
    - path: "src/managers/ui_manager.h"
      provides: "CncSafetyPanel registration in UIManager"
      contains: "cncSafetyPanel"
    - path: "src/app/application_wiring.cpp"
      provides: "CncSafetyPanel callback wiring"
      contains: "safetyp"
  key_links:
    - from: "src/ui/panels/cnc_safety_panel.cpp"
      to: "src/core/cnc/cnc_controller.h"
      via: "feedHold(), cycleStart(), softReset() calls"
      pattern: "m_cnc->feedHold|m_cnc->cycleStart|m_cnc->softReset"
    - from: "src/app/application_wiring.cpp"
      to: "src/ui/panels/cnc_safety_panel.h"
      via: "callback wiring"
      pattern: "safetyp.*onStatusUpdate"
---

<objective>
Create the CncSafetyPanel with Pause/Resume/Abort buttons, confirmation dialog, and sensor pin display.

Purpose: This is the primary safety control UI. Operators need clearly visible, state-aware controls to pause, resume, and abort jobs, plus sensor status visibility. SAF-01/02/03/06 all converge in this panel.

Output: CncSafetyPanel wired into UIManager and CncController callbacks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/06-job-safety/06-RESEARCH.md
@.planning/phases/06-job-safety/06-02-SUMMARY.md
@src/core/cnc/cnc_types.h
@src/core/cnc/cnc_controller.h
@src/ui/panels/cnc_job_panel.h
@src/ui/panels/cnc_status_panel.h
@src/managers/ui_manager.h
@src/app/application_wiring.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CncSafetyPanel with safety controls and sensor display</name>
  <files>src/ui/panels/cnc_safety_panel.h, src/ui/panels/cnc_safety_panel.cpp, src/CMakeLists.txt</files>
  <action>
    Create src/ui/panels/cnc_safety_panel.h following the established CNC panel pattern:
    ```cpp
    class CncSafetyPanel : public Panel {
    public:
        CncSafetyPanel();
        ~CncSafetyPanel() override = default;
        void render() override;

        // Callbacks
        void onStatusUpdate(const MachineStatus& status);
        void onConnectionChanged(bool connected, const std::string& version);

        // Dependencies
        void setCncController(CncController* ctrl) { m_cnc = ctrl; }

    private:
        void renderSafetyControls();
        void renderSensorDisplay();
        void renderAbortConfirmDialog();

        CncController* m_cnc = nullptr;
        MachineStatus m_status{};
        bool m_connected = false;
        bool m_streaming = false;
        bool m_showAbortConfirm = false;
    };
    ```

    Create src/ui/panels/cnc_safety_panel.cpp:

    **renderSafetyControls():**
    - Three buttons in a row: [Pause] [Resume] [Abort]
    - **Pause button:**
      - Enabled only when connected AND (state == Run OR state == Jog)
      - Calls m_cnc->feedHold()
      - Yellow/amber color when enabled, grey when disabled
      - Use ImGui::PushStyleColor for button colors
    - **Resume button:**
      - Enabled ONLY when connected AND state == Hold
      - Calls m_cnc->cycleStart()
      - Green color when enabled, grey when disabled
    - **Abort button (CRITICAL - see naming):**
      - Label: "Abort" or "Soft Reset" -- NEVER "E-Stop" or "Emergency Stop" (per PITFALLS.md CRITICAL-3)
      - Always enabled when connected
      - If m_streaming is true: set m_showAbortConfirm = true (open confirmation dialog)
      - If m_streaming is false: call m_cnc->softReset() directly (no dialog needed)
      - Red color, larger/more prominent than other buttons
      - Add a small note below: "Software stop only -- ensure hardware E-stop is accessible"

    **renderAbortConfirmDialog():**
    - ImGui::OpenPopup("Abort Running Job?") when m_showAbortConfirm is set
    - Modal popup with warning text: "A job is currently running. Aborting will send a soft reset (0x18) which stops all motion immediately. You may need to re-home the machine afterward."
    - Two buttons: [Abort Job] (red, calls softReset, closes popup) and [Cancel] (grey, closes popup)
    - Reset m_showAbortConfirm when popup closes

    **renderSensorDisplay():**
    - Section header: "Input Pins" or "Sensors"
    - Display pin states from m_status.inputPins using the cnc::PIN_* constants
    - For each pin, show a colored indicator:
      - Active (bit set): bright color (red for limits, green for probe, yellow for door)
      - Inactive (bit clear): dim/grey
    - Layout: compact grid or two-column layout
    - Pins to display: X Limit, Y Limit, Z Limit, Probe, Door
    - Optional (if space): Hold, Reset, Start pins (less common)
    - When not connected, show "Not connected" instead of pin states

    **render() method:**
    - Call renderSafetyControls()
    - ImGui::Separator()
    - Call renderSensorDisplay()
    - Call renderAbortConfirmDialog()

    **Streaming state tracking:**
    - The panel needs to know if streaming is active for the abort confirmation logic
    - Add a method: void setStreaming(bool streaming) { m_streaming = streaming; }
    - This will be called from application_wiring.cpp callbacks (same pattern as CncJobPanel)

    Add both files to src/CMakeLists.txt.
  </action>
  <verify>
    Build the project. CncSafetyPanel compiles and links. Verify button logic:
    - Pause enabled only in Run/Jog state
    - Resume enabled only in Hold state
    - Abort shows dialog when streaming, direct reset otherwise
    - Sensor display reads from inputPins bitmask
  </verify>
  <done>
    CncSafetyPanel renders Pause/Resume/Abort buttons with correct state gating, abort confirmation dialog for running jobs, and sensor pin display from Pn: data. Abort is labeled "Abort" not "E-Stop".
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire CncSafetyPanel into UIManager and application callbacks</name>
  <files>src/managers/ui_manager.h, src/managers/ui_manager.cpp, src/app/application_wiring.cpp</files>
  <action>
    Follow the established CNC panel pattern from Phase 4/5 (CncToolPanel, CncJobPanel).

    **ui_manager.h:**
    - Add forward declaration for CncSafetyPanel
    - Add member: std::unique_ptr<CncSafetyPanel> m_cncSafetyPanel;
    - Add accessor: CncSafetyPanel* cncSafetyPanel() { return m_cncSafetyPanel.get(); }
    - Add visibility toggle bool (if the pattern uses one)

    **ui_manager.cpp:**
    - Include cnc_safety_panel.h
    - Create panel in init (or wherever other CNC panels are created)
    - Add to CNC workspace mode visibility (same as CncJobPanel, CncToolPanel)
    - Add render call in the CNC panel rendering section
    - Add View menu toggle (alongside other CNC panel toggles)
    - Clean up in shutdown

    **application_wiring.cpp:**
    - Get pointer: auto* safetyp = m_uiManager->cncSafetyPanel();
    - Set controller: if (safetyp) safetyp->setCncController(m_cncController.get());
    - Wire onConnectionChanged callback: if (safetyp) safetyp->onConnectionChanged(connected, version);
    - Wire onStatusUpdate callback: if (safetyp) safetyp->onStatusUpdate(status);
    - Wire streaming state: in the onProgressUpdate callback (same place CncJobPanel gets streaming state), add:
      ```cpp
      if (safetyp) {
          bool streaming = (progress.totalLines > 0 && progress.ackedLines < progress.totalLines);
          safetyp->setStreaming(streaming);
      }
      ```
    - Wire connection lost: in onConnectionChanged, if (!connected && safetyp) safetyp->setStreaming(false);
  </action>
  <verify>
    Build the project. CncSafetyPanel appears in CNC workspace mode. Verify:
    - Panel renders with correct buttons
    - Connection state updates button visibility
    - Status updates reflect in sensor display
    - Streaming state tracked for abort confirmation
  </verify>
  <done>
    CncSafetyPanel fully integrated: visible in CNC workspace, receives status updates at 5Hz, tracks streaming state, and has controller reference for sending commands.
  </done>
</task>

</tasks>

<verification>
- Pause button sends feed hold when machine is in Run state
- Resume button sends cycle start only when machine is in Hold state
- Abort shows confirmation dialog during streaming, sends soft reset directly otherwise
- Abort button labeled "Abort" not "E-Stop"
- Sensor display shows pin states from Pn: field
- Panel visible in CNC workspace mode with View menu toggle
- All callbacks wired correctly in application_wiring.cpp
</verification>

<success_criteria>
- CncSafetyPanel renders in CNC workspace with Pause/Resume/Abort buttons
- Button states correctly gated on machine state
- Confirmation dialog appears for abort during streaming
- Sensor display shows endstop, probe, and door states
- Panel wired into UIManager and CncController callbacks
</success_criteria>

<output>
After completion, create `.planning/phases/06-job-safety/06-03-SUMMARY.md`
</output>

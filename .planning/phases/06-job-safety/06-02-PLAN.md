---
phase: 06-job-safety
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/cnc/cnc_types.h
  - src/core/cnc/cnc_controller.cpp
  - src/core/cnc/preflight_check.h
  - src/core/cnc/preflight_check.cpp
  - src/CMakeLists.txt
autonomous: true
requirements: [SAF-06, SAF-07]

must_haves:
  truths:
    - "Pn: field from GRBL status reports is parsed into MachineStatus.inputPins bitmask"
    - "Pin constants (PIN_X_LIMIT, PIN_Y_LIMIT, etc.) are defined for all GRBL input pins"
    - "Pre-flight check detects missing connection and alarm state as blocking errors"
    - "Pre-flight check warns (non-blocking) about missing tool/material selection"
  artifacts:
    - path: "src/core/cnc/cnc_types.h"
      provides: "Pin constant definitions and PreflightIssue struct"
      contains: "PIN_X_LIMIT"
    - path: "src/core/cnc/cnc_controller.cpp"
      provides: "Pn: field parsing in parseStatusReport"
      contains: "inputPins"
    - path: "src/core/cnc/preflight_check.h"
      provides: "PreflightIssue struct and runPreflightChecks function"
      contains: "runPreflightChecks"
  key_links:
    - from: "src/core/cnc/cnc_controller.cpp"
      to: "src/core/cnc/cnc_types.h"
      via: "PIN_ constants used in Pn: parsing"
      pattern: "PIN_X_LIMIT|PIN_PROBE|PIN_DOOR"
---

<objective>
Add Pn: field parsing to GRBL status reports and implement pre-flight validation checks.

Purpose: SAF-06 requires sensor display from Pn: data (endstops, probe, door). SAF-07 requires pre-flight checks before streaming. Both are foundational for the safety panel UI in Plan 03.

Output: Pin constants, Pn: parser in CncController, and PreflightCheck utility.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/06-job-safety/06-RESEARCH.md
@src/core/cnc/cnc_types.h
@src/core/cnc/cnc_controller.h
@src/core/cnc/cnc_controller.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pin constants and parse Pn: field in status reports</name>
  <files>src/core/cnc/cnc_types.h, src/core/cnc/cnc_controller.cpp</files>
  <action>
    In cnc_types.h, inside the `cnc` namespace (where CMD_ constants are), add pin state bitmask constants:
    ```
    constexpr u32 PIN_X_LIMIT = 1 << 0;
    constexpr u32 PIN_Y_LIMIT = 1 << 1;
    constexpr u32 PIN_Z_LIMIT = 1 << 2;
    constexpr u32 PIN_PROBE   = 1 << 3;
    constexpr u32 PIN_DOOR    = 1 << 4;
    constexpr u32 PIN_HOLD    = 1 << 5;
    constexpr u32 PIN_RESET   = 1 << 6;
    constexpr u32 PIN_START   = 1 << 7;
    ```

    Also add A and B limit pins (for 4+ axis machines) if desired, but X/Y/Z/P/D/H/R/S are the standard GRBL v1.1 set.

    In cnc_controller.cpp, inside parseStatusReport()'s field parsing loop (the `for (size_t i = 1; ...)` loop), add a new `else if` clause for key == "Pn":
    ```cpp
    } else if (key == "Pn") {
        status.inputPins = 0; // Clear all pins first
        for (char c : val) {
            switch (c) {
            case 'X': status.inputPins |= cnc::PIN_X_LIMIT; break;
            case 'Y': status.inputPins |= cnc::PIN_Y_LIMIT; break;
            case 'Z': status.inputPins |= cnc::PIN_Z_LIMIT; break;
            case 'P': status.inputPins |= cnc::PIN_PROBE; break;
            case 'D': status.inputPins |= cnc::PIN_DOOR; break;
            case 'H': status.inputPins |= cnc::PIN_HOLD; break;
            case 'R': status.inputPins |= cnc::PIN_RESET; break;
            case 'S': status.inputPins |= cnc::PIN_START; break;
            }
        }
    }
    ```

    IMPORTANT: GRBL only includes the Pn: field when at least one input pin is active. When Pn: is absent, inputPins should remain at its default (0). The MachineStatus struct already initializes inputPins to 0, but we must ensure it's reset to 0 at the start of parseStatusReport so stale data doesn't persist. Add `status.inputPins = 0;` near the top of parseStatusReport after `MachineStatus status;`.
  </action>
  <verify>
    Build the project. Verify parseStatusReport correctly parses a test string like:
    "<Hold:0|MPos:0.000,0.000,0.000|Pn:XZP>" should set PIN_X_LIMIT, PIN_Z_LIMIT, and PIN_PROBE bits.
    Check existing tests for parseStatusReport and add or update test cases if a test file exists.
  </verify>
  <done>
    Pin constants defined. Pn: field parsed from GRBL status reports into MachineStatus.inputPins bitmask. inputPins correctly defaults to 0 when Pn: field is absent.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement pre-flight check utility</name>
  <files>src/core/cnc/preflight_check.h, src/core/cnc/preflight_check.cpp, src/CMakeLists.txt</files>
  <action>
    Create src/core/cnc/preflight_check.h:
    ```cpp
    #pragma once
    #include <string>
    #include <vector>

    namespace dw {

    class CncController;

    struct PreflightIssue {
        enum Severity { Error, Warning };
        Severity severity;
        std::string message;
    };

    // Run pre-flight checks before streaming. Returns empty vector if all clear.
    // Errors block streaming; warnings are informational only.
    std::vector<PreflightIssue> runPreflightChecks(
        const CncController& ctrl,
        bool hasToolSelected,
        bool hasMaterialSelected
    );

    } // namespace dw
    ```

    Create src/core/cnc/preflight_check.cpp:
    - Include cnc_controller.h and preflight_check.h
    - Implement runPreflightChecks:
      1. If !ctrl.isConnected() -> Error: "Not connected to CNC controller"
      2. If ctrl.lastStatus().state == MachineState::Alarm -> Error: "Machine is in ALARM state -- clear alarm first ($X or power cycle)"
      3. If ctrl.isInErrorState() -> Error: "Previous streaming error not acknowledged"
      4. If ctrl.isStreaming() -> Error: "A job is already running"
      5. If !hasToolSelected -> Warning: "No tool selected -- feed rate recommendations unavailable"
      6. If !hasMaterialSelected -> Warning: "No material selected -- cutting parameters not validated"
    - Return the issues vector

    Add both files to src/CMakeLists.txt in the appropriate source list (alongside other cnc files).
  </action>
  <verify>
    Build the project successfully. The preflight_check.h/.cpp should compile and link without errors.
  </verify>
  <done>
    PreflightIssue struct and runPreflightChecks() function implemented. Checks connection, alarm state, error state, streaming state (errors) and tool/material selection (warnings).
  </done>
</task>

</tasks>

<verification>
- Project builds successfully with new pin constants and Pn: parser
- parseStatusReport handles Pn: field correctly (present and absent cases)
- runPreflightChecks returns correct issues for various controller states
- No regressions in existing CNC functionality
</verification>

<success_criteria>
- Pin constants defined for all 8 GRBL input pins
- Pn: field parsed in parseStatusReport with proper default handling
- Pre-flight checks cover all 6 conditions (4 errors, 2 warnings)
- Both new files compile and link into the project
</success_criteria>

<output>
After completion, create `.planning/phases/06-job-safety/06-02-SUMMARY.md`
</output>

# Plan 18-03: Confirmation Summary, Commit Flow, Run Integration

**Phase**: 18 — Guided Workflow
**Requirements**: DC-25

## Overview

Implement the final wizard steps: zero confirmation, full summary with commit button, and the running state that hands off to the streaming system.

## Modifications

### `src/ui/panels/direct_carve_panel.cpp`

**renderZeroConfirm()** (~35 lines):

1. Current position display:
   - Show machine work position (X, Y, Z) from status
   - Highlight if position is near expected zero (0, 0, stock surface)

2. Instructions:
   - "Position the tool at the work zero point (bottom-left of stock, Z on top surface)"
   - "Use jog controls in the CNC panel to fine-tune position"

3. Zero action buttons:
   - "Set Zero Here" — sends `G10 L20 P0 X0 Y0 Z0`
   - "Zero XY Only" — sends `G10 L20 P0 X0 Y0`
   - "Zero Z Only" — sends `G10 L20 P0 Z0`

4. Confirmation checkbox: "Zero position is set and verified"

**renderCommit()** (~40 lines):

1. Full summary card:
   - **Model**: name, dimensions after fit, depth
   - **Finishing Tool**: name, type, diameter, tip radius
   - **Clearing Tool**: name (or "None — no islands detected")
   - **Material**: name (if selected)
   - **Feeds/Speeds**: feed rate, plunge rate, spindle speed
   - **Scan**: axis, direction, stepover preset + mm value
   - **Safe Z**: height in mm
   - **Estimates**: finishing time, clearing time, total time, total lines

2. Warning box (if any toolpath warnings from travel limit check)

3. Final confirmation:
   - Checkbox: "I have verified the work zero, tool, and material setup"
   - "Start Carving" button (enabled when checkbox checked)
   - "Save as G-code" button — exports toolpath to .nc file first

**renderRunning()** (~35 lines):

1. Progress display:
   - Large progress bar (current line / total lines)
   - Elapsed time / estimated remaining
   - Current pass: "Clearing pass 1/3" or "Finishing pass"
   - Current position (X, Y, Z)

2. Control buttons:
   - "Pause" / "Resume" toggle (same as G-code streaming)
   - "Abort" with confirmation (long-press or confirmation dialog)

3. State transitions:
   - On completion: show "Carving Complete" with summary
   - On abort: show "Carving Aborted" with position info
   - "New Carve" button resets wizard to MachineCheck step

### Save G-code flow

When "Save as G-code" is clicked:
1. Open FileDialog with .nc extension filter
2. Write toolpath to file as standard G-code:
   ```
   (Direct Carve — generated by Digital Workshop)
   (Model: {name}, Depth: {depth}mm)
   (Tool: {toolName}, Stepover: {stepover}mm)
   G90 G21 (absolute, metric)
   G0 Z{safeZ}
   ... toolpath points as G0/G1 commands ...
   G0 Z{safeZ}
   M5
   M30
   ```
3. File can be loaded later via normal G-code streaming

### `src/core/carve/gcode_export.h` (~30 lines)

```cpp
namespace dw {
namespace carve {

// Export toolpath to G-code file
bool exportGcode(const std::string& path,
                 const MultiPassToolpath& toolpath,
                 const ToolpathConfig& config,
                 const std::string& modelName,
                 const std::string& toolName);

} // namespace carve
} // namespace dw
```

### `src/core/carve/gcode_export.cpp` (~80 lines)

Writes standard G-code with comments header, G90/G21 preamble, toolpath points as G0/G1, and M30 footer.

### Tests

`src/core/carve/gcode_export_test.cpp` (~80 lines):
- `TEST(GcodeExport, Header)` — output starts with comment header
- `TEST(GcodeExport, MetricAbsolute)` — G90 G21 in preamble
- `TEST(GcodeExport, RapidAndFeed)` — G0 for rapids, G1 with F for cuts
- `TEST(GcodeExport, Footer)` — M5 M30 at end
- `TEST(GcodeExport, FileWritable)` — writes to temp file successfully

## Coding Standards Compliance

- Each render function under 40 lines
- G-code export is a standalone free function (testable without UI)
- Summary card uses ImGui table for clean layout
- No hardcoded G-code — preamble/footer could be configurable in future
- Confirmation checkbox prevents accidental job start

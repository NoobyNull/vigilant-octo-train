# Plan 18-02: Model Fitting UI, Preview Rendering, Outline Test

**Phase**: 18 — Guided Workflow
**Requirements**: DC-22, DC-23, DC-24

## Overview

Implement the model fitting step (scale/position/depth controls with live preview), toolpath preview with time estimate, and outline test that traces the job perimeter at safe Z.

## Modifications

### `src/ui/panels/direct_carve_panel.cpp` — Model fitting step

**renderModelFit()** (~45 lines):

1. Stock dimensions inputs:
   - Width (X), Height (Y), Thickness (Z) — `ImGui::DragFloat` with mm units
   - "From Machine Profile" button fills from active machine profile

2. Model fitting controls:
   - Scale slider: `ImGui::SliderFloat("Scale", &m_fitParams.scale, 0.1f, 10.0f)`
   - "Auto Fit" button: sets scale to `m_fitter.autoScale()`
   - Z Depth: `ImGui::DragFloat("Depth", &m_fitParams.depthMm, 0.1f, 0.0f, stock.thickness)`
   - "Full Depth" button: sets depth to `m_fitter.autoDepth() * scale`
   - X/Y Offset: `ImGui::DragFloat2("Position", &m_fitParams.offsetX)`

3. Live fit result display:
   - Call `m_fitter.fit(m_fitParams)` on each frame
   - Show model dimensions after transform
   - Green "Fits" / Red "Exceeds" indicators for stock and machine bounds
   - Warning text if !fitsStock or !fitsMachine

4. "Generate Heightmap" button:
   - Starts CarveJob background computation
   - Shows progress bar while computing
   - Auto-advances to analysis when complete

### `src/ui/panels/direct_carve_panel.cpp` — Preview step

**renderPreview()** (~45 lines):

1. Heightmap visualization:
   - Render analysis overlay texture in an `ImGui::Image`
   - Show island highlights and min radius annotation
   - Scale to fit panel width

2. Toolpath overlay:
   - Render toolpath lines on top of heightmap image
   - Color code: blue = finishing, red = clearing, green = rapids
   - Use ImDrawList to draw polylines over the image

3. Statistics panel:
   - Total scan lines
   - Estimated carving time (from Toolpath.estimatedTimeSec)
   - Total distance
   - Clearing time (if applicable)
   - Combined total

4. Controls:
   - Toggle finishing/clearing visibility
   - Zoom in/out on heightmap preview

### `src/ui/panels/direct_carve_panel.cpp` — Outline test

**renderOutlineTest()** (~40 lines):

1. Outline description text: "Traces the job perimeter at safe Z to verify work area"
2. Bounding box display: min/max XY of the toolpath
3. "Run Outline" button:
   - Generates 4 G0 moves at safe Z tracing the toolpath bounding rectangle
   - Sends via CncController: `G90 G0 Z{safeZ}`, `G0 X{minX} Y{minY}`, `G0 X{maxX} Y{minY}`, `G0 X{maxX} Y{maxY}`, `G0 X{minX} Y{maxY}`, `G0 X{minX} Y{minY}`
   - Progress indicator while running
4. "Skip Outline" checkbox — allows advancing without running test
5. After outline completes: "Outline complete — verify work area before proceeding"

### `src/core/carve/carve_job.h` — Add outline and analysis state

```cpp
// Analysis results (available after heightmap)
const CurvatureResult& curvatureResult() const;
const IslandResult& islandResult() const;

// Run analysis after heightmap (call from main thread, fast)
void analyzeHeightmap(f32 toolAngleDeg);

// Toolpath state
void generateToolpath(const ToolpathConfig& config,
                      const VtdbToolGeometry& finishTool,
                      const VtdbToolGeometry* clearTool);
const MultiPassToolpath& toolpath() const;
```

## Tests

No new unit tests (UI rendering). Analysis/toolpath tests covered in phases 15-17.

Integration verification:
- Model fit preview updates live as sliders change
- Heightmap generates on background thread with progress bar
- Outline sends correct G-code rectangle to CncController
- Toolpath preview shows scan lines with correct coloring

## Coding Standards Compliance

- Each render function under 45 lines
- No hardcoded slider ranges (derived from stock/machine dims)
- Outline G-code uses G90 absolute positioning
- Background heightmap computation via existing CarveJob pattern

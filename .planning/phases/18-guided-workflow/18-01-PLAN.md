# Plan 18-01: Wizard Framework, Step Navigation, Machine Readiness

**Phase**: 18 — Guided Workflow
**Requirements**: DC-20, DC-21

## Overview

Create a step-by-step wizard panel that guides the operator through the entire Direct Carve workflow. Each step validates before allowing progression. Machine readiness is verified before any carving begins.

## New Files

### `src/ui/panels/direct_carve_panel.h` (~120 lines)

```cpp
namespace dw {

class CncController;
class ToolDatabase;

namespace carve {
class CarveJob;
}

// Direct Carve wizard panel — step-by-step guided workflow
// for streaming 2.5D toolpaths directly from STL models.
class DirectCarvePanel : public Panel {
public:
    DirectCarvePanel();
    ~DirectCarvePanel() override;

    void render() override;

    // Dependencies
    void setCncController(CncController* cnc);
    void setToolDatabase(ToolDatabase* db);
    void setCarveJob(carve::CarveJob* job);

    // Callbacks
    void onConnectionChanged(bool connected);
    void onStatusUpdate(const MachineStatus& status);
    void onModelLoaded(const std::vector<Triangle>& tris,
                       const Vec3& boundsMin,
                       const Vec3& boundsMax);

private:
    enum class Step {
        MachineCheck,   // Verify connection, homing, profile
        ModelFit,       // Scale, position, depth adjustment
        ToolSelect,     // Review/accept tool recommendations
        MaterialSetup,  // Material selection, feeds confirmation
        Preview,        // Toolpath preview with time estimate
        OutlineTest,    // Run perimeter trace at safe Z
        ZeroConfirm,    // Verify zero position
        Commit,         // Final confirmation
        Running         // Job in progress
    };

    // Step rendering (one method per step)
    void renderMachineCheck();
    void renderModelFit();
    void renderToolSelect();
    void renderMaterialSetup();
    void renderPreview();
    void renderOutlineTest();
    void renderZeroConfirm();
    void renderCommit();
    void renderRunning();

    // Navigation
    void renderStepIndicator();
    void renderNavButtons();
    bool canAdvance() const;
    void advanceStep();
    void retreatStep();

    // Validation
    bool validateMachineReady() const;

    // State
    Step m_currentStep = Step::MachineCheck;
    CncController* m_cnc = nullptr;
    ToolDatabase* m_toolDb = nullptr;
    carve::CarveJob* m_carveJob = nullptr;
    MachineStatus m_machineStatus;
    bool m_cncConnected = false;

    // Per-step state (populated as wizard progresses)
    carve::FitParams m_fitParams;
    carve::ToolpathConfig m_toolpathConfig;
    carve::StockDimensions m_stock;
    // ... tool selection state in widget
};

} // namespace dw
```

### `src/ui/panels/direct_carve_panel.cpp` (~400 lines)

**render()** (~30 lines):
1. `ImGui::Begin("Direct Carve", &m_visible)`
2. `renderStepIndicator()` — horizontal progress bar showing all steps
3. Switch on `m_currentStep`, call the appropriate render method
4. `renderNavButtons()` — Back/Next with canAdvance() gate

**renderStepIndicator()** (~25 lines):
- Horizontal row of step labels with current step highlighted
- Steps before current: green checkmark
- Current step: bright highlight
- Steps after: dimmed
- Uses `ImGui::GetWindowDrawList()` for custom rendering

**renderNavButtons()** (~20 lines):
- Back button (disabled on first step)
- Next button (disabled if !canAdvance())
- Cancel button always available
- On final step, Next becomes "Start Carving"

**renderMachineCheck()** (~45 lines):
- Checklist with green/red indicators:
  - CNC connected? (`m_cncConnected`)
  - Machine homed? (`m_machineStatus.state == MachineState::Idle` and not in alarm)
  - Machine profile configured? (non-default travel limits)
  - Safe Z verified? (probe result stored or manual confirmation)
- Each check shows status icon + description
- "Test Safe Z" button sends G0 Z{safeZ} to verify clearance

**validateMachineReady()** (~10 lines):
- Returns true only if all 4 checks pass
- Used by canAdvance() for MachineCheck step

**canAdvance()** (~20 lines):
- Switch on step, each has its own validation:
  - MachineCheck: validateMachineReady()
  - ModelFit: model loaded and fits within bounds
  - ToolSelect: finishing tool selected
  - MaterialSetup: material selected
  - Preview: toolpath generated
  - OutlineTest: outline completed or skipped
  - ZeroConfirm: user confirmed zero
  - Commit: user checked confirmation box

## CMake

Add `src/ui/panels/direct_carve_panel.cpp` to source list.

## Integration

### `src/managers/ui_manager.h` — Add panel member

```cpp
DirectCarvePanel* directCarvePanel() { return &m_directCarvePanel; }
// Private:
DirectCarvePanel m_directCarvePanel;
```

### `src/managers/ui_manager.cpp` — Wire panel

- Add to panel render loop (in CNC workspace mode)
- Add to View menu under a "Direct Carve" entry

### `src/app/application_wiring.cpp` — Connect dependencies

- Wire CncController, ToolDatabase, CarveJob
- Add to onConnectionChanged and onStatusUpdate fan-out

## Coding Standards Compliance

- direct_carve_panel.cpp ~400 lines (within 800)
- Each step render function under 45 lines
- Step enum for type-safe navigation (no raw ints)
- Dependencies injected via setters (same pattern as other panels)
- Minimum size helper from Panel base class

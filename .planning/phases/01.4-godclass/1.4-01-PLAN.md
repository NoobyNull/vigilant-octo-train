---
phase: 01.4-godclass
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/managers/ui_manager.h
  - src/managers/ui_manager.cpp
  - src/app/application.h
  - src/app/application.cpp
  - src/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "All panels render identically to before extraction (viewport, library, properties, project, gcode, cut optimizer, start page)"
    - "Panel visibility toggles from View menu work exactly as before"
    - "Keyboard shortcuts (Ctrl+N/O/S/I/E/L/,) trigger the same actions as before"
    - "About dialog, restart popup, and import progress overlay display correctly"
    - "Default dock layout is applied on first launch (no imgui.ini)"
    - "All 387+ existing tests pass with zero regressions"
  artifacts:
    - path: "src/managers/ui_manager.h"
      provides: "UIManager class owning all panels, dialogs, visibility state, and UI rendering"
      min_lines: 80
    - path: "src/managers/ui_manager.cpp"
      provides: "UIManager implementation with panel lifecycle, menu bar, keyboard shortcuts, layout"
      min_lines: 300
    - path: "src/app/application.h"
      provides: "Reduced Application header with UIManager member replacing individual panel members"
    - path: "src/app/application.cpp"
      provides: "Application delegating all UI to UIManager"
  key_links:
    - from: "src/app/application.cpp"
      to: "src/managers/ui_manager.h"
      via: "m_uiManager member, delegation calls"
      pattern: "m_uiManager->"
    - from: "src/managers/ui_manager.cpp"
      to: "src/ui/panels/*.h"
      via: "panel ownership and rendering"
      pattern: "m_viewportPanel|m_libraryPanel|m_propertiesPanel"
    - from: "src/managers/ui_manager.cpp"
      to: "src/core/events/event_bus.h"
      via: "EventBus pointer for future cross-manager events"
      pattern: "EventBus\\*"
---

<objective>
Extract UIManager from Application: move all panel ownership, visibility state, menu bar rendering, keyboard shortcuts, dialogs, import progress overlay, about dialog, restart popup, and default dock layout into a new focused UIManager class under src/managers/.

Purpose: This is the first extraction step in the incremental god class decomposition. UIManager owns ~350 lines of UI-related code. After this plan, Application no longer directly manages panels or UI rendering. The existing src/ui/ui_manager.h (which Application does NOT currently use) will be left in place for now -- the new UIManager in src/managers/ is a separate, more comprehensive class. The old one will be cleaned up in Phase 1.6 (dead code cleanup).

Output: src/managers/ui_manager.h, src/managers/ui_manager.cpp, updated application.h/.cpp, updated CMakeLists.txt
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.4-godclass/1.4-RESEARCH.md
@.planning/phases/01.1-eventbus/1.1-01-SUMMARY.md

@src/app/application.h
@src/app/application.cpp
@src/ui/ui_manager.h
@src/core/events/event_bus.h
@src/core/events/event_types.h
@src/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UIManager class in src/managers/</name>
  <files>src/managers/ui_manager.h, src/managers/ui_manager.cpp</files>
  <action>
Create the directory `src/managers/` and create the UIManager class.

**src/managers/ui_manager.h** -- The UIManager class that owns:
- All 7 panel unique_ptrs: ViewportPanel, LibraryPanel, PropertiesPanel, ProjectPanel, GCodePanel, CutOptimizerPanel, StartPage
- Both dialog unique_ptrs: FileDialog, LightingDialog
- All 7 visibility booleans: m_showViewport, m_showLibrary, m_showProperties, m_showProject, m_showGCode, m_showCutOptimizer, m_showStartPage
- Restart popup state: m_showRestartPopup, m_firstFrame
- NOTE: ConfigWatcher stays in Application until Plan 03 extracts it to ConfigManager. Do NOT add ConfigWatcher to UIManager.

Constructor signature:
```cpp
UIManager(EventBus* eventBus,
          LibraryManager* libraryManager,
          ProjectManager* projectManager,
          Workspace* workspace);
```

Public methods to extract from Application:
- `bool init(SDL_Window* window, void* glContext)` -- creates all panels, dialogs, applies initial config to viewport render settings, restores visibility from Config, restores last selected model. This absorbs lines 189-295 from application.cpp
- `void shutdown()` -- destroys panels and dialogs in correct order (lines 1039-1051)
- `void renderMenuBar(...)` -- the menu bar rendering. Takes callback functors for File menu actions (onImport, onExport, onNewProject, onOpenProject, onSaveProject, onQuit) and a callback for spawnSettingsApp. View menu items toggle the internal visibility booleans directly. Edit and Help menus handled internally.
- `void renderPanels()` -- renders all panels and dialogs based on visibility flags (lines 495-533)
- `void handleKeyboardShortcuts(...)` -- takes same callback functors as renderMenuBar for triggering file operations and settings spawn (lines 764-796)
- `void renderImportProgress(ImportQueue* importQueue)` -- the import progress overlay (lines 798-841). Takes ImportQueue pointer since Application still owns ImportQueue.
- `void renderAboutDialog()` -- the About popup modal (lines 396-417)
- `void renderRestartPopup()` -- restart required popup (lines 943-968). Internally calls a relaunch callback if user clicks "Relaunch Now".
- `void setupDefaultDockLayout(ImGuiID dockspaceId)` -- dock layout setup (lines 970-997)
- `void showRestartPopup()` -- sets m_showRestartPopup = true
- `void setRelaunchCallback(std::function<void()> cb)` -- for Application to provide relaunch behavior

Panel accessors (needed by Application for wiring callbacks during init and for onModelSelected):
- `ViewportPanel* viewportPanel()`
- `LibraryPanel* libraryPanel()`
- `PropertiesPanel* propertiesPanel()`
- `ProjectPanel* projectPanel()`
- `StartPage* startPage()`
- `FileDialog* fileDialog()`
- `LightingDialog* lightingDialog()`

Visibility getters/setters for Config save/restore:
- `bool showViewport() const`, `void setShowViewport(bool)`, and same for all 7 panels

`bool isFirstFrame()` and `void setFirstFrameDone()` -- for Application's dock layout logic in render().

**src/managers/ui_manager.cpp** -- Implementation:

Move these methods from application.cpp almost verbatim:
1. `renderMenuBar()` -- lines 432-493. Adapt so File menu items call the stored callback functors. View menu items toggle m_showXxx booleans directly (they're now local members). Edit menu calls spawnSettings callback. Help menu calls internal showAboutDialog.
2. `renderPanels()` -- lines 495-533. Direct port, panels are now members of UIManager.
3. `handleKeyboardShortcuts()` -- lines 764-796. Adapt to call stored callback functors for file ops.
4. `renderImportProgress()` -- lines 798-841. Takes ImportQueue* parameter.
5. `renderAboutDialog()` -- lines 396-417 from render(). The About popup modal code.
6. `renderRestartPopup()` -- lines 943-968. If user clicks "Relaunch Now", calls m_relaunchCallback.
7. `setupDefaultDockLayout()` -- lines 970-997. Direct port.
8. `init()` -- extracts panel creation from application.cpp lines 189-295. Creates all panels (but does NOT wire StartPage callbacks -- Application wires those after both UIManager and FileIOManager exist, see Plan 02 Task 2), applies config render settings to viewport, restores visibility from Config, restores last selected model.
9. `shutdown()` -- lines 1039-1051 from application.cpp. Resets dialogs then panels in correct order.

Important design decisions:
- UIManager does NOT own ImportQueue, ThumbnailGenerator, Database, ConfigWatcher, or FileDialog at this stage. Those stay in Application (ConfigWatcher moves to ConfigManager in Plan 03, FileDialog is passed to FileIOManager in Plan 02).
- UIManager receives raw pointers to LibraryManager, ProjectManager, Workspace via constructor (non-owning).
- File operation callbacks (import, export, new/open/save project) are passed as std::function parameters to renderMenuBar() and handleKeyboardShortcuts(), NOT stored as members. This keeps UIManager decoupled from file operations.
- The `showAboutDialog()` method just calls `ImGui::OpenPopup("About Digital Workshop")`.
- Use `#pragma once`, `namespace dw { }`, follow project conventions (snake_case files, PascalCase classes, m_ prefix).
- Keep the class under 400 lines for the header and under 800 lines for the .cpp (per project file size limits).

NOTE: The existing `src/ui/ui_manager.h` is a DIFFERENT class. Application.cpp does NOT use it (confirmed by code review). Do NOT delete or modify it in this task. It will be dealt with in Phase 1.6 dead code cleanup. The new UIManager in src/managers/ has a different interface and different responsibilities. There is no name collision because they are in different directories -- if the compiler complains about ambiguity, use the full include path.
  </action>
  <verify>
The new files compile as a translation unit. Run:
```bash
cd /data/DW/build && cmake .. && cmake --build . --target digital_workshop 2>&1 | head -50
```
If build directory doesn't exist, create it first with `cmake -B build -S .`
Expect compilation to fail because application.cpp still references moved code -- that's expected and will be fixed in Task 2.
Actually, since we add the new file to CMakeLists in Task 2, verify the files exist and have correct structure:
```bash
test -f src/managers/ui_manager.h && test -f src/managers/ui_manager.cpp && echo "Files exist"
wc -l src/managers/ui_manager.h src/managers/ui_manager.cpp
```
  </verify>
  <done>
src/managers/ui_manager.h exists with UIManager class declaration containing panel ownership, visibility state, and all extracted method declarations. src/managers/ui_manager.cpp exists with implementations of renderMenuBar, renderPanels, handleKeyboardShortcuts, renderImportProgress, renderAboutDialog, renderRestartPopup, setupDefaultDockLayout, init, and shutdown. Header is under 400 lines, cpp is under 800 lines.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate UIManager into Application and update build</name>
  <files>src/app/application.h, src/app/application.cpp, src/CMakeLists.txt</files>
  <action>
**src/CMakeLists.txt:**
Add `managers/ui_manager.cpp` to DW_SOURCES list, after the UI section (around line 76):
```
    # Managers
    managers/ui_manager.cpp
```

**src/app/application.h:**
1. Remove forward declarations that are now UIManager's responsibility: ViewportPanel, LibraryPanel, PropertiesPanel, ProjectPanel, GCodePanel, CutOptimizerPanel, StartPage, FileDialog, LightingDialog
2. Add forward declaration: `class UIManager;` (in the dw namespace, pointing to the managers/ version)
3. Remove all 7 panel unique_ptr members (m_viewportPanel through m_startPage)
4. Remove both dialog unique_ptrs (m_fileDialog, m_lightingDialog)
5. Remove all 7 visibility booleans (m_showViewport through m_showStartPage)
6. Remove m_showRestartPopup, m_firstFrame
7. Add `std::unique_ptr<UIManager> m_uiManager;` member (in the "Core systems" section)
8. Remove method declarations that moved to UIManager: renderMenuBar, renderPanels, handleKeyboardShortcuts, renderImportProgress, showAboutDialog, renderRestartPopup, setupDefaultDockLayout
9. Keep: setupMenus (remove if unused), onImportModel, onExportModel, onNewProject, onOpenProject, onSaveProject, onModelSelected, onFilesDropped, processCompletedImports, onConfigFileChanged, applyConfig, spawnSettingsApp, relaunchApp, saveWorkspaceState, onOpenRecentProject

**src/app/application.cpp:**
1. Add `#include "managers/ui_manager.h"` (use relative path `../managers/ui_manager.h` based on include structure)
2. Remove includes that are only needed by UIManager (panel headers, dialog headers) -- only if Application no longer uses them directly. Keep includes for types used in remaining Application methods.

**In Application::init():**
- Keep SDL/OpenGL/ImGui initialization (lines 58-157) -- Application still owns the window and GL context
- Keep EventBus, Database, Schema, LibraryManager, ProjectManager, Workspace, ThumbnailGenerator, ImportQueue creation (lines 159-186)
- Replace panel creation block (lines 189-295) with UIManager creation and init:
```cpp
// Create UIManager (owns all panels, dialogs, visibility state)
m_uiManager = std::make_unique<UIManager>(
    m_eventBus.get(),
    m_libraryManager.get(),
    m_projectManager.get(),
    m_workspace.get()
);
if (!m_uiManager->init(m_window, m_glContext)) {
    return false;
}

// Wire callbacks that cross manager boundaries
m_uiManager->libraryPanel()->setOnModelSelected([this](int64_t modelId) {
    if (!m_libraryManager) return;
    auto record = m_libraryManager->getModel(modelId);
    if (record && m_uiManager->propertiesPanel()) {
        m_uiManager->propertiesPanel()->setModelRecord(*record);
    }
});
m_uiManager->libraryPanel()->setOnModelOpened([this](int64_t id) { onModelSelected(id); });
m_uiManager->projectPanel()->setOnModelSelected([this](int64_t id) { onModelSelected(id); });
m_uiManager->propertiesPanel()->setOnMeshModified([this]() {
    auto mesh = m_workspace->getFocusedMesh();
    if (mesh && m_uiManager->viewportPanel()) {
        m_uiManager->viewportPanel()->setMesh(mesh);
    }
});
m_uiManager->propertiesPanel()->setOnColorChanged([this](const Color& color) {
    if (m_uiManager->viewportPanel()) {
        m_uiManager->viewportPanel()->renderSettings().objectColor = color;
    }
});
m_uiManager->projectPanel()->setOpenProjectCallback([this]() { onOpenProject(); });
m_uiManager->projectPanel()->setSaveProjectCallback([this]() { onSaveProject(); });

// Set up config file watcher for live reload
m_configWatcher = std::make_unique<ConfigWatcher>();
m_configWatcher->setOnChanged([this]() { onConfigFileChanged(); });
m_configWatcher->watch(Config::instance().configFilePath());
m_lastAppliedUiScale = cfg.getUiScale();

// Set relaunch callback for restart popup
m_uiManager->setRelaunchCallback([this]() { relaunchApp(); });
```

Note: The GCode panel FileDialog wiring (`m_gcodePanel->setFileDialog(m_fileDialog.get())`) must move into UIManager::init() since UIManager now owns both.

**In Application::render():**
Replace the inline ImGui frame management and panel rendering with delegation:
```cpp
void Application::render() {
    m_uiManager->beginFrame();  // NOTE: UIManager doesn't have beginFrame/endFrame in our design
    // Actually, Application still owns the ImGui frame lifecycle since it owns the GL context
    ImGui_ImplOpenGL3_NewFrame();
    ImGui_ImplSDL2_NewFrame();
    ImGui::NewFrame();

    ImGuiID dockspaceId = ImGui::DockSpaceOverViewport(0, ImGui::GetMainViewport());

    if (m_uiManager->isFirstFrame()) {
        m_uiManager->setFirstFrameDone();
        if (ImGui::DockBuilderGetNode(dockspaceId) == nullptr ||
            ImGui::DockBuilderGetNode(dockspaceId)->IsLeafNode()) {
            m_uiManager->setupDefaultDockLayout(dockspaceId);
        }
    }

    m_uiManager->handleKeyboardShortcuts(
        [this]() { onImportModel(); },
        [this]() { onExportModel(); },
        [this]() { onNewProject(); },
        [this]() { onOpenProject(); },
        [this]() { onSaveProject(); },
        [this]() { spawnSettingsApp(); },
        m_uiManager->lightingDialog()
    );

    m_uiManager->renderMenuBar(
        [this]() { onImportModel(); },
        [this]() { onExportModel(); },
        [this]() { onNewProject(); },
        [this]() { onOpenProject(); },
        [this]() { onSaveProject(); },
        [this]() { quit(); },
        [this]() { spawnSettingsApp(); },
        m_uiManager->lightingDialog()
    );

    m_uiManager->renderPanels();
    m_uiManager->renderImportProgress(m_importQueue.get());
    m_uiManager->renderRestartPopup();
    m_uiManager->renderAboutDialog();

    ImGui::Render();
    int displayW = 0, displayH = 0;
    SDL_GL_GetDrawableSize(m_window, &displayW, &displayH);
    glViewport(0, 0, displayW, displayH);
    glClearColor(0.1f, 0.1f, 0.1f, 1.0f);
    glClear(GL_COLOR_BUFFER_BIT);
    ImGui_ImplOpenGL3_RenderDrawData(ImGui::GetDrawData());

    SDL_GL_SwapWindow(m_window);
}
```

**In Application::processEvents():**
Replace `ImGui_ImplSDL2_ProcessEvent(&event)` with delegation if UIManager wraps it, or keep as-is since Application owns the SDL event loop. Keep as-is -- Application still processes SDL events directly.

**In Application::update():**
Keep as-is (processCompletedImports + config watcher poll).

**In Application::onModelSelected():**
Update references: `m_viewportPanel` becomes `m_uiManager->viewportPanel()`, `m_propertiesPanel` becomes `m_uiManager->propertiesPanel()`.

**In Application::processCompletedImports():**
Update references: panel access goes through m_uiManager.

**In Application::applyConfig():**
Update references: viewport panel accessed through `m_uiManager->viewportPanel()`. Restart popup triggered through `m_uiManager->showRestartPopup()`.

**In Application::saveWorkspaceState():**
Read visibility state from UIManager: `m_uiManager->showViewport()`, etc. Read last selected model from `m_uiManager->libraryPanel()->selectedModelId()`.

**In Application::shutdown():**
Replace explicit panel/dialog resets with UIManager reset:
```cpp
m_uiManager.reset();  // Destroys panels, dialogs in UIManager::shutdown()
m_configWatcher.reset();
```

**Delete these methods from application.cpp** (they now live in UIManager):
- renderMenuBar() (lines 432-493)
- renderPanels() (lines 495-533)
- handleKeyboardShortcuts() (lines 764-796)
- renderImportProgress() (lines 798-841)
- showAboutDialog() (lines 760-762)
- renderRestartPopup() (lines 943-968)
- setupDefaultDockLayout() (lines 970-997)

**Verify the design is clean:**
- Application does NOT include individual panel headers anymore (except those needed for callback wiring types like Color, MeshPtr)
- Application's only UI interaction is through m_uiManager
- Callback functors passed to UIManager methods mean UIManager doesn't need to know about FileIOManager
  </action>
  <verify>
Build the project and run all tests:
```bash
cd /data/DW/build && cmake .. && cmake --build . 2>&1 | tail -20
cd /data/DW/build && ctest --output-on-failure 2>&1 | tail -30
```
All 387+ tests must pass. Zero warnings from the new code. Application.cpp should now be shorter -- measure:
```bash
wc -l src/app/application.cpp src/app/application.h src/managers/ui_manager.cpp src/managers/ui_manager.h
```
  </verify>
  <done>
Application.cpp compiles and links with UIManager delegation. All 387+ existing tests pass. Application.cpp is measurably shorter (target: ~700-750 lines after UIManager extraction, down from 1,080). All panels render through UIManager. Menu bar, keyboard shortcuts, import progress overlay, about dialog, restart popup, and dock layout all work through UIManager delegation.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with zero errors and zero new warnings
2. All existing tests pass (387+)
3. Application.cpp is shorter by ~300-350 lines
4. src/managers/ui_manager.h and .cpp exist and follow project conventions
5. No duplicate panel ownership -- panels are owned exclusively by UIManager
6. Visibility state lives exclusively in UIManager (no duplication in Application)
</verification>

<success_criteria>
- Application.cpp reduced by ~300-350 lines (from 1,080 to ~700-750)
- UIManager owns all 7 panels, 2 dialogs, 7 visibility flags
- All panel rendering delegated through UIManager
- Menu bar, shortcuts, popups, import progress all delegated
- Build compiles and links successfully
- All 387+ tests pass with zero regressions
- No behavioral changes visible to the user
</success_criteria>

<output>
After completion, create `.planning/phases/01.4-godclass/1.4-01-SUMMARY.md`
</output>

---
phase: 03-manual-control
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/ui/panels/cnc_console_panel.h
  - src/ui/panels/cnc_console_panel.cpp
autonomous: true
requirements: [CUI-10]
must_haves:
  truths:
    - "User can type a G-code command in the MDI console input field"
    - "Pressing Enter sends the command via CncController::sendCommand()"
    - "User can navigate command history with up/down arrows in the input field"
    - "GRBL responses (ok, error, messages) appear in the scrollable response area"
    - "Console auto-scrolls to latest response"
  artifacts:
    - path: "src/ui/panels/cnc_console_panel.h"
      provides: "CncConsolePanel class declaration with history management"
      contains: "class CncConsolePanel"
    - path: "src/ui/panels/cnc_console_panel.cpp"
      provides: "MDI console with input, history callback, and response display"
      min_lines: 120
  key_links:
    - from: "src/ui/panels/cnc_console_panel.cpp"
      to: "src/core/cnc/cnc_controller.h"
      via: "sendCommand() for user-entered G-code"
      pattern: "sendCommand"
---

<objective>
Build the CncConsolePanel — an MDI console with single-line G-code input, command history navigation, and response display.

Purpose: Allows the operator to send arbitrary G-code commands and see machine responses, essential for setup, debugging, and advanced operations.

Output: New CncConsolePanel class with input field, history, and response area.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-manual-control/03-RESEARCH.md
@.planning/phases/03-manual-control/03-01-SUMMARY.md
@src/core/cnc/cnc_controller.h
@src/core/cnc/cnc_types.h
@src/ui/panels/panel.h
@src/ui/panels/cnc_status_panel.h
@src/ui/panels/cnc_status_panel.cpp
@src/ui/icons.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CncConsolePanel with MDI input, history, and response display</name>
  <files>src/ui/panels/cnc_console_panel.h, src/ui/panels/cnc_console_panel.cpp</files>
  <action>
Create CncConsolePanel extending Panel. This is the MDI (Manual Data Input) console for sending ad-hoc G-code.

**cnc_console_panel.h:**
```cpp
class CncConsolePanel : public Panel {
public:
    CncConsolePanel();
    ~CncConsolePanel() override = default;
    void render() override;

    void setCncController(CncController* cnc) { m_cnc = cnc; }
    void onConnectionChanged(bool connected, const std::string& version);

    // Called for every raw line from GRBL (both sent and received)
    void onRawLine(const std::string& line, bool isSent);
    // Called on GRBL errors and messages
    void onError(const std::string& message);
    void onAlarm(int code, const std::string& desc);

private:
    static int inputCallback(ImGuiInputTextCallbackData* data);

    CncController* m_cnc = nullptr;
    bool m_connected = false;

    // Input
    char m_inputBuf[256] = "";
    bool m_focusInput = false;

    // Command history
    std::vector<std::string> m_history;
    int m_historyPos = -1; // -1 = new input, 0..N-1 = browsing history
    static constexpr size_t MAX_HISTORY = 100;

    // Response display
    struct ConsoleLine {
        std::string text;
        enum Type { Sent, Received, Error, Info } type;
    };
    std::deque<ConsoleLine> m_lines;
    bool m_autoScroll = true;
    bool m_scrollToBottom = false;
    static constexpr size_t MAX_LINES = 500;
};
```

**cnc_console_panel.cpp:**

Constructor: `CncConsolePanel() : Panel("MDI Console") {}`

`render()`:
1. Begin window with Panel pattern (if !m_open return, Begin/End).
2. If not connected, show "Connect to CNC machine to use console" in gray text. End early.
3. **Response area** (takes most of the space): Use `ImGui::BeginChild("ConsoleOutput", ImVec2(0, -ImGui::GetFrameHeightWithSpacing() - 4), true)` to create a scrollable region above the input.
   - Iterate m_lines, color-code by type:
     - Sent: cyan/light blue text, prefix with "> "
     - Received: white/default text
     - Error: red text
     - Info: yellow text
   - If m_autoScroll && m_scrollToBottom, call `ImGui::SetScrollHereY(1.0f)` and reset flag.
   - EndChild().
4. **Input line**: Full-width InputText with flags:
   - `ImGuiInputTextFlags_EnterReturnsTrue` — send on Enter
   - `ImGuiInputTextFlags_CallbackHistory` — up/down arrow history
   - `ImGuiInputTextFlags_CallbackAlways` — needed for some ImGui versions
   Use `ImGui::SetNextItemWidth(-1)` for full width.
   When Enter pressed (InputText returns true):
   - Trim whitespace from input
   - If non-empty: add to history (push_back, trim to MAX_HISTORY), send via `m_cnc->sendCommand(cmd)`, add to console lines as Sent type
   - Clear input buffer
   - Reset historyPos to -1
   - Set m_focusInput = true to refocus
5. If m_focusInput: `ImGui::SetKeyboardFocusHere(-1)`, reset flag.

`inputCallback()` (static): Handle history navigation.
- Get CncConsolePanel* from `data->UserData`.
- On `ImGuiInputTextFlags_CallbackHistory`:
  - UpArrow: increment historyPos (clamped to history.size()-1). If valid, replace buffer with history entry from end (history[size-1-pos]).
  - DownArrow: decrement historyPos (clamped to -1). If -1, clear buffer. Otherwise set from history.
  - Use `data->DeleteChars(0, data->BufTextLen)` and `data->InsertChars(0, entry)` to update.

`onRawLine()`: Add line to m_lines with type Sent (if isSent) or Received. Set m_scrollToBottom = true. Trim to MAX_LINES.

`onError()`: Add line with type Error. Set m_scrollToBottom.

`onAlarm()`: Add formatted "ALARM:{code} - {desc}" line with type Error. Set m_scrollToBottom.

`onConnectionChanged()`: Store m_connected. On connect, add Info line "Connected to GRBL". On disconnect, add Info line "Disconnected".

**Important:** The `onRawLine` callback is already fired by CncController for every line sent and received. This gives the console full visibility into the GRBL conversation without needing a separate mechanism.

**Important:** Disable the send functionality (gray out input or show message) when m_cnc is nullptr or when the machine is streaming (m_cnc->isStreaming()). MDI during streaming corrupts character-counting. Show "Cannot send commands during active job" tooltip if streaming.
  </action>
  <verify>Build compiles: `cd build && cmake --build . 2>&1 | tail -20` — no errors. Verify files exist: `ls src/ui/panels/cnc_console_panel.*`</verify>
  <done>CncConsolePanel renders MDI console with: text input field that sends on Enter, up/down arrow command history navigation, scrollable response display with color-coded lines (sent/received/error), auto-scroll, and streaming guard</done>
</task>

</tasks>

<verification>
- [ ] CncConsolePanel compiles
- [ ] Input field sends commands via sendCommand() on Enter
- [ ] Up/Down arrow navigates command history
- [ ] Response area shows sent commands, GRBL responses, and errors with color coding
- [ ] Console auto-scrolls to newest output
- [ ] MDI input disabled during streaming
- [ ] Disconnected state shows appropriate message
</verification>

<success_criteria>
CncConsolePanel provides a complete MDI console: user types G-code, presses Enter to send, sees response, navigates history with arrows. All GRBL communication visible. Streaming guard prevents corruption.
</success_criteria>

<output>
After completion, create `.planning/phases/03-manual-control/03-02-SUMMARY.md`
</output>

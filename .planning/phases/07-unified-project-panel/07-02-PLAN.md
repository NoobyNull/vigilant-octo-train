# Plan 07-02: Cross-Panel Navigation Wiring

## Goal
Wire the ProjectPanel navigation callbacks so clicking any asset navigates to the correct application panel and selects/loads that item. Add "Add to Project" context menu entries in source panels (Library, GCode, Cost, CutOptimizer).

## Context

**Existing callback pattern** (from application_wiring.cpp):
- `LibraryPanel::setOnModelSelected(callback)` → Application loads model in viewport
- `MaterialsPanel::setOnAssignMaterial(callback)` → Application assigns material to model
- All wiring happens in `Application::initWiring()` in `application_wiring.cpp`

**UIManager** owns all panels and provides access via getters. Panels are toggled visible via `setOpen(true)`.

**Navigation targets:**
- Model → `UIManager::libraryPanel()` select + `ViewportPanel` load
- G-code → `UIManager::gcodePanel()` loadFile
- Material → `UIManager::materialsPanel()` select
- Cost → `UIManager::costPanel()` select
- Cut Plan → `UIManager::cutOptimizerPanel()` load

**Files to read before implementing:**
- `src/app/application_wiring.cpp` — existing callback wiring patterns
- `src/app/application.h` — Application private methods and members
- `src/managers/ui_manager.h` — panel getters
- `src/ui/panels/library_panel.h` — model selection API
- `src/ui/panels/gcode_panel.h` — loadFile() API
- `src/ui/panels/materials_panel.h` — selection API
- `src/ui/panels/cost_panel.h` — selection API
- `src/ui/panels/cut_optimizer_panel.h` — current API (no load yet)

## Tasks

### Task 1: Add selection methods to panels that lack them

**cost_panel.h** — add:
```cpp
void selectEstimate(i64 estimateId);
```
Implementation: find index matching `estimateId` in `m_estimates`, set `m_selectedIndex`, populate edit buffers.

**cut_optimizer_panel.h** — add:
```cpp
void loadCutPlan(const CutPlanRecord& record);
```
Implementation: deserialize `record.sheetConfigJson` → `m_sheet`, `record.partsJson` → `m_parts`, `record.resultJson` → `m_result`, set `m_hasResults = true`, set algorithm from `record.algorithm`.

**gcode_panel.h** — verify `loadFile(const std::string& path)` exists (it does). Also check if there's a way to load by gcode ID rather than path. If GCodeRecord has `filePath`, use that.

**materials_panel.h** — check if there's a `selectMaterial(i64 materialId)` method. If not, add one that scrolls to and highlights the material in the grid.

### Task 2: Wire ProjectPanel navigation callbacks (application_wiring.cpp)

In `Application::initWiring()`, after the existing ProjectPanel callback wiring, add:

```cpp
// Project Panel → G-code navigation
projectPanel->setOnGCodeSelected([this](i64 gcodeId) {
    auto& gcodeRepo = /* get GCodeRepository */;
    auto record = gcodeRepo.findById(gcodeId);
    if (record) {
        auto* gcodePanel = m_uiManager->gcodePanel();
        gcodePanel->setOpen(true);
        gcodePanel->loadFile(record->filePath.string());
    }
});

// Project Panel → Material navigation
projectPanel->setOnMaterialSelected([this](i64 materialId) {
    auto* matsPanel = m_uiManager->materialsPanel();
    matsPanel->setOpen(true);
    matsPanel->selectMaterial(materialId);
});

// Project Panel → Cost navigation
projectPanel->setOnCostSelected([this](i64 estimateId) {
    auto* costPanel = m_uiManager->costPanel();
    costPanel->setOpen(true);
    costPanel->selectEstimate(estimateId);
});

// Project Panel → Cut Plan navigation
projectPanel->setOnCutPlanSelected([this](i64 planId) {
    auto& cutPlanRepo = /* get CutPlanRepository */;
    auto record = cutPlanRepo.findById(planId);
    if (record) {
        auto* optPanel = m_uiManager->cutOptimizerPanel();
        optPanel->setOpen(true);
        optPanel->loadCutPlan(*record);
    }
});
```

### Task 3: Add "Add to Project" in source panels

**Library Panel** — context menu addition:
In `library_panel.cpp` (or `library_panel_items.cpp`), in the context menu for models, add:

```cpp
if (m_projectManager && m_projectManager->currentProject()) {
    if (ImGui::MenuItem("Add to Project")) {
        m_projectManager->currentProject()->addModel(modelId);
    }
}
```

Inject `ProjectManager*` into LibraryPanel if not already available. Check existing constructor.

**GCode Panel** — add toolbar button or menu:
After loading a gcode file, show "Add to Project" button if a project is open:

```cpp
// In renderToolbar()
if (m_projectManager && m_projectManager->currentProject() && hasGCode()) {
    ImGui::SameLine();
    if (ImGui::Button("Add to Project")) {
        // Need gcode ID — look up by hash or file path
        // m_gcodeRepo->addToProject(projectId, gcodeId);
    }
}
```

This requires GCodePanel to know the current gcode record's ID. Add `i64 m_currentGCodeId = -1` and set it during `loadFile()` after importing.

**Cost Panel** — add project linking:
When creating a new estimate, if a project is open, auto-set `projectId`:

```cpp
// In new estimate creation
if (m_projectManager && m_projectManager->currentProject()) {
    newEstimate.projectId = m_projectManager->currentProject()->id();
}
```

**Cut Optimizer Panel** — "Save to Project" button (deferred to Phase 8 plan 08-01).

### Task 4: Ensure CutPlanRepository and GCodeRepository are accessible in Application

If `Application` doesn't yet own a `CutPlanRepository`, create one:

```cpp
// application.h
std::unique_ptr<CutPlanRepository> m_cutPlanRepo;

// application.cpp init()
m_cutPlanRepo = std::make_unique<CutPlanRepository>(*m_database);
```

Verify GCodeRepository ownership and pass to panels that need it.

### Task 5: Inject ProjectManager into panels that need "Add to Project"

LibraryPanel, GCodePanel, CostPanel may need a `setProjectManager(ProjectManager*)` setter or constructor injection. Follow existing pattern — check how other cross-panel dependencies are handled (e.g., how LibraryPanel accesses ThumbnailGenerator).

## Verification

1. `cmake --build build -j$(nproc)` — compiles cleanly
2. `build/tests/dw_tests` — all tests pass
3. Manual test: open project with models → click model in Project Panel → Library selects it, Viewport loads it
4. Manual test: add gcode to project → click in Project Panel → GCode panel opens and loads file
5. Manual test: right-click model in Library → "Add to Project" appears when project is open
6. Manual test: cost estimate with project_id → appears in Project Panel Costs section → clicking navigates to Cost Panel

## Files Modified

| File | Change |
|------|--------|
| `src/ui/panels/cost_panel.h` | Add `selectEstimate(i64)` |
| `src/ui/panels/cost_panel.cpp` | Implement `selectEstimate()` |
| `src/ui/panels/cut_optimizer_panel.h` | Add `loadCutPlan(CutPlanRecord)` |
| `src/ui/panels/cut_optimizer_panel.cpp` | Implement `loadCutPlan()` |
| `src/ui/panels/materials_panel.h` | Add `selectMaterial(i64)` if missing |
| `src/ui/panels/materials_panel.cpp` | Implement `selectMaterial()` |
| `src/ui/panels/library_panel.h` | Add ProjectManager*, "Add to Project" menu |
| `src/ui/panels/library_panel_items.cpp` | Add context menu item |
| `src/ui/panels/gcode_panel.h` | Add m_currentGCodeId, "Add to Project" button |
| `src/ui/panels/gcode_panel.cpp` | Implement add-to-project |
| `src/app/application.h` | Add CutPlanRepository ownership |
| `src/app/application.cpp` | Create CutPlanRepository |
| `src/app/application_wiring.cpp` | Wire 4 navigation callbacks + inject dependencies |

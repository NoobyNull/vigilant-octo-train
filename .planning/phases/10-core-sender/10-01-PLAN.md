---
phase: 10-core-sender
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/config/config.h
  - src/core/config/config.cpp
  - src/core/cnc/cnc_controller.h
  - src/core/cnc/cnc_controller.cpp
  - src/ui/panels/cnc_status_panel.h
  - src/ui/panels/cnc_status_panel.cpp
autonomous: true
requirements:
  - SND-01
  - SND-02
  - SND-03
  - SND-04
  - SND-05

must_haves:
  truths:
    - "Operator can adjust spindle speed override (0-200%) via a slider in the status panel that sends GRBL real-time commands immediately"
    - "Operator can select rapid override (25/50/100%) via buttons that send GRBL real-time rapid override commands"
    - "Coolant state (Flood/Mist/Off) is visible in the status panel and togglable via buttons that send M7/M8/M9 commands"
    - "When GRBL enters alarm state, the alarm code number and a human-readable description are displayed with an inline $X unlock button"
    - "Status polling interval is configurable (50, 100, 150, 200ms) via Config and applied at runtime on the IO thread"
  artifacts:
    - path: "src/core/config/config.h"
      provides: "Config getters/setters for status poll interval"
      contains: "getStatusPollIntervalMs"
    - path: "src/core/cnc/cnc_controller.h"
      provides: "Configurable status poll interval"
      contains: "m_statusPollMs"
    - path: "src/ui/panels/cnc_status_panel.h"
      provides: "Override controls, coolant toggles, alarm display"
      contains: "renderOverrideControls"
    - path: "src/ui/panels/cnc_status_panel.cpp"
      provides: "Spindle slider, rapid buttons, coolant buttons, alarm banner"
      contains: "CMD_SPINDLE_PLUS_10"
  key_links:
    - from: "src/ui/panels/cnc_status_panel.cpp"
      to: "src/core/cnc/cnc_controller.h"
      via: "CncController::setSpindleOverride() / setRapidOverride() / sendCommand()"
      pattern: "setSpindleOverride"
    - from: "src/core/cnc/cnc_controller.cpp"
      to: "src/core/config/config.h"
      via: "Config::instance().getStatusPollIntervalMs() for dynamic poll rate"
      pattern: "getStatusPollIntervalMs"
---

<objective>
Add override controls (spindle, rapid), coolant toggles, alarm display, and configurable status polling to the CNC status panel.

Purpose: Give the operator real-time control over spindle speed, rapid rate, and coolant while the machine runs, plus clear alarm feedback with an inline unlock button.
Output: Config keys for poll interval, override controls in status panel, coolant toggle buttons, alarm banner with description and unlock, runtime-configurable status polling.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/core/config/config.h
@src/core/config/config.cpp
@src/core/cnc/cnc_controller.h
@src/core/cnc/cnc_controller.cpp
@src/core/cnc/cnc_types.h
@src/ui/panels/cnc_status_panel.h
@src/ui/panels/cnc_status_panel.cpp

<interfaces>
From src/core/cnc/cnc_controller.h:
```cpp
class CncController {
    void setFeedOverride(int percent); // 10-200
    void setRapidOverride(int percent); // 25, 50, or 100
    void setSpindleOverride(int percent); // 10-200
    void sendCommand(const std::string& cmd); // Queue arbitrary G-code
    void unlock(); // $X
    static constexpr int STATUS_POLL_MS = 200; // Currently hardcoded
};
```

From src/core/cnc/cnc_types.h:
```cpp
struct MachineStatus {
    MachineState state = MachineState::Unknown;
    int feedOverride = 100;
    int rapidOverride = 100;
    int spindleOverride = 100;
    f32 spindleSpeed = 0.0f;
    u32 inputPins = 0;
};

// Real-time command bytes already defined:
constexpr u8 CMD_SPINDLE_100_PERCENT = 0x99;
constexpr u8 CMD_SPINDLE_PLUS_10 = 0x9A;
constexpr u8 CMD_SPINDLE_MINUS_10 = 0x9B;
constexpr u8 CMD_RAPID_100_PERCENT = 0x95;
constexpr u8 CMD_RAPID_50_PERCENT = 0x96;
constexpr u8 CMD_RAPID_25_PERCENT = 0x97;

// Alarm descriptions already exist:
inline const char* alarmDescription(int code) { ... }

// CncCallbacks:
std::function<void(int alarmCode, const std::string& desc)> onAlarm;
```

From src/ui/panels/cnc_status_panel.h:
```cpp
class CncStatusPanel : public Panel {
    void render() override;
    void onStatusUpdate(const MachineStatus& status);
    void onConnectionChanged(bool connected, const std::string& version);
    void renderStateIndicator();
    void renderDRO();
    void renderFeedSpindle();
    void renderOverrides(); // Currently display-only override percentages
    MachineStatus m_status{};
    bool m_connected = false;
};
```

From src/core/config/config.h — Meyer's singleton, INI persistence:
```cpp
class Config {
    static Config& instance();
    bool load();
    bool save();
    // Pattern: getter + setter pairs, m_field members, INI section/key in config.cpp
};
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Config key for status poll interval and make CncController use it</name>
  <files>
    src/core/config/config.h
    src/core/config/config.cpp
    src/core/cnc/cnc_controller.h
    src/core/cnc/cnc_controller.cpp
  </files>
  <action>
**Config (SND-05):**

Add getter/setter pair to Config class following the existing pattern:
- `getStatusPollIntervalMs()` / `setStatusPollIntervalMs(int)` — default: 200. Valid values: 50, 100, 150, 200.

Add private member: `int m_statusPollIntervalMs = 200;`

In config.cpp, add to the INI [CNC] section (following the existing pattern for int settings):
- Key: `status_poll_interval_ms`
- Load: read int, clamp to [50, 200]
- Save: write int

**CncController — dynamic poll interval:**

1. In `cnc_controller.h`: Remove `static constexpr int STATUS_POLL_MS = 200;` and replace with `int m_statusPollMs = 200;` member variable.

2. In `cnc_controller.h`: Add `void setStatusPollMs(int ms);` public method.

3. In `cnc_controller.cpp`: Implement `setStatusPollMs(int ms)` — simple setter: `m_statusPollMs = ms;` (no mutex needed, single writer from main thread, single reader on IO thread, int is atomic on all platforms).

4. In `ioThreadFunc()`: Change the status polling check from `if (elapsed >= STATUS_POLL_MS)` to `if (elapsed >= m_statusPollMs)`.

5. In `connect()` method: After successful connection, read `Config::instance().getStatusPollIntervalMs()` and call `setStatusPollMs()` to apply the configured value. Include `"core/config/config.h"` in cnc_controller.cpp if not already present.
  </action>
  <verify>cmake --build build -j$(nproc) 2>&1 | tail -5</verify>
  <done>Config key persists poll interval to INI, CncController uses configurable poll rate instead of hardcoded 200ms constant</done>
</task>

<task type="auto">
  <name>Task 2: Override controls, coolant toggles, and alarm display in CncStatusPanel</name>
  <files>
    src/ui/panels/cnc_status_panel.h
    src/ui/panels/cnc_status_panel.cpp
  </files>
  <action>
**CncStatusPanel header changes:**

1. Add `CncController*` dependency:
```cpp
#include "../../core/cnc/cnc_controller.h" // Forward declare if preferred, but need sendCommand
```
Add forward declaration: `class CncController;`

2. Add public methods:
```cpp
void setCncController(CncController* cnc) { m_cnc = cnc; }
void onAlarm(int alarmCode, const std::string& desc);
```

3. Add private render methods:
```cpp
void renderOverrideControls();   // Replaces renderOverrides()
void renderCoolantControls();
void renderAlarmBanner();
```

4. Add private members:
```cpp
CncController* m_cnc = nullptr;
int m_lastAlarmCode = 0;
std::string m_lastAlarmDesc;
```

5. Remove the old `renderOverrides()` declaration (it will be replaced by `renderOverrideControls()`).

**CncStatusPanel implementation — Override controls (SND-01, SND-02):**

Replace `renderOverrides()` with `renderOverrideControls()`. This is ALWAYS visible (not conditionally hidden when at 100%), because it is now interactive:

```cpp
void CncStatusPanel::renderOverrideControls() {
    ImGui::SeparatorText("Overrides");

    // Feed override — slider (10-200%)
    ImGui::TextDisabled("Feed");
    ImGui::SameLine(70);
    int feedOvr = m_status.feedOverride;
    ImGui::SetNextItemWidth(ImGui::GetContentRegionAvail().x - 50);
    if (ImGui::SliderInt("##FeedOvr", &feedOvr, 10, 200, "%d%%")) {
        if (m_cnc) m_cnc->setFeedOverride(feedOvr);
    }
    ImGui::SameLine();
    if (ImGui::SmallButton("R##Feed")) {
        if (m_cnc) m_cnc->setFeedOverride(100);
    }
    if (ImGui::IsItemHovered()) ImGui::SetTooltip("Reset to 100%%");

    // Spindle override — slider (10-200%) (SND-01)
    ImGui::TextDisabled("Spindle");
    ImGui::SameLine(70);
    int spindleOvr = m_status.spindleOverride;
    ImGui::SetNextItemWidth(ImGui::GetContentRegionAvail().x - 50);
    if (ImGui::SliderInt("##SpindleOvr", &spindleOvr, 10, 200, "%d%%")) {
        if (m_cnc) m_cnc->setSpindleOverride(spindleOvr);
    }
    ImGui::SameLine();
    if (ImGui::SmallButton("R##Spindle")) {
        if (m_cnc) m_cnc->setSpindleOverride(100);
    }
    if (ImGui::IsItemHovered()) ImGui::SetTooltip("Reset to 100%%");

    // Rapid override — 3 buttons (SND-02)
    ImGui::TextDisabled("Rapid");
    ImGui::SameLine(70);
    int rapidOvr = m_status.rapidOverride;
    auto rapidBtn = [&](const char* label, int pct) {
        bool active = (rapidOvr == pct);
        if (active) ImGui::PushStyleColor(ImGuiCol_Button, ImGui::GetStyleColorVec4(ImGuiCol_ButtonActive));
        if (ImGui::SmallButton(label)) {
            if (m_cnc) m_cnc->setRapidOverride(pct);
        }
        if (active) ImGui::PopStyleColor();
    };
    rapidBtn("25%##Rapid", 25);
    ImGui::SameLine();
    rapidBtn("50%##Rapid", 50);
    ImGui::SameLine();
    rapidBtn("100%##Rapid", 100);
}
```

**Coolant controls (SND-03):**

```cpp
void CncStatusPanel::renderCoolantControls() {
    ImGui::SeparatorText("Coolant");

    // Coolant state is not reported in standard GRBL status,
    // so we track it locally based on commands sent.
    // Buttons send M7 (Mist), M8 (Flood), M9 (Off).

    bool canSend = m_cnc && m_connected &&
                   m_status.state != MachineState::Alarm;

    if (!canSend) ImGui::BeginDisabled();

    float btnWidth = (ImGui::GetContentRegionAvail().x - ImGui::GetStyle().ItemSpacing.x * 2) / 3.0f;

    if (ImGui::Button("Flood (M8)", ImVec2(btnWidth, 0))) {
        if (m_cnc) m_cnc->sendCommand("M8");
    }
    ImGui::SameLine();
    if (ImGui::Button("Mist (M7)", ImVec2(btnWidth, 0))) {
        if (m_cnc) m_cnc->sendCommand("M7");
    }
    ImGui::SameLine();
    if (ImGui::Button("Off (M9)", ImVec2(btnWidth, 0))) {
        if (m_cnc) m_cnc->sendCommand("M9");
    }

    if (!canSend) ImGui::EndDisabled();
}
```

**Alarm display (SND-04):**

```cpp
void CncStatusPanel::renderAlarmBanner() {
    if (m_status.state != MachineState::Alarm)
        return;

    ImGui::Spacing();

    // Red banner with alarm code and description
    ImVec2 cursorPos = ImGui::GetCursorScreenPos();
    float width = ImGui::GetContentRegionAvail().x;
    float height = 50.0f;

    ImGui::GetWindowDrawList()->AddRectFilled(
        cursorPos, ImVec2(cursorPos.x + width, cursorPos.y + height),
        IM_COL32(180, 40, 40, 200), 4.0f);

    // Alarm text
    char alarmText[128];
    if (m_lastAlarmCode > 0) {
        std::snprintf(alarmText, sizeof(alarmText), "ALARM %d: %s",
                      m_lastAlarmCode, m_lastAlarmDesc.c_str());
    } else {
        std::snprintf(alarmText, sizeof(alarmText), "ALARM (unknown code)");
    }
    ImVec2 textSize = ImGui::CalcTextSize(alarmText);
    float textX = cursorPos.x + 8.0f;
    float textY = cursorPos.y + (height - textSize.y) * 0.5f - 8.0f;
    ImGui::GetWindowDrawList()->AddText(
        ImVec2(textX, textY), IM_COL32(255, 255, 255, 255), alarmText);

    ImGui::Dummy(ImVec2(width, height - 28.0f));

    // Inline unlock button
    if (ImGui::Button("Unlock ($X)", ImVec2(110, 0))) {
        if (m_cnc) m_cnc->unlock();
    }
    ImGui::SameLine();
    ImGui::TextDisabled("Clear alarm state to continue");
}

void CncStatusPanel::onAlarm(int alarmCode, const std::string& desc) {
    m_lastAlarmCode = alarmCode;
    m_lastAlarmDesc = desc;
}
```

**Update render() call order:**

In `render()`, update the call sequence after the connected check:

```cpp
renderStateIndicator();
renderAlarmBanner();       // Show alarm banner right after state (SND-04)
ImGui::Spacing();
renderDRO();
ImGui::Spacing();
renderFeedSpindle();
renderOverrideControls();  // Replaces renderOverrides() (SND-01, SND-02)
renderCoolantControls();   // New (SND-03)
```

Remove the call to `renderOverrides()` and delete the old `renderOverrides()` method implementation.

**Wire onAlarm callback:**
The application wiring (application.cpp) already wires onAlarm to the GCodePanel. The same callback should ALSO update CncStatusPanel. This is done by the application — add a note in the summary that `onAlarm` needs wiring. For now, ensure the method exists so the compile succeeds. Include `"core/cnc/cnc_controller.h"` at the top of cnc_status_panel.cpp.

Note: The CncStatusPanel does NOT currently have a setCncController. Add it per the header changes above. The application wiring code in application.cpp will need to call `m_cncStatusPanel->setCncController(m_cncController.get())` and wire the onAlarm callback. Since application.cpp is NOT in this plan's files_modified, add a clearly-documented TODO comment in cnc_status_panel.h:
```cpp
// NOTE: Application must wire setCncController() and onAlarm() callback
```

Actually — better approach: since we need to call m_cnc methods from the panel, we need the application to wire this. Check if application.cpp already wires the status panel. Search for `m_cncStatusPanel` in application.cpp to confirm. If it does, add the setCncController and onAlarm wiring there. If that means touching application.cpp, add it to the files list.

**IMPORTANT:** You MUST check application.cpp for existing wiring patterns and add the setCncController() call and onAlarm callback wiring. Add application.cpp to the files you modify if needed.
  </action>
  <verify>cmake --build build -j$(nproc) 2>&1 | tail -5</verify>
  <done>
- Spindle override slider (0-200%) sends real-time commands immediately
- Rapid override buttons (25/50/100%) highlight active state and send commands
- Coolant buttons (Flood M8, Mist M7, Off M9) visible in status panel
- Alarm state shows alarm code, description, and inline Unlock button
- Feed override slider visible alongside spindle override
- All controls interact with CncController methods
  </done>
</task>

</tasks>

<verification>
- cmake --build build -j$(nproc) — builds without errors
- ctest --test-dir build --output-on-failure — all existing tests pass
</verification>

<success_criteria>
- Spindle override slider sends GRBL real-time spindle override commands (0x9A/0x9B)
- Rapid override buttons send GRBL rapid override commands (0x95/0x96/0x97)
- Coolant toggle buttons send M7/M8/M9 G-code commands
- Alarm banner shows alarm code + human-readable description + $X unlock button
- Status polling interval is configurable via Config and applied at runtime
- Override section is always visible (not hidden when at 100%)
</success_criteria>

<output>
After completion, create `.planning/phases/10-core-sender/10-01-SUMMARY.md`
</output>

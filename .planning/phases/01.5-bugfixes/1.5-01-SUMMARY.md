---
phase: 01.5-bugfixes
plan: 01
subsystem: render
tags: [bugfix, performance, correctness, graphics]
dependency_graph:
  requires: []
  provides: [shader-uniform-cache-fix, normal-matrix-fix, setMat3-method]
  affects: [render-pipeline, lighting-system]
tech_stack:
  added: []
  patterns: [std::optional-cache, normal-matrix-computation]
key_files:
  created: []
  modified:
    - src/render/shader.h
    - src/render/shader.cpp
    - src/render/renderer.cpp
    - src/render/shader_sources.h
decisions:
  - decision: Use std::optional<GLint> for uniform cache instead of GLint
    rationale: Distinguishes "not cached" from "cached as -1", allows caching not-found uniforms
    alternatives: [magic-sentinel-value, separate-not-found-set]
    impact: Eliminates repeated glGetUniformLocation calls for missing uniforms
  - decision: Compute normal matrix as transpose(inverse(mat3(model))) on CPU
    rationale: Correct for non-uniform scaling, GPU inverse is expensive
    alternatives: [shader-side-computation, assume-uniform-scaling]
    impact: Correct lighting for all model transforms
metrics:
  duration: 2m 8s
  tasks_completed: 2
  files_modified: 4
  commits: 2
  tests_passing: 421/422
  completed_date: 2026-02-09
---

# Phase 1.5 Plan 01: Fix Shader Uniform Cache and Normal Matrix Bugs

Fixed shader uniform cache semantics (BUG-04) and normal matrix computation for non-uniform scaling (BUG-07).

## Summary

**One-liner:** Shader uniform cache now properly caches not-found locations using std::optional, and normal matrix is computed correctly as transpose(inverse(mat3(model))) for accurate lighting under non-uniform scaling.

Fixed two rendering bugs:
- **BUG-04**: Shader uniform cache only stored valid locations, causing glGetUniformLocation to be called every frame for missing uniforms (e.g., debug uniforms)
- **BUG-07**: Normal matrix was incorrectly using the full model matrix instead of transpose(inverse(mat3(model))), causing incorrect lighting for non-uniformly scaled models

Both fixes improve performance (BUG-04) and correctness (BUG-07) with minimal code changes.

## What Was Done

### Task 1: Fix Shader Uniform Cache with std::optional and Add setMat3

**Changes:**
- `src/render/shader.h`:
  - Added `#include <optional>`
  - Changed uniform cache type from `std::unordered_map<std::string, GLint>` to `std::unordered_map<std::string, std::optional<GLint>>`
  - Added `setMat3(const std::string& name, const glm::mat3& value)` method declaration
- `src/render/shader.cpp`:
  - Updated `getUniformLocation()` to cache ALL lookups:
    - Cache hit: return `it->second.value_or(-1)`
    - Cache miss: cache result as `std::optional<GLint>{location}` for valid locations, `std::nullopt` for -1
  - Implemented `setMat3()` using `glUniformMatrix3fv`

**Result:** Uniform cache now properly stores not-found locations, eliminating repeated GPU driver calls for missing uniforms.

**Commit:** `9a95b7a` - fix(1.5-01): fix shader uniform cache with std::optional and add setMat3

### Task 2: Fix Normal Matrix Computation in Renderer and Shader

**Changes:**
- `src/render/renderer.cpp`:
  - Replaced `m_meshShader.setMat4("uNormalMatrix", modelMatrix)` with:
    ```cpp
    glm::mat3 normalMatrix = glm::transpose(glm::inverse(glm::mat3(modelMatrix)));
    m_meshShader.setMat3("uNormalMatrix", normalMatrix);
    ```
- `src/render/shader_sources.h` (MESH_VERTEX shader):
  - Changed `uniform mat4 uNormalMatrix;` to `uniform mat3 uNormalMatrix;`
  - Changed `vNormal = mat3(uNormalMatrix) * aNormal;` to `vNormal = uNormalMatrix * aNormal;`

**Result:** Normal matrix now correctly handles non-uniform scaling, ensuring accurate lighting calculations.

**Commit:** `3cec065` - fix(1.5-01): fix normal matrix for correct lighting under non-uniform scaling

## Deviations from Plan

None - plan executed exactly as written.

## Verification

1. Full project build succeeded: Both `digital_workshop` and `dw_tests` targets built without errors
2. All existing tests pass: 421/422 tests passing (422nd test is clang-format linting for unrelated file)
3. Shader uniform cache uses std::optional pattern: Verified via grep
4. Normal matrix computed correctly: Verified glm::transpose(glm::inverse()) in renderer.cpp
5. Shader and renderer agree on mat3 type: Verified `uniform mat3 uNormalMatrix` in shader, `setMat3` in renderer

## Technical Notes

### BUG-04: Uniform Cache Semantics

**Problem:** The original cache implementation:
```cpp
if (location != -1) {
    m_uniformCache[name] = location;
}
```
Only cached valid locations. When a uniform doesn't exist (returns -1), it wasn't cached, causing `glGetUniformLocation` to be called every frame.

**Solution:** Use `std::optional<GLint>` to distinguish "not cached" from "cached as -1":
- Valid location: `std::optional<GLint>{location}`
- Not found: `std::nullopt` (still cached)
- Retrieval: `it->second.value_or(-1)` returns -1 for nullopt

**Impact:** Eliminates repeated GPU driver calls for debug/optional uniforms that don't exist in the shader.

### BUG-07: Normal Matrix for Non-Uniform Scaling

**Problem:** The renderer was passing the full model matrix as the normal matrix:
```cpp
m_meshShader.setMat4("uNormalMatrix", modelMatrix);
```
This is incorrect for non-uniform scaling because normals transform differently than positions.

**Solution:** Compute the proper normal matrix:
```cpp
glm::mat3 normalMatrix = glm::transpose(glm::inverse(glm::mat3(modelMatrix)));
```

**Why This Works:**
- `mat3(modelMatrix)` extracts the upper-left 3x3 rotation/scale portion
- `inverse()` handles the scaling component
- `transpose()` corrects for the fact that normals are covariant (not contravariant like positions)

**Impact:** Lighting now works correctly for models with non-uniform scaling (e.g., stretched or squashed models).

## Integration Points

- **Shader class**: Now provides `setMat3` for mat3 uniform uploads (used by renderer)
- **Renderer**: Uses new normal matrix computation and setMat3 method
- **Shaders**: MESH_VERTEX shader declares `uniform mat3 uNormalMatrix` matching renderer expectations

## Future Considerations

1. **Performance:** Normal matrix inverse is O(nÂ³). For extremely high frame rates with many draw calls, consider caching the normal matrix when the model matrix hasn't changed.
2. **Debugging:** The uniform cache now silently caches not-found locations. Consider adding debug logging (disabled in release) to warn about missing uniforms on first lookup.
3. **Mat3 Alias:** Consider adding `using Mat3 = glm::mat3;` to `core/types.h` for consistency with existing Mat4 alias.

## Self-Check: PASSED

### Files Modified (all exist):
```bash
FOUND: /data/DW/src/render/shader.h
FOUND: /data/DW/src/render/shader.cpp
FOUND: /data/DW/src/render/renderer.cpp
FOUND: /data/DW/src/render/shader_sources.h
```

### Commits Exist:
```bash
FOUND: 9a95b7a (Task 1: shader uniform cache fix)
FOUND: 3cec065 (Task 2: normal matrix fix)
```

### Verification Commands:
```bash
# Verify std::optional in cache
$ grep "std::optional<GLint>" src/render/shader.h
# Line 48: mutable std::unordered_map<std::string, std::optional<GLint>> m_uniformCache;

# Verify setMat3 exists
$ grep "setMat3" src/render/shader.h src/render/shader.cpp
# shader.h:40: void setMat3(const std::string& name, const glm::mat3& value);
# shader.cpp:126: void Shader::setMat3(const std::string& name, const glm::mat3& value) {

# Verify normal matrix computation
$ grep "glm::transpose.*glm::inverse" src/render/renderer.cpp
# Line 109: glm::mat3 normalMatrix = glm::transpose(glm::inverse(glm::mat3(modelMatrix)));

# Verify shader uniform type
$ grep "uniform mat3 uNormalMatrix" src/render/shader_sources.h
# Line 17: uniform mat3 uNormalMatrix;

# Verify tests pass
$ cd /data/DW/build && ./tests/dw_tests 2>&1 | grep "PASSED"
# [  PASSED  ] 421 tests.
```

All files exist, all commits present, all claims verified.

---

**Status:** COMPLETE
**Date:** 2026-02-09
**Duration:** 2m 8s
**Bugs Fixed:** BUG-04 (shader uniform cache), BUG-07 (normal matrix)

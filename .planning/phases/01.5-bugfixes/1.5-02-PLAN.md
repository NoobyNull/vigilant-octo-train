---
phase: 01.5-bugfixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/panels/viewport_panel.h
  - src/ui/panels/viewport_panel.cpp
autonomous: true

must_haves:
  truths:
    - "ViewCube geometry is not recomputed when camera yaw and pitch are unchanged between frames"
    - "ViewCube renders identically to pre-cache behavior (same faces, labels, hit testing)"
    - "ViewCube cache invalidates when camera orientation changes"
  artifacts:
    - path: "src/ui/panels/viewport_panel.h"
      provides: "ViewCubeCache struct as private member of ViewportPanel"
      contains: "ViewCubeCache"
    - path: "src/ui/panels/viewport_panel.cpp"
      provides: "Cache-aware renderViewCube that skips geometry recomputation when camera unchanged"
      contains: "m_viewCubeCache"
  key_links:
    - from: "src/ui/panels/viewport_panel.cpp"
      to: "src/render/camera.h"
      via: "camera yaw/pitch read for cache invalidation"
      pattern: "m_camera\\.yaw\\(\\)|m_camera\\.pitch\\(\\)"
---

<objective>
Fix BUG-01: Cache ViewCube geometry to avoid per-frame recomputation when camera is stationary.

Purpose: The ViewCube in the viewport panel recomputes all 8 projected vertices, 8 depth values, and 6 face sort orders every frame even when the camera hasn't moved. This wastes CPU time on trigonometry and sorting that only changes when the user orbits the camera. Caching the geometry and invalidating on camera change eliminates redundant computation.

Output: ViewCube renders with cached geometry, recomputing only when camera yaw or pitch change beyond a small epsilon threshold.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01.5-bugfixes/1.5-RESEARCH.md
@src/ui/panels/viewport_panel.h
@src/ui/panels/viewport_panel.cpp
@src/render/camera.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ViewCube geometry cache to ViewportPanel</name>
  <files>src/ui/panels/viewport_panel.h, src/ui/panels/viewport_panel.cpp</files>
  <action>
BUG-01: renderViewCube() (viewport_panel.cpp:274-447) recomputes all geometry every frame. Add caching.

**Step 1 — Add cache struct to viewport_panel.h:**

Add a private struct and member to ViewportPanel:
```cpp
// ViewCube geometry cache — invalidated when camera orientation changes
struct ViewCubeCache {
    f32 lastYaw = -999.0f;
    f32 lastPitch = -999.0f;
    std::array<ImVec2, 8> projectedVerts{};
    std::array<f32, 8> depths{};
    struct FaceSort {
        int index;
        f32 avgZ;
    };
    std::array<FaceSort, 6> sortedFaces{};
    bool valid = false;
};
```

Add as private member: `ViewCubeCache m_viewCubeCache;`

Add `#include <array>` to viewport_panel.h if not present. The `ImVec2` type requires `#include <imgui.h>` — check if already included via panel.h or add forward declaration. Since ImVec2 is a simple struct with `float x, y`, it needs imgui.h. The panel.h base class likely already includes it — verify before adding.

**Step 2 — Restructure renderViewCube() in viewport_panel.cpp:**

The function currently has three logical sections:
1. Lines 274-366: Geometry computation (vertices, projection, sorting)
2. Lines 368-405: Hit testing (mouse interaction)
3. Lines 407-447: Drawing (ImDrawList calls) and click handling

Restructure to:

```
void ViewportPanel::renderViewCube() {
    // Constants (keep as-is)
    constexpr f32 kCubeSize = 30.0f;
    // ... all existing constants ...

    // Face definitions (keep as-is, these are static data)
    const std::array<Face, 6> faces = {{ ... }};

    // --- Cache check: skip geometry if camera unchanged ---
    f32 yaw = m_camera.yaw();
    f32 pitch = m_camera.pitch();
    constexpr f32 kEpsilon = 0.001f;

    // Get viewport rect BEFORE cache check (needed for origin)
    ImVec2 rectMin = ImGui::GetItemRectMin();
    ImVec2 rectMax = ImGui::GetItemRectMax();
    ImVec2 origin = {rectMax.x - kMargin - kCubeSize, rectMin.y + kMargin + kCubeSize};

    if (!m_viewCubeCache.valid ||
        std::abs(yaw - m_viewCubeCache.lastYaw) > kEpsilon ||
        std::abs(pitch - m_viewCubeCache.lastPitch) > kEpsilon) {

        // Recompute geometry (existing code from lines 322-366)
        // Store results into m_viewCubeCache.projectedVerts, depths, sortedFaces
        // ...rotation, projection, sorting...

        m_viewCubeCache.lastYaw = yaw;
        m_viewCubeCache.lastPitch = pitch;
        m_viewCubeCache.valid = true;
    }

    // IMPORTANT: Projected verts are relative to origin, which depends on
    // the viewport rect position that can change (e.g., window resize/move).
    // Two approaches:
    //   A) Cache in viewport-local coordinates, add origin offset at draw time
    //   B) Cache absolute coordinates, invalidate on origin change
    //
    // Use approach A: cache OFFSETS from origin (just r.x * kCubeSize, -r.y * kCubeSize)
    // then add origin at draw time. This avoids invalidation on window move.

    // Apply origin offset to cached verts for drawing
    std::array<ImVec2, 8> proj;
    for (int i = 0; i < 8; i++) {
        proj[i] = {origin.x + m_viewCubeCache.projectedVerts[i].x,
                   origin.y + m_viewCubeCache.projectedVerts[i].y};
    }

    // Hit testing uses proj (absolute coordinates) — keep existing logic
    // Drawing uses proj — keep existing logic
    // Click handling — keep existing logic
}
```

**Key implementation details:**

1. Cache projected verts as OFFSETS (relative to origin, not absolute screen coords). In the cache, store `{r.x * kCubeSize, -r.y * kCubeSize}` instead of `{origin.x + r.x * kCubeSize, origin.y - r.y * kCubeSize}`. This way the cache doesn't need invalidation when the viewport panel moves or resizes.

2. Cache the sorted face order (`sortedFaces` array) since the depth sort only depends on camera orientation.

3. Cache the depth values since they are used in hit testing (`fs.avgZ < 0` check) and face coloring (`fs.avgZ > 0.3f`).

4. The `FaceSort` struct inside the cache mirrors the existing anonymous `FaceSort` struct. Move the struct definition to the cache so it can be reused.

5. Do NOT cache hit testing results or draw calls — those depend on mouse position which changes every frame.

6. Invalidate cache in `resetView()` and `fitToModel()` by setting `m_viewCubeCache.valid = false` if those methods change camera orientation. Actually, the cache checks yaw/pitch each frame, so explicit invalidation is not strictly needed — but adding `m_viewCubeCache.valid = false` in setMesh/clearMesh for safety is good practice.
  </action>
  <verify>
The project must compile: `cmake --build /data/DW/build --target dw 2>&1 | tail -20`

Verify cache struct exists: grep for `ViewCubeCache` in viewport_panel.h
Verify cache is used: grep for `m_viewCubeCache` in viewport_panel.cpp
Verify invalidation check: grep for `kEpsilon` in viewport_panel.cpp
All existing tests pass: `cmake --build /data/DW/build --target dw_tests && /data/DW/build/dw_tests`
  </verify>
  <done>
- ViewCubeCache struct defined in viewport_panel.h with lastYaw, lastPitch, projectedVerts, depths, sortedFaces, valid flag
- m_viewCubeCache member added to ViewportPanel
- renderViewCube() checks cache validity before recomputing geometry
- Projected vertices cached as offsets from origin (not absolute coords)
- Face sort order cached
- Depth values cached
- Hit testing and drawing still work correctly (use absolute coords derived from cached offsets + origin)
- Project compiles, all existing tests pass
  </done>
</task>

</tasks>

<verification>
1. Full project build succeeds: `cmake --build /data/DW/build --target dw`
2. All existing tests pass: `cmake --build /data/DW/build --target dw_tests && /data/DW/build/dw_tests`
3. ViewCubeCache struct exists with all required fields
4. renderViewCube() uses cache check before geometry computation
5. Cache stores offsets, not absolute screen coordinates
</verification>

<success_criteria>
- BUG-01 fixed: ViewCube geometry is cached and only recomputed when camera yaw/pitch change
- Cache uses offset-based approach (invariant to viewport position changes)
- No visual or behavioral changes to ViewCube rendering
- Project compiles, all existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-bugfixes/1.5-02-SUMMARY.md`
</output>

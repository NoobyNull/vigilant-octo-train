---
phase: 01.5-bugfixes
verified: 2026-02-08T22:46:30-08:00
status: passed
score: 8/8 must-haves verified
re_verification: false
---

# Phase 1.5: Bug Fixes Verification Report

**Phase Goal:** Fix remaining bugs and add regression tests for already-fixed bugs.

**Verified:** 2026-02-08T22:46:30-08:00

**Status:** PASSED

**Re-verification:** No — initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Shader uniform cache caches not-found (-1) locations and does not re-query glGetUniformLocation every frame | ✓ VERIFIED | shader.h:48 declares `std::unordered_map<std::string, std::optional<GLint>>`, shader.cpp:97 returns `value_or(-1)`, shader.cpp:102 caches all results including nullopt |
| 2 | Normal matrix is computed as transpose(inverse(mat3(modelMatrix))) for correct lighting under non-uniform scaling | ✓ VERIFIED | renderer.cpp:109-110 computes `glm::transpose(glm::inverse(glm::mat3(modelMatrix)))` and uses setMat3 |
| 3 | Shader class supports setMat3 uniform setter | ✓ VERIFIED | shader.h:40 declares setMat3, shader.cpp:126-128 implements with glUniformMatrix3fv |
| 4 | ViewCube geometry is not recomputed when camera yaw and pitch are unchanged between frames | ✓ VERIFIED | viewport_panel.cpp:339-340 checks epsilon threshold, viewport_panel.cpp:367-389 recomputes only when invalid |
| 5 | ViewCube renders identically to pre-cache behavior (same faces, labels, hit testing) | ✓ VERIFIED | Cache stores offsets (367-369), applies origin at draw time (396-397), hit testing uses derived absolute coords |
| 6 | BUG-02 (fmod angle wrapping) is verified fixed via tests covering negative angles, large angles, and edge cases | ✓ VERIFIED | test_camera.cpp:226-259 has 4 edge case tests, all test negative/exact boundary/wrap behavior |
| 7 | BUG-03 (framebuffer move constructor) is verified fixed via code review | ✓ VERIFIED | framebuffer.cpp:21-22, 36-37 zeros width/height, test_camera.cpp:261-265 documents code review |
| 8 | BUG-05 (LIKE escaping) is verified fixed via tests covering %, _, backslash, and combined wildcards | ✓ VERIFIED | test_string_utils.cpp:253-284 has 8 escapeLike tests covering all wildcard patterns |

**Score:** 8/8 truths verified

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/render/shader.h` | Shader class with std::optional uniform cache and setMat3 method | ✓ VERIFIED | Line 3: includes optional, line 48: cache type, line 40: setMat3 declaration |
| `src/render/shader.cpp` | getUniformLocation caching all lookups including -1, and setMat3 implementation | ✓ VERIFIED | Lines 97-103: cache all results, lines 126-128: setMat3 implementation |
| `src/render/renderer.cpp` | Proper normal matrix computation using glm::transpose(glm::inverse()) | ✓ VERIFIED | Lines 109-110: correct computation and setMat3 call |
| `src/render/shader_sources.h` | Mesh vertex shader using mat3 uNormalMatrix | ✓ VERIFIED | Line 17: `uniform mat3 uNormalMatrix`, line 26: direct usage without mat3() cast |
| `src/ui/panels/viewport_panel.h` | ViewCubeCache struct as private member of ViewportPanel | ✓ VERIFIED | Lines 49-57: ViewCubeCache struct definition, line 78: m_viewCubeCache member |
| `src/ui/panels/viewport_panel.cpp` | Cache-aware renderViewCube that skips geometry recomputation when camera unchanged | ✓ VERIFIED | Lines 339-389: cache check with epsilon, conditional recomputation, lines 396-397: offset application |
| `tests/test_string_utils.cpp` | escapeLike regression tests | ✓ VERIFIED | Lines 253-284: 8 tests covering all escaping scenarios |
| `tests/test_camera.cpp` | Additional yaw wrapping edge case tests | ✓ VERIFIED | Lines 226-259: 4 edge case tests, lines 261-265: BUG-03 documentation |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|----|--------|---------|
| src/render/renderer.cpp | src/render/shader.cpp | setMat3 call for normal matrix | ✓ WIRED | renderer.cpp:110 calls `m_meshShader.setMat3("uNormalMatrix", normalMatrix)` |
| src/render/shader_sources.h | src/render/renderer.cpp | uNormalMatrix uniform type agreement (mat3) | ✓ WIRED | shader_sources.h:17 declares `uniform mat3`, renderer.cpp:109-110 sends mat3 |
| tests/test_string_utils.cpp | src/core/utils/string_utils.h | includes and calls str::escapeLike | ✓ WIRED | test_string_utils.cpp:254,258,262,266,270,274,278,282 call dw::str::escapeLike |
| tests/test_camera.cpp | src/render/camera.h | includes and tests Camera::orbit with negative values | ✓ WIRED | test_camera.cpp:230,257 call cam.orbit with negative deltaX |
| src/ui/panels/viewport_panel.cpp | src/render/camera.h | camera yaw/pitch read for cache invalidation | ✓ WIRED | viewport_panel.cpp:336-337 reads m_camera.yaw() and m_camera.pitch() |

### Requirements Coverage

| Requirement | Status | Supporting Evidence |
|-------------|--------|---------------------|
| BUG-01 fixed (ViewCube per-frame recomputation cached) | ✓ SATISFIED | Truth 4, 5 verified; commit d795cf2 |
| BUG-04 fixed (shader uniform cache caches not-found locations) | ✓ SATISFIED | Truth 1 verified; commit 9a95b7a |
| BUG-07 fixed (normal matrix uses transpose(inverse(mat3))) | ✓ SATISFIED | Truth 2 verified; commit 3cec065 |
| BUG-02 verified with regression tests (camera angle wrapping) | ✓ SATISFIED | Truth 6 verified; commit dc10e6e adds 4 tests |
| BUG-03 verified via code review (framebuffer move constructor) | ✓ SATISFIED | Truth 7 verified; framebuffer.cpp:21-22, 36-37 confirmed |
| BUG-05 verified with regression tests (LIKE escaping) | ✓ SATISFIED | Truth 8 verified; commit dc10e6e adds 8 tests |
| BUG-06 deferred to Phase 1.3 (already done via MainThreadQueue) | ✓ SATISFIED | Confirmed deferred per ROADMAP.md; handled in Phase 1.3 |
| All existing tests pass plus new regression tests | ✓ SATISFIED | User reports 422 tests passing; commits verified present |

### Anti-Patterns Found

None detected.

**Scan Results:**
- No TODO/FIXME/PLACEHOLDER comments in modified files
- No stub implementations (empty returns, console.log-only handlers)
- All artifacts substantive and wired correctly

### Human Verification Required

**1. ViewCube Visual Appearance and Interaction**

**Test:** 
1. Launch application with 3D model loaded
2. Orbit camera and observe ViewCube in viewport corner
3. Click ViewCube faces to snap to canonical views
4. Move/resize viewport panel

**Expected:** 
- ViewCube renders identically to before caching
- Face colors update correctly based on viewing angle
- Face labels visible and correct
- Click targeting works correctly
- ViewCube position remains stable when viewport resizes
- Performance improved (no visible lag when camera stationary)

**Why human:** Visual correctness, interaction responsiveness, and performance feel cannot be verified programmatically.

**2. Lighting Correctness with Non-Uniform Scaling**

**Test:**
1. Load model and apply non-uniform scaling (e.g., stretch along X axis by 2x)
2. Rotate model under directional lighting
3. Compare normals/shading to reference renderer or previous version

**Expected:**
- Lighting appears correct on stretched/squashed models
- No obvious shading artifacts on scaled surfaces
- Specular highlights in correct positions

**Why human:** Lighting correctness is subjective and requires visual comparison.

**3. Performance Impact Measurement**

**Test:**
1. Profile CPU usage when camera is stationary vs. orbiting
2. Measure frame time with and without ViewCube rendering

**Expected:**
- Reduced CPU usage when camera stationary (fewer trig operations, no sorting)
- Uniform cache reduces glGetUniformLocation calls (visible in GPU profiler)

**Why human:** Performance measurement requires profiling tools and subjective assessment of smoothness.

---

## Summary

Phase 1.5 achieved its goal of fixing remaining bugs and adding regression tests. All 8 success criteria met:

**Bugs Fixed:**
1. **BUG-01** — ViewCube geometry cached, recomputes only on camera orientation change
2. **BUG-04** — Shader uniform cache now caches not-found (-1) locations using std::optional
3. **BUG-07** — Normal matrix computed correctly as transpose(inverse(mat3(model)))

**Bugs Verified with Regression Tests:**
4. **BUG-02** — 4 edge case tests for camera yaw wrapping with fmod
5. **BUG-03** — Code review confirmed framebuffer move constructor zeros width/height
6. **BUG-05** — 8 comprehensive tests for SQL LIKE wildcard escaping

**Deferred:**
7. **BUG-06** — Handled in Phase 1.3 via MainThreadQueue (per ROADMAP)

**Test Coverage:**
8. All existing tests pass plus 12 new regression tests (422 total)

All artifacts exist, are substantive, and properly wired. No anti-patterns detected. Ready to proceed to next phase.

---

_Verified: 2026-02-08T22:46:30-08:00_
_Verifier: Claude (gsd-verifier)_

---
phase: 01.5-bugfixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_string_utils.cpp
  - tests/test_camera.cpp
autonomous: true

must_haves:
  truths:
    - "BUG-02 (fmod angle wrapping) is verified fixed via tests covering negative angles, large angles, and edge cases"
    - "BUG-03 (framebuffer move constructor) is verified fixed — cannot add unit test without GL context but code review confirms fix is in place"
    - "BUG-05 (LIKE escaping) is verified fixed via tests covering %, _, backslash, and combined wildcards"
  artifacts:
    - path: "tests/test_string_utils.cpp"
      provides: "escapeLike regression tests"
      contains: "escapeLike"
    - path: "tests/test_camera.cpp"
      provides: "Additional yaw wrapping edge case tests"
      contains: "NegativeYaw"
  key_links:
    - from: "tests/test_string_utils.cpp"
      to: "src/core/utils/string_utils.h"
      via: "includes and calls str::escapeLike"
      pattern: "str::escapeLike"
    - from: "tests/test_camera.cpp"
      to: "src/render/camera.h"
      via: "includes and tests Camera::orbit with negative values"
      pattern: "cam\\.orbit.*-"
---

<objective>
Verify BUG-02 (fmod camera wrapping), BUG-03 (framebuffer move), and BUG-05 (LIKE escaping) are already fixed, and add regression tests to prevent regressions.

Purpose: Research found these three bugs are already fixed in the codebase but lack targeted test coverage. BUG-02 has a basic yaw wrap test but no edge cases for negative angles. BUG-03 cannot be unit tested (needs GL context) but will be verified via code review. BUG-05 (escapeLike) has zero test coverage despite being implemented. Adding regression tests ensures these fixes are not accidentally reverted.

Output: New test cases in existing test files confirming the fixes work correctly.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01.5-bugfixes/1.5-RESEARCH.md
@tests/test_string_utils.cpp
@tests/test_camera.cpp
@src/core/utils/string_utils.h
@src/core/utils/string_utils.cpp
@src/render/camera.cpp
@src/render/framebuffer.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add escapeLike regression tests for BUG-05</name>
  <files>tests/test_string_utils.cpp</files>
  <action>
BUG-05 is already fixed: `str::escapeLike()` exists in `string_utils.cpp:215-225` and is used in `model_repository.cpp:110` and `project_repository.cpp:75`. However, there are ZERO tests for this function.

Add the following tests to `tests/test_string_utils.cpp` (append at end of file, following existing test patterns):

```cpp
// --- LIKE Escape (BUG-05 regression) ---

TEST(StringUtils, EscapeLike_NoSpecialChars) {
    EXPECT_EQ(dw::str::escapeLike("hello"), "hello");
}

TEST(StringUtils, EscapeLike_PercentEscaped) {
    EXPECT_EQ(dw::str::escapeLike("100%"), "100\\%");
}

TEST(StringUtils, EscapeLike_UnderscoreEscaped) {
    EXPECT_EQ(dw::str::escapeLike("test_file"), "test\\_file");
}

TEST(StringUtils, EscapeLike_BackslashEscaped) {
    EXPECT_EQ(dw::str::escapeLike("path\\to"), "path\\\\to");
}

TEST(StringUtils, EscapeLike_MultipleWildcards) {
    EXPECT_EQ(dw::str::escapeLike("%_\\"), "\\%\\_\\\\");
}

TEST(StringUtils, EscapeLike_EmptyString) {
    EXPECT_EQ(dw::str::escapeLike(""), "");
}

TEST(StringUtils, EscapeLike_NoEscapeNeeded) {
    EXPECT_EQ(dw::str::escapeLike("normal search term"), "normal search term");
}

TEST(StringUtils, EscapeLike_MixedContent) {
    // Realistic search: user types "box_v2 (50%)"
    EXPECT_EQ(dw::str::escapeLike("box_v2 (50%)"), "box\\_v2 (50\\%)");
}
```

These test the function per the implementation in string_utils.cpp which escapes `%`, `_`, and `\` with a preceding backslash.
  </action>
  <verify>
Build and run tests: `cmake --build /data/DW/build --target dw_tests && /data/DW/build/dw_tests --gtest_filter=StringUtils.EscapeLike*`
All 8 new escapeLike tests pass.
  </verify>
  <done>
- 8 new escapeLike tests added to test_string_utils.cpp
- Tests cover: no special chars, percent, underscore, backslash, multiple wildcards, empty string, no-escape, mixed content
- All tests pass confirming BUG-05 is already fixed
  </done>
</task>

<task type="auto">
  <name>Task 2: Add camera yaw wrapping edge case tests for BUG-02 and verify BUG-03</name>
  <files>tests/test_camera.cpp</files>
  <action>
BUG-02 is already fixed: `camera.cpp:38-40` uses `std::fmod`. The existing test `Camera.Orbit_YawWraps` tests a full circle but doesn't test negative angles or exact boundary values.

Add the following tests to `tests/test_camera.cpp` (append at end of file):

```cpp
// --- BUG-02 regression: fmod angle wrapping edge cases ---

TEST(Camera, Orbit_NegativeYaw_WrapsToPositive) {
    dw::Camera cam;
    cam.setYaw(0.0f);
    // Orbit negative (large amount to go well below 0)
    cam.orbit(-1000.0f / 0.5f, 0.0f);  // -1000 degrees at 0.5 sensitivity
    // Yaw should be in [0, 360)
    EXPECT_GE(cam.yaw(), 0.0f);
    EXPECT_LT(cam.yaw(), 360.0f);
}

TEST(Camera, Orbit_ExactlyZero) {
    dw::Camera cam;
    cam.setYaw(0.0f);
    cam.orbit(0.0f, 0.0f);
    EXPECT_FLOAT_EQ(cam.yaw(), 0.0f);
}

TEST(Camera, Orbit_Exactly360_WrapsToZero) {
    dw::Camera cam;
    // Set yaw near 360 and push it to exactly 360
    cam.setYaw(359.0f);
    cam.orbit(1.0f / 0.5f, 0.0f);  // +1 degree at 0.5 sensitivity = +2.0 * 0.5 = +1.0
    // After wrapping, should be 0.0
    EXPECT_GE(cam.yaw(), 0.0f);
    EXPECT_LT(cam.yaw(), 360.0f);
}

TEST(Camera, Orbit_SmallNegative_WrapsCorrectly) {
    dw::Camera cam;
    cam.setYaw(1.0f);
    // Orbit -4 degrees (sensitivity 0.5, so deltaX = -4/0.5 = -8)
    cam.orbit(-8.0f, 0.0f);  // 1.0 + (-8.0 * 0.5) = 1.0 - 4.0 = -3.0 -> wraps to 357.0
    EXPECT_NEAR(cam.yaw(), 357.0f, 0.01f);
}
```

Also add a comment block documenting BUG-03 verification:

```cpp
// --- BUG-03 verification: framebuffer move constructor ---
// BUG-03 (zeroing width/height in move constructor) is ALREADY FIXED.
// Verified by code review: framebuffer.cpp:21-22 zeros m_width and m_height.
// Move assignment operator (framebuffer.cpp:36-37) also zeros correctly.
// Cannot unit test without GL context (framebuffer needs OpenGL).
// No test added — fix confirmed via code inspection.
```
  </action>
  <verify>
Build and run tests: `cmake --build /data/DW/build --target dw_tests && /data/DW/build/dw_tests --gtest_filter=Camera.Orbit_*`
All new camera tests pass.
All existing camera tests still pass.
  </verify>
  <done>
- 4 new camera yaw edge case tests added to test_camera.cpp
- Tests cover: large negative orbit, exact zero, wrap at 360, small negative wrap
- BUG-03 documented as verified via code review (no test possible without GL)
- All tests pass confirming BUG-02 is already fixed
  </done>
</task>

</tasks>

<verification>
1. Full test suite passes: `cmake --build /data/DW/build --target dw_tests && /data/DW/build/dw_tests`
2. New escapeLike tests pass: `./build/dw_tests --gtest_filter=StringUtils.EscapeLike*`
3. New camera tests pass: `./build/dw_tests --gtest_filter=Camera.Orbit_*`
4. BUG-02 confirmed fixed (fmod in camera.cpp, tests pass)
5. BUG-03 confirmed fixed (code review of framebuffer.cpp:21-22)
6. BUG-05 confirmed fixed (escapeLike exists and tests pass)
</verification>

<success_criteria>
- 8 escapeLike regression tests pass (BUG-05)
- 4 camera yaw edge case tests pass (BUG-02)
- BUG-03 verified via code review comment
- All 12 new tests pass alongside all existing tests
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-bugfixes/1.5-03-SUMMARY.md`
</output>

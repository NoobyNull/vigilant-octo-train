---
phase: 09-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/config/config.h
  - src/core/config/config.cpp
  - src/ui/panels/cnc_jog_panel.h
  - src/ui/panels/cnc_jog_panel.cpp
  - src/ui/panels/cnc_safety_panel.h
  - src/ui/panels/cnc_safety_panel.cpp
  - src/ui/panels/gcode_panel.h
  - src/ui/panels/gcode_panel.cpp
autonomous: true
requirements:
  - SAF-10
  - SAF-11
  - SAF-12
  - SAF-13
  - SAF-17

must_haves:
  truths:
    - "Home button requires holding for the configured duration before homing activates"
    - "Start button requires holding for the configured duration before streaming begins"
    - "Abort button can optionally require a long-press hold instead of the confirmation dialog"
    - "Continuous jog stops automatically if key is released and no keepalive within timeout"
    - "All safety features have corresponding Config keys with sensible defaults"
  artifacts:
    - path: "src/core/config/config.h"
      provides: "Safety config getters/setters"
      contains: "getSafetyLongPressDuration"
    - path: "src/ui/panels/cnc_jog_panel.h"
      provides: "Dead-man watchdog state"
      contains: "m_jogWatchdog"
    - path: "src/ui/panels/cnc_jog_panel.cpp"
      provides: "Home long-press + watchdog logic"
      contains: "LongPressButton"
    - path: "src/ui/panels/cnc_safety_panel.cpp"
      provides: "Abort long-press option"
      contains: "LongPressButton"
    - path: "src/ui/panels/gcode_panel.cpp"
      provides: "Start long-press"
      contains: "LongPressButton"
  key_links:
    - from: "src/ui/panels/cnc_jog_panel.cpp"
      to: "src/core/config/config.h"
      via: "Config::instance().getSafetyLongPressDuration()"
      pattern: "getSafetyLongPressDuration"
    - from: "src/ui/panels/cnc_jog_panel.cpp"
      to: "CncController::jogCancel()"
      via: "watchdog timeout triggers jogCancel"
      pattern: "jogCancel"
---

<objective>
Add safety Config keys, long-press confirmation for critical buttons (Home, Start, Abort), and dead-man watchdog for continuous jog.

Purpose: Prevent accidental triggering of homing, job start, and abort, and ensure continuous jog stops if operator releases the key.
Output: Config keys for all safety features, long-press behavior on 3 critical buttons, dead-man watchdog in jog panel.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/core/config/config.h
@src/core/config/config.cpp
@src/ui/panels/cnc_jog_panel.h
@src/ui/panels/cnc_jog_panel.cpp
@src/ui/panels/cnc_safety_panel.h
@src/ui/panels/cnc_safety_panel.cpp
@src/ui/panels/gcode_panel.h
@src/ui/panels/gcode_panel.cpp
@src/core/cnc/cnc_types.h

<interfaces>
From src/core/config/config.h — Meyer's singleton, INI persistence:
```cpp
class Config {
public:
    static Config& instance();
    bool load();
    bool save();
    // Pattern: getter + setter pairs, m_field members, INI section/key in config.cpp
};
```

From src/ui/panels/cnc_jog_panel.h:
```cpp
class CncJogPanel : public Panel {
    void renderHomingSection();       // Home button lives here
    void startContinuousJog(int axis, float direction, int key);
    void stopContinuousJog();
    void handleKeyboardJog();         // Called each frame, checks key release
    int m_contJogAxis = -1;           // -1 = not jogging
    float m_contJogDir = 0.0f;
    int m_contJogKey = 0;
};
```

From src/ui/panels/cnc_safety_panel.h:
```cpp
class CncSafetyPanel : public Panel {
    void renderSafetyControls();      // Abort button lives here
    bool m_showAbortConfirm = false;  // Current abort uses confirmation dialog
};
```

From src/ui/panels/gcode_panel.h (relevant portion):
```cpp
class GCodePanel : public Panel {
    void renderPlaybackControls();    // Start button lives here
    void buildSendProgram();          // Called when Start is clicked
    Vec3 boundsMin() const;
    Vec3 boundsMax() const;
};
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add safety Config keys and LongPressButton helper</name>
  <files>
    src/core/config/config.h
    src/core/config/config.cpp
  </files>
  <action>
Add the following getter/setter pairs to Config class following the existing pattern (getter returns value, setter sets member, save() persists to INI).

Safety section config keys:
- `getSafetyLongPressEnabled()` / `setSafetyLongPressEnabled(bool)` — default: true. Master enable for long-press on Home/Start.
- `getSafetyLongPressDurationMs()` / `setSafetyLongPressDurationMs(int)` — default: 1000. Duration in ms for long-press hold.
- `getSafetyAbortLongPress()` / `setSafetyAbortLongPress(bool)` — default: false. When true, Abort uses long-press instead of confirmation dialog.
- `getSafetyDeadManEnabled()` / `setSafetyDeadManEnabled(bool)` — default: true. Enable dead-man watchdog for continuous jog.
- `getSafetyDeadManTimeoutMs()` / `setSafetyDeadManTimeoutMs(int)` — default: 1000. Timeout in ms for watchdog.
- `getSafetyDoorInterlockEnabled()` / `setSafetyDoorInterlockEnabled(bool)` — default: true. Block rapid/spindle when door active.
- `getSafetySoftLimitCheckEnabled()` / `setSafetySoftLimitCheckEnabled(bool)` — default: true. Pre-check G-code bounds vs machine travel.
- `getSafetyPauseBeforeResetEnabled()` / `setSafetyPauseBeforeResetEnabled(bool)` — default: true. Send feed hold before soft reset on stop.

In config.cpp, add these to the INI [Safety] section. Follow the exact pattern of existing settings (e.g., the [Workspace] section for booleans, the [CNC] section pattern for ints).

Add private members: `m_safetyLongPressEnabled = true`, `m_safetyLongPressDurationMs = 1000`, `m_safetyAbortLongPress = false`, `m_safetyDeadManEnabled = true`, `m_safetyDeadManTimeoutMs = 1000`, `m_safetyDoorInterlockEnabled = true`, `m_safetySoftLimitCheckEnabled = true`, `m_safetyPauseBeforeResetEnabled = true`.

Do NOT create a separate header for LongPressButton — it will be defined as a local struct in each panel's .cpp that needs it (small, ~15 lines, avoids header dependency).
  </action>
  <verify>cmake --build build -j$(nproc) 2>&1 | tail -5</verify>
  <done>All 8 safety config keys compile, load, and save to [Safety] INI section with correct defaults</done>
</task>

<task type="auto">
  <name>Task 2: Long-press buttons on Home/Start/Abort and dead-man watchdog</name>
  <files>
    src/ui/panels/cnc_jog_panel.h
    src/ui/panels/cnc_jog_panel.cpp
    src/ui/panels/cnc_safety_panel.h
    src/ui/panels/cnc_safety_panel.cpp
    src/ui/panels/gcode_panel.h
    src/ui/panels/gcode_panel.cpp
  </files>
  <action>
**LongPressButton pattern** (define as anonymous-namespace struct in each .cpp that uses it):

```cpp
namespace {
struct LongPressButton {
    bool holding = false;
    float holdTime = 0.0f;

    // Returns true when hold completes. Call each frame.
    // buttonId: ImGui stable ID for the button
    bool render(const char* label, ImVec2 size, float requiredMs, bool enabled) {
        if (!enabled) ImGui::BeginDisabled();
        bool pressed = ImGui::Button(label, size);
        if (!enabled) ImGui::EndDisabled();
        if (!enabled) { holding = false; holdTime = 0.0f; return false; }

        bool isHeld = ImGui::IsItemActive();
        if (isHeld) {
            holdTime += ImGui::GetIO().DeltaTime * 1000.0f;
            // Draw progress overlay on the button
            float progress = holdTime / requiredMs;
            if (progress > 1.0f) progress = 1.0f;
            ImVec2 rmin = ImGui::GetItemRectMin();
            ImVec2 rmax = ImGui::GetItemRectMax();
            ImVec2 fillMax = {rmin.x + (rmax.x - rmin.x) * progress, rmax.y};
            ImGui::GetWindowDrawList()->AddRectFilled(
                rmin, fillMax, IM_COL32(255, 255, 255, 40), 3.0f);
            holding = true;
        } else {
            if (holding) { holding = false; holdTime = 0.0f; }
        }
        if (holdTime >= requiredMs) {
            holding = false;
            holdTime = 0.0f;
            return true;
        }
        return false;
    }
};
} // namespace
```

Adjust the exact styling as needed (the overlay should be subtle). The key behaviors:
- Button must be held (ImGui::IsItemActive()) for the full duration
- A fill overlay shows progress
- Releasing early resets the timer
- Returns true only when hold duration is met

**CncJogPanel (Home button — SAF-10 + Dead-man watchdog — SAF-13):**

1. Add to header: `float m_jogWatchdogTimer = 0.0f;` member for dead-man tracking.

2. In `renderHomingSection()`: Replace the existing `ImGui::Button(homeLabel, ...)` with the LongPressButton pattern. Read duration from `Config::instance().getSafetyLongPressDurationMs()`. Only apply long-press when `Config::instance().getSafetyLongPressEnabled()` is true; otherwise use the existing click behavior. Show "Hold to Home" tooltip when long-press is enabled.

3. Dead-man watchdog in `handleKeyboardJog()`: When `m_contJogAxis >= 0` (continuous jog active), increment `m_jogWatchdogTimer` by `ImGui::GetIO().DeltaTime * 1000.0f`. If the corresponding key is still held (`ImGui::IsKeyDown`), reset `m_jogWatchdogTimer = 0`. If `m_jogWatchdogTimer` exceeds `Config::instance().getSafetyDeadManTimeoutMs()` AND `Config::instance().getSafetyDeadManEnabled()` is true, call `stopContinuousJog()`. This catches edge cases where the key-release event is missed (focus loss, window switch, etc.).

4. Reset `m_jogWatchdogTimer = 0` in `startContinuousJog()` and `stopContinuousJog()`.

**GCodePanel (Start button — SAF-11):**

1. Add to header: A `LongPressButton m_startLongPress;` is NOT needed in header since the struct is local. Instead, add `float m_startHoldTime = 0.0f; bool m_startHolding = false;` members.

Actually, simpler: just declare a `static LongPressButton` in the anonymous namespace of gcode_panel.cpp and use it in `renderPlaybackControls()`. Static works because there's only one GCodePanel instance.

2. In `renderPlaybackControls()`: Replace the existing `if (ImGui::Button("Start"))` block. When `Config::instance().getSafetyLongPressEnabled()` is true, use the long-press pattern (button label becomes "Hold to Start" with the icon). When disabled, keep existing click behavior. On completion, call `buildSendProgram()`.

**CncSafetyPanel (Abort button — SAF-12):**

1. In `renderSafetyControls()`: The existing Abort button shows a confirmation dialog when streaming. When `Config::instance().getSafetyAbortLongPress()` is true, replace the dialog with a long-press pattern instead. Duration from `getSafetyLongPressDurationMs()`. When long-press completes, directly call `m_cnc->softReset()` (no dialog needed — the long press IS the confirmation). When `getSafetyAbortLongPress()` is false, keep existing dialog behavior unchanged.

Include `"core/config/config.h"` in each .cpp file that reads Config.
  </action>
  <verify>cmake --build build -j$(nproc) 2>&1 | tail -5</verify>
  <done>
- Home button in jog panel requires 1s hold (configurable) before sending $H
- Start button in gcode panel requires 1s hold before streaming
- Abort button optionally uses long-press instead of confirmation dialog
- Continuous jog stops if no key-down detected within watchdog timeout
- All behaviors respect their Config enable/disable toggles
  </done>
</task>

</tasks>

<verification>
- cmake --build build -j$(nproc) — builds without errors
- ctest --test-dir build --output-on-failure — all existing tests pass
</verification>

<success_criteria>
- Home, Start, and Abort buttons use long-press pattern when enabled in Config
- Long-press shows visible fill progress overlay on the button
- Dead-man watchdog cancels continuous jog on key-release timeout
- All 5 Config keys (long_press_enabled, long_press_duration, abort_long_press, dead_man_enabled, dead_man_timeout) persist to INI
</success_criteria>

<output>
After completion, create `.planning/phases/09-safety/09-01-SUMMARY.md`
</output>

---
phase: 09-safety
plan: 02
type: execute
wave: 2
depends_on:
  - 09-01
files_modified:
  - src/ui/panels/cnc_safety_panel.h
  - src/ui/panels/cnc_safety_panel.cpp
  - src/ui/panels/gcode_panel.cpp
  - src/core/cnc/preflight_check.h
  - src/core/cnc/preflight_check.cpp
  - src/ui/panels/cnc_settings_panel.h
  - src/ui/panels/cnc_settings_panel.cpp
autonomous: true
requirements:
  - SAF-14
  - SAF-15
  - SAF-16
  - SAF-17

must_haves:
  truths:
    - "When GRBL reports door pin active, rapid moves and spindle commands are blocked with a visible indicator"
    - "Before streaming, G-code bounding box is compared against machine travel limits and operator is warned if job exceeds soft limits"
    - "Stop command sends feed hold before soft reset to reduce tool marks"
    - "Every safety feature can be individually enabled or disabled in a dedicated safety settings section"
  artifacts:
    - path: "src/ui/panels/cnc_safety_panel.cpp"
      provides: "Door interlock display and pause-before-reset logic"
      contains: "PIN_DOOR"
    - path: "src/core/cnc/preflight_check.cpp"
      provides: "Soft limit bounds comparison"
      contains: "maxTravel"
    - path: "src/ui/panels/cnc_settings_panel.cpp"
      provides: "Safety settings tab with per-feature toggles"
      contains: "Safety"
  key_links:
    - from: "src/ui/panels/cnc_safety_panel.cpp"
      to: "src/core/config/config.h"
      via: "Config::instance().getSafetyDoorInterlockEnabled()"
      pattern: "DoorInterlock"
    - from: "src/core/cnc/preflight_check.cpp"
      to: "src/core/gcode/machine_profile.h"
      via: "MachineProfile maxTravel fields"
      pattern: "maxTravel"
    - from: "src/ui/panels/cnc_settings_panel.cpp"
      to: "src/core/config/config.h"
      via: "Config safety getters/setters"
      pattern: "getSafety"
---

<objective>
Add door interlock blocking, soft limit pre-check, pause-before-reset stop behavior, and a safety settings UI tab.

Purpose: Protect the operator from running jobs when the door is open, exceeding machine travel limits, and getting tool marks from abrupt resets. Expose all safety toggles in settings.
Output: Door interlock indicator, soft limit warning before streaming, graceful stop behavior, safety settings tab in firmware settings panel.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-safety/09-01-SUMMARY.md
@src/core/config/config.h
@src/ui/panels/cnc_safety_panel.h
@src/ui/panels/cnc_safety_panel.cpp
@src/ui/panels/gcode_panel.h
@src/ui/panels/gcode_panel.cpp
@src/core/cnc/preflight_check.h
@src/core/cnc/preflight_check.cpp
@src/core/cnc/cnc_types.h
@src/core/cnc/cnc_controller.h
@src/core/gcode/machine_profile.h
@src/ui/panels/cnc_settings_panel.h
@src/ui/panels/cnc_settings_panel.cpp

<interfaces>
From Plan 01 (will exist when this runs):
```cpp
// Config safety getters (all in config.h):
bool getSafetyLongPressEnabled() const;
int getSafetyLongPressDurationMs() const;
bool getSafetyAbortLongPress() const;
bool getSafetyDeadManEnabled() const;
int getSafetyDeadManTimeoutMs() const;
bool getSafetyDoorInterlockEnabled() const;
bool getSafetySoftLimitCheckEnabled() const;
bool getSafetyPauseBeforeResetEnabled() const;
// + corresponding setters
```

From cnc_types.h:
```cpp
constexpr u32 PIN_DOOR = 1 << 4;
enum class MachineState { ..., Door, ... };
```

From cnc_controller.h:
```cpp
void feedHold();
void softReset();
void jogCancel();
void sendCommand(const std::string& cmd);
```

From machine_profile.h:
```cpp
struct MachineProfile {
    f32 maxTravelX = 430.0f;
    f32 maxTravelY = 430.0f;
    f32 maxTravelZ = 100.0f;
};
```

From config.h (existing):
```cpp
const gcode::MachineProfile& getActiveMachineProfile() const;
int getActiveMachineProfileIndex() const;
```

From preflight_check.h:
```cpp
struct PreflightIssue { enum Severity { Error, Warning }; ... };
std::vector<PreflightIssue> runPreflightChecks(...);
```

From cnc_settings_panel.h:
```cpp
class CncSettingsPanel : public Panel {
    // Has tab bar with "Settings", "Machine Tuning", "Raw" tabs
    // m_activeTab tracks which tab is showing
    int m_activeTab = 0;
};
```

From gcode_panel (existing patterns):
```cpp
void GCodePanel::renderPlaybackControls() {
    // Start button block — long-press added in Plan 01
    // Stop button: if (ImGui::Button("Stop")) { m_cnc->stopStream(); }
}
void GCodePanel::buildSendProgram() {
    // Runs preflight checks, then starts streaming
    // This is where soft limit check should be added
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Door interlock blocking and pause-before-reset</name>
  <files>
    src/ui/panels/cnc_safety_panel.h
    src/ui/panels/cnc_safety_panel.cpp
    src/ui/panels/gcode_panel.cpp
  </files>
  <action>
**Door interlock (SAF-14) in CncSafetyPanel:**

1. Add `bool m_doorActive = false;` member to track door state derived from status updates.

2. In `onStatusUpdate()`: Set `m_doorActive = (status.inputPins & cnc::PIN_DOOR) != 0 || status.state == MachineState::Door;`

3. In `renderSensorDisplay()`: When door is active AND `Config::instance().getSafetyDoorInterlockEnabled()` is true, add a prominent warning banner ABOVE the pin indicators:

```cpp
if (m_doorActive && Config::instance().getSafetyDoorInterlockEnabled()) {
    ImGui::PushStyleColor(ImGuiCol_Text, ImVec4(1.0f, 0.8f, 0.2f, 1.0f));
    ImGui::TextWrapped("%s DOOR INTERLOCK ACTIVE -- Rapid moves and spindle "
                       "commands are blocked until door is closed", Icons::Warning);
    ImGui::PopStyleColor();
    ImGui::Spacing();
}
```

4. In `renderSafetyControls()`: When door interlock is active, disable the Resume button and show a tooltip explaining why. The existing Pause button remains enabled (operator should be able to pause).

5. Add a public accessor: `bool isDoorInterlockActive() const { return m_doorActive && Config::instance().getSafetyDoorInterlockEnabled(); }` — this will be useful for other panels to query.

**Door interlock in GCodePanel:**

1. In `renderPlaybackControls()`: Before allowing Start, also check door interlock. If `m_safetyPanel && m_safetyPanel->isDoorInterlockActive()`, disable the Start button. This requires adding a `CncSafetyPanel*` dependency or, simpler, just checking the status directly from `m_machineStatus.inputPins & cnc::PIN_DOOR` combined with the config toggle. Use the direct status check approach to avoid circular dependencies.

2. Add to gcode_panel.h if not present: The MachineStatus is already stored as `m_machineStatus`. Read the door pin from it.

**Pause-before-reset (SAF-16) in CncSafetyPanel and GCodePanel:**

1. In CncSafetyPanel `renderSafetyControls()`: Modify the Abort button behavior. When `Config::instance().getSafetyPauseBeforeResetEnabled()` is true AND a job is streaming, the abort sequence becomes: first call `m_cnc->feedHold()`, then after a short delay (~200ms), call `m_cnc->softReset()`. Implement this with a timer:
   - Add `bool m_abortPending = false; float m_abortTimer = 0.0f;` members.
   - When abort is triggered (either via dialog confirm or long-press), set `m_abortPending = true; m_abortTimer = 0.0f;` and call `m_cnc->feedHold();`.
   - In `render()` (before other rendering), if `m_abortPending`, increment timer by DeltaTime. After 200ms (0.2f seconds), call `m_cnc->softReset()` and reset `m_abortPending = false`.
   - When `getSafetyPauseBeforeResetEnabled()` is false, keep existing immediate soft reset behavior.

2. In GCodePanel `renderPlaybackControls()`: Apply the same pause-before-reset pattern to the "Stop" button. When `Config::instance().getSafetyPauseBeforeResetEnabled()` is true, the Stop button should call `m_cnc->feedHold()` first, then `m_cnc->stopStream()` after 200ms delay. Add `bool m_stopPending = false; float m_stopTimer = 0.0f;` members if needed. OR, simpler: just call `feedHold()` then `stopStream()` immediately — the feed hold takes effect as a real-time command instantly, and stopStream can be called right after since it just clears the send queue. The GRBL will have already received the feed hold byte. Use this simpler approach:

```cpp
if (ImGui::Button("Stop")) {
    if (m_cnc) {
        if (Config::instance().getSafetyPauseBeforeResetEnabled()) {
            m_cnc->feedHold(); // Real-time byte, takes effect immediately
        }
        m_cnc->stopStream();
    }
}
```

For the safety panel abort, the timer approach is better because soft reset (0x18) is more aggressive — we want the machine to decelerate first.

Include `"core/config/config.h"` in any .cpp that doesn't already include it.
  </action>
  <verify>cmake --build build -j$(nproc) 2>&1 | tail -5</verify>
  <done>
- Door interlock shows warning banner when Pn:D is active and interlock is enabled
- Start and Resume buttons are disabled during door interlock
- Abort sends feed hold before soft reset when pause-before-reset is enabled
- Stop in GCode panel sends feed hold before stopping stream
  </done>
</task>

<task type="auto">
  <name>Task 2: Soft limit pre-check and safety settings UI tab</name>
  <files>
    src/core/cnc/preflight_check.h
    src/core/cnc/preflight_check.cpp
    src/ui/panels/gcode_panel.cpp
    src/ui/panels/cnc_settings_panel.h
    src/ui/panels/cnc_settings_panel.cpp
  </files>
  <action>
**Soft limit pre-check (SAF-15):**

1. Modify `runPreflightChecks()` signature to accept bounds and machine profile:

```cpp
std::vector<PreflightIssue> runPreflightChecks(
    const CncController& ctrl,
    bool hasToolSelected,
    bool hasMaterialSelected,
    const Vec3* boundsMin = nullptr,    // G-code bounding box min (nullable)
    const Vec3* boundsMax = nullptr,    // G-code bounding box max (nullable)
    const gcode::MachineProfile* profile = nullptr  // Machine travel limits (nullable)
);
```

Use default nullptr params so existing callers don't need to change.

2. In `preflight_check.cpp`: When all three optional params are non-null AND `Config::instance().getSafetySoftLimitCheckEnabled()` is true, compare bounds against machine travel:

```cpp
if (boundsMin && boundsMax && profile &&
    Config::instance().getSafetySoftLimitCheckEnabled()) {
    // GRBL uses negative machine coordinates with maxTravel as positive magnitude
    // G-code bounds are in work coordinates relative to work zero
    // We check if the bounding box dimensions exceed machine travel
    float jobSizeX = boundsMax->x - boundsMin->x;
    float jobSizeY = boundsMax->y - boundsMin->y;
    float jobSizeZ = boundsMax->z - boundsMin->z;

    bool exceeds = false;
    std::string msg = "Job may exceed machine travel: ";
    if (jobSizeX > profile->maxTravelX) {
        msg += "X(" + std::to_string(static_cast<int>(jobSizeX)) + ">" +
               std::to_string(static_cast<int>(profile->maxTravelX)) + "mm) ";
        exceeds = true;
    }
    if (jobSizeY > profile->maxTravelY) {
        msg += "Y(" + std::to_string(static_cast<int>(jobSizeY)) + ">" +
               std::to_string(static_cast<int>(profile->maxTravelY)) + "mm) ";
        exceeds = true;
    }
    if (std::abs(boundsMin->z) > profile->maxTravelZ ||
        std::abs(boundsMax->z) > profile->maxTravelZ) {
        msg += "Z(depth exceeds " +
               std::to_string(static_cast<int>(profile->maxTravelZ)) + "mm) ";
        exceeds = true;
    }
    if (exceeds) {
        issues.push_back({PreflightIssue::Warning, msg});
    }
}
```

This is a Warning (not Error) — operator can still proceed. Include `"core/config/config.h"` and `"core/gcode/machine_profile.h"`.

3. In `GCodePanel::buildSendProgram()`: Pass the bounds and profile to `runPreflightChecks()`:

```cpp
auto& profile = Config::instance().getActiveMachineProfile();
Vec3 bmin = m_stats.boundsMin;
Vec3 bmax = m_stats.boundsMax;
auto issues = runPreflightChecks(*m_cnc, hasToolSelected, hasMaterialSelected,
                                 &bmin, &bmax, &profile);
```

Also pass bounds to the resume dialog's preflight call in CncSafetyPanel if applicable (optional — the resume dialog already calls preflight).

**Safety settings UI tab (SAF-17):**

1. In `CncSettingsPanel`, add a new tab "Safety" to the existing tab bar. Add it after "Machine Tuning" and before "Raw":

```cpp
if (ImGui::BeginTabItem("Safety")) {
    m_activeTab = 3;  // New tab index
    renderSafetyTab();
    ImGui::EndTabItem();
}
```

2. Add `void renderSafetyTab();` declaration to the header.

3. Implement `renderSafetyTab()` with per-feature toggles. Use ImGui checkboxes and sliders, reading from and writing to Config. Follow the existing CncSettingsPanel styling patterns (SeparatorText, indented sections, colored labels):

```
Safety Settings tab layout:

--- Long-Press Confirmation ---
  [x] Enable long-press for Home and Start buttons
  Duration: [====1000====] ms (slider 250-3000)
  [x] Use long-press for Abort (instead of confirmation dialog)

--- Continuous Jog Watchdog ---
  [x] Enable dead-man watchdog
  Timeout: [====1000====] ms (slider 200-5000)

--- Machine Protection ---
  [x] Door interlock (block commands when door is active)
  [x] Soft limit pre-check (compare job bounds vs machine travel)
  [x] Pause before reset (send feed hold before soft reset)
```

Each checkbox calls the corresponding Config setter and `Config::instance().save()`. Sliders use `ImGui::SliderInt` with the range noted above.

Add a note at the bottom: `ImGui::TextDisabled("Changes take effect immediately");`

Save on every change (same pattern as existing settings panels — Config::save() is lightweight INI write).
  </action>
  <verify>cmake --build build -j$(nproc) 2>&1 | tail -5</verify>
  <done>
- Soft limit pre-check compares G-code bounds against machine travel limits before streaming
- Warning is shown (not blocking) when job exceeds machine travel
- Safety tab in firmware settings shows toggles for all 8 safety features
- Each toggle persists to Config and takes effect immediately
  </done>
</task>

</tasks>

<verification>
- cmake --build build -j$(nproc) — builds without errors
- ctest --test-dir build --output-on-failure — all existing tests pass
</verification>

<success_criteria>
- Door interlock shows visible warning and blocks commands when Pn:D active
- Soft limit pre-check warns before streaming when job exceeds machine travel
- Stop/Abort send feed hold first when pause-before-reset is enabled
- Safety tab in settings panel exposes all 8 safety feature toggles
- All settings persist across application restart
</success_criteria>

<output>
After completion, create `.planning/phases/09-safety/09-02-SUMMARY.md`
</output>

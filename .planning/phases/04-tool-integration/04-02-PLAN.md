---
phase: 04-tool-integration
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - src/managers/ui_manager.h
  - src/managers/ui_manager.cpp
  - src/app/application_wiring.cpp
autonomous: true
requirements:
  - TAC-01
  - TAC-02
  - TAC-03
must_haves:
  truths:
    - "CncToolPanel appears in CNC workspace mode alongside DRO, jog, console, and WCS panels"
    - "Switching to CNC mode shows the Tool & Material panel automatically"
    - "Switching to Model mode hides the Tool & Material panel"
    - "ToolDatabase and MaterialManager are wired into CncToolPanel at startup"
  artifacts:
    - path: "src/managers/ui_manager.h"
      provides: "CncToolPanel ownership, visibility bool, accessor"
      contains: "CncToolPanel"
    - path: "src/managers/ui_manager.cpp"
      provides: "Panel creation, rendering, workspace mode integration"
      contains: "m_cncToolPanel"
    - path: "src/app/application_wiring.cpp"
      provides: "Dependency injection of ToolDatabase and MaterialManager into CncToolPanel"
      contains: "cncToolPanel"
  key_links:
    - from: "src/managers/ui_manager.cpp"
      to: "CncToolPanel"
      via: "make_unique in init(), render in renderPanels(), visibility in setWorkspaceMode()"
      pattern: "m_cncToolPanel"
    - from: "src/app/application_wiring.cpp"
      to: "CncToolPanel"
      via: "setToolDatabase and setMaterialManager injection"
      pattern: "cncToolPanel.*setToolDatabase"
---

<objective>
Wire CncToolPanel into the application: UIManager ownership, CNC workspace mode visibility, and dependency injection from Application.

Purpose: The panel from Plan 01 exists as a standalone class. This plan integrates it into the application so it appears in CNC mode and has access to the tool database and material manager.

Output: Modified UIManager and application_wiring.cpp with full panel integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tool-integration/04-CONTEXT.md
@.planning/phases/04-tool-integration/04-01-SUMMARY.md

@src/managers/ui_manager.h
@src/managers/ui_manager.cpp
@src/app/application_wiring.cpp
@src/ui/panels/cnc_tool_panel.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CncToolPanel to UIManager</name>
  <files>src/managers/ui_manager.h, src/managers/ui_manager.cpp</files>
  <action>
**In ui_manager.h:**
1. Add forward declaration: `class CncToolPanel;` alongside existing CNC panel forward declarations (CncStatusPanel, CncJogPanel, etc.)
2. Add accessor: `CncToolPanel* cncToolPanel() { return m_cncToolPanel.get(); }` in the panel accessors section
3. Add visibility accessor: `bool& showCncTool() { return m_showCncTool; }` in the visibility state section
4. Add private member: `std::unique_ptr<CncToolPanel> m_cncToolPanel;` alongside other CNC panel unique_ptrs
5. Add visibility bool: `bool m_showCncTool = false;` alongside other CNC visibility bools (initially false, set true by workspace mode)

**In ui_manager.cpp:**
1. Add include: `#include "ui/panels/cnc_tool_panel.h"` alongside other CNC panel includes
2. In `UIManager::init()`: Add `m_cncToolPanel = std::make_unique<CncToolPanel>();` after other CNC panel creation
3. In `UIManager::shutdown()`: Add `m_cncToolPanel.reset();` alongside other panel resets
4. In `UIManager::renderPanels()`: Add rendering block following the exact pattern of other CNC panels:
   ```cpp
   if (m_showCncTool && m_cncToolPanel) {
       m_cncToolPanel->render();
       if (!m_cncToolPanel->isOpen()) {
           m_showCncTool = false;
           m_cncToolPanel->setOpen(true);
       }
   }
   ```
   Place this near the other CNC panel rendering blocks.

5. In `UIManager::setWorkspaceMode()`: Add `m_showCncTool = true;` inside the `WorkspaceMode::CNC` block (alongside m_showCncStatus, m_showCncJog, etc.). Add `m_showCncTool = false;` in the Model mode block.

6. In `UIManager::renderViewMenu()`: Add a menu item for the panel visibility toggle, following the pattern of other CNC panel menu items:
   ```cpp
   ImGui::MenuItem("Tool & Material", nullptr, &m_showCncTool);
   ```
   Place this alongside the other CNC panel menu items (CNC Status, Jog Controls, Console, WCS).
  </action>
  <verify>
Read ui_manager.h and ui_manager.cpp. Confirm:
1. CncToolPanel forward declaration exists
2. unique_ptr member and visibility bool exist
3. Accessor methods exist
4. init() creates the panel
5. shutdown() resets it
6. renderPanels() renders it when visible
7. setWorkspaceMode(CNC) sets m_showCncTool = true
8. View menu includes the toggle
  </verify>
  <done>
UIManager owns and manages CncToolPanel lifecycle. Panel appears in CNC workspace mode and can be toggled from View menu.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire dependencies in Application</name>
  <files>src/app/application_wiring.cpp</files>
  <action>
In `application_wiring.cpp`, add dependency injection for CncToolPanel. Place it near the existing ToolBrowserPanel wiring (around line 589):

```cpp
if (auto* ctp = m_uiManager->cncToolPanel()) {
    ctp->setToolDatabase(m_toolDatabase.get());
    ctp->setMaterialManager(m_materialManager.get());
}
```

This follows the exact same pattern as the ToolBrowserPanel wiring that already exists in the file. The CncToolPanel needs ToolDatabase for tool geometries/machines and MaterialManager for wood species/Janka hardness.

Also add the include for cnc_tool_panel.h if not already pulled in transitively through ui_manager.h (check -- it likely is since UIManager includes the forward declaration, but the wiring file may need the full header for the setter methods).
  </action>
  <verify>
Read application_wiring.cpp and confirm:
1. CncToolPanel dependency injection block exists
2. setToolDatabase and setMaterialManager are called
3. The wiring is near the ToolBrowserPanel wiring section
  </verify>
  <done>
CncToolPanel receives ToolDatabase and MaterialManager at application startup, enabling tool selection, material selection, and calculator functionality.
  </done>
</task>

</tasks>

<verification>
- Full build succeeds with CncToolPanel integrated
- Switching to CNC mode shows the Tool & Material panel
- Switching to Model mode hides it
- View menu has a toggle for the panel
- Panel has access to tool database and material manager (not null)
</verification>

<success_criteria>
- UIManager owns CncToolPanel, renders it in CNC mode
- Application wires ToolDatabase and MaterialManager into the panel
- Panel visibility toggles correctly with workspace mode
- View menu includes "Tool & Material" toggle
</success_criteria>

<output>
After completion, create `.planning/phases/04-tool-integration/04-02-SUMMARY.md`
</output>

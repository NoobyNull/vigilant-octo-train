---
phase: 04-tool-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/panels/cnc_tool_panel.h
  - src/ui/panels/cnc_tool_panel.cpp
autonomous: true
requirements:
  - TAC-01
  - TAC-02
  - TAC-03
must_haves:
  truths:
    - "CncToolPanel renders a tool geometry selector populated from ToolDatabase"
    - "CncToolPanel renders a material selector populated from MaterialManager"
    - "When both tool and material are selected, ToolCalculator::calculate() runs automatically and results display"
    - "Calculated RPM, feed rate, plunge rate, stepdown, and stepover are shown in a readable reference format"
  artifacts:
    - path: "src/ui/panels/cnc_tool_panel.h"
      provides: "CncToolPanel class declaration"
      contains: "class CncToolPanel"
    - path: "src/ui/panels/cnc_tool_panel.cpp"
      provides: "CncToolPanel implementation with tool/material selection and calculator display"
      contains: "ToolCalculator::calculate"
  key_links:
    - from: "src/ui/panels/cnc_tool_panel.cpp"
      to: "ToolDatabase"
      via: "findAllGeometries() and getAllTreeEntries() for tool listing"
      pattern: "m_toolDatabase->findAllGeometries"
    - from: "src/ui/panels/cnc_tool_panel.cpp"
      to: "MaterialManager"
      via: "getAllMaterials() for material listing with Janka hardness"
      pattern: "m_materialManager->getAllMaterials"
    - from: "src/ui/panels/cnc_tool_panel.cpp"
      to: "ToolCalculator"
      via: "calculate() invoked when both tool and material selected"
      pattern: "ToolCalculator::calculate"
---

<objective>
Create the CncToolPanel -- a new CNC workspace panel that provides tool geometry selection, wood species selection, and automatic feeds/speeds calculation display.

Purpose: This is the core UI for TAC-01/02/03 -- the panel where operators select a tool and material to see calculated cutting parameters as a reference while setting up or running jobs.

Output: Two new files (cnc_tool_panel.h and cnc_tool_panel.cpp) implementing the complete panel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tool-integration/04-CONTEXT.md
@.planning/phases/04-tool-integration/04-RESEARCH.md

@src/ui/panels/panel.h
@src/ui/panels/tool_browser_panel.h
@src/ui/panels/tool_browser_panel.cpp
@src/ui/panels/cnc_status_panel.h
@src/core/cnc/tool_calculator.h
@src/core/cnc/tool_calculator.cpp
@src/core/cnc/cnc_tool.h
@src/core/database/tool_database.h
@src/core/materials/material_manager.h
@src/core/materials/material.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CncToolPanel header and implementation</name>
  <files>src/ui/panels/cnc_tool_panel.h, src/ui/panels/cnc_tool_panel.cpp</files>
  <action>
Create a new CncToolPanel class inheriting from Panel ("Tool & Material" title).

**Header (cnc_tool_panel.h):**
- Forward declare ToolDatabase, MaterialManager
- Include tool_calculator.h for CalcInput/CalcResult, cnc_tool.h for VtdbToolGeometry/VtdbMachine
- Include material.h for MaterialRecord
- Dependency setters: setToolDatabase(ToolDatabase*), setMaterialManager(MaterialManager*)
- Private members:
  - Pointers: m_toolDatabase, m_materialManager
  - Cached data: vector of VtdbToolGeometry (m_geometries), vector of VtdbTreeEntry (m_treeEntries), vector of MaterialRecord (m_materials), vector of VtdbMachine (m_machines)
  - Selection state: m_selectedGeometryId (string), m_selectedMaterialId (i64, default 0), m_selectedMachineId (string)
  - Calculator state: m_calcResult (CalcResult), m_hasCalcResult (bool)
  - Tracking: m_prevGeometryId, m_prevMaterialId (to detect selection changes for auto-recalc)
  - m_needsRefresh (bool, default true)
- Private methods: loadData(), recalculate(), renderToolSelector(), renderMaterialSelector(), renderMachineInfo(), renderResults()

**Implementation (cnc_tool_panel.cpp):**
- Include tool_database.h, material_manager.h, imgui.h, icons.h, log.h

- **loadData():** Load geometries, tree entries, materials (from MaterialManager::getAllMaterials()), machines from ToolDatabase. Sort tree entries by sibling_order.

- **render():** Check m_open. Call loadData if m_needsRefresh. Use ImGui::Begin/End. Render sections in order: tool selector, material selector, separator, machine info line, separator, results.

- **renderToolSelector():**
  Use ImGui::BeginCombo for tool selection. Display tools as "Name (Type, Diameter, Flutes)" from tree entries cross-referenced with geometries. When a tool is selected, store m_selectedGeometryId. Only show leaf entries (those with non-empty tool_geometry_id). Show tool type icon prefix using toolTypeName helper (copy from tool_browser_panel.cpp).

  Below the combo, show a compact summary of the selected tool: type, diameter, flutes, units.

- **renderMaterialSelector():**
  Use ImGui::BeginCombo for material selection from MaterialManager. Display as "Name (Category)" grouping by category with ImGui section separators is optional -- a flat sorted list is fine. When selected, store m_selectedMaterialId and the MaterialRecord's jankaHardness.

  Below the combo, show the selected material's Janka hardness and classified hardness band (use ToolCalculator::classifyMaterial).

- **renderMachineInfo():**
  Show currently selected machine info in a single line: "Machine: name (drive type, max RPM, power W)". If no machine selected, show default parameters. Allow machine selection via a small combo or just show the first available machine.

- **Auto-recalculation logic (in render, after selectors):**
  After rendering selectors, check if m_selectedGeometryId or m_selectedMaterialId changed from m_prevGeometryId/m_prevMaterialId. If changed AND both are valid (non-empty geometry, non-zero material), call recalculate(). Update prev tracking vars.

- **recalculate():**
  Build CalcInput from selected geometry + material + machine:
  - Find VtdbToolGeometry by m_selectedGeometryId
  - Find MaterialRecord by m_selectedMaterialId
  - Find VtdbMachine by m_selectedMachineId (or use defaults: 24000 RPM, Belt, 0W)
  - Call ToolCalculator::calculate(input)
  - Store result, set m_hasCalcResult = true

- **renderResults():**
  If no calc result: show ImGui::TextDisabled("Select a tool and material to see recommended parameters").

  If result available, display in a clean reference format:
  - SeparatorText "Recommended Parameters"
  - Classification line: hardness band name + rigidity factor %
  - Main parameters in a table or aligned text:
    - RPM: {value}
    - Feed Rate: {value} {unit}
    - Plunge Rate: {value} {unit}
    - Stepdown: {value} {unit}
    - Stepover: {value} {unit}
  - Secondary info:
    - Chip Load: {value} {unit}/tooth
    - Power Required: {value} W (with "(power limited)" warning if applicable)

  Use ImVec4(0.4f, 0.8f, 0.4f, 1.0f) green color for the main parameter values for readability.
  Use the correct unit labels based on geometry units (metric=mm, mm/min; imperial=in, in/min).

Follow the exact same coding patterns as tool_browser_panel.cpp (includes, namespace, static helpers, ImGui usage). Use Icons:: constants from icons.h where appropriate.
  </action>
  <verify>
Files compile: check that the header has no missing includes and the implementation references correct API methods. Verify by reading both files and confirming:
1. CncToolPanel inherits from Panel
2. setToolDatabase and setMaterialManager setters exist
3. render() calls ImGui::Begin/End
4. recalculate() calls ToolCalculator::calculate()
5. All referenced APIs exist (findAllGeometries, getAllTreeEntries, getAllMaterials, findAllMachines)
  </verify>
  <done>
CncToolPanel class exists with complete tool selection, material selection, auto-calculation, and result display. The panel can be instantiated and wired by UIManager (done in Plan 02).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CncToolPanel to CMake build</name>
  <files>CMakeLists.txt</files>
  <action>
Add the new source files to the CMakeLists.txt build configuration. Find the section where other panel source files are listed (look for cnc_status_panel.cpp, cnc_jog_panel.cpp, etc.) and add:
- src/ui/panels/cnc_tool_panel.h
- src/ui/panels/cnc_tool_panel.cpp

Follow the existing alphabetical/grouped ordering pattern used for panel files.
  </action>
  <verify>
Read CMakeLists.txt and confirm both cnc_tool_panel files are listed in the sources.
  </verify>
  <done>
New panel files are included in the build so they compile with the rest of the project.
  </done>
</task>

</tasks>

<verification>
- CncToolPanel class compiles (included in CMake, correct includes)
- Tool selector populates from ToolDatabase
- Material selector populates from MaterialManager
- Auto-calculation fires when both are selected
- Results display with correct units
</verification>

<success_criteria>
- cnc_tool_panel.h declares CncToolPanel with setToolDatabase, setMaterialManager, render
- cnc_tool_panel.cpp implements tool combo, material combo, auto-recalculate, result display
- Both files added to CMakeLists.txt
- Code follows existing panel patterns (Panel base, ImGui::Begin/End, icons, logging)
</success_criteria>

<output>
After completion, create `.planning/phases/04-tool-integration/04-01-SUMMARY.md`
</output>

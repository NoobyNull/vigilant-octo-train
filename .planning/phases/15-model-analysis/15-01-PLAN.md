# Plan 15-01: Minimum Feature Radius from Heightmap Curvature

**Phase**: 15 — Model Analysis
**Requirements**: DC-05

## Overview

Compute the minimum concave feature radius from the heightmap grid. This determines the smallest tool tip that can accurately reproduce the surface detail. The result drives tool recommendation in Phase 16.

## New Files

### `src/core/carve/surface_analysis.h` (~80 lines)

```cpp
namespace dw {
namespace carve {

struct CurvatureResult {
    f32 minConcaveRadius = 0.0f;  // Smallest concave radius found (mm)
    int minRadiusCol = 0;          // Grid position of minimum
    int minRadiusRow = 0;
    f32 avgConcaveRadius = 0.0f;  // Average concave radius
    int concavePointCount = 0;     // Number of concave grid cells
};

// Analyze heightmap curvature to find minimum concave feature radius.
// Uses discrete Laplacian on the heightmap grid.
// Only considers cells where curvature indicates concavity (valleys/grooves).
CurvatureResult analyzeCurvature(const Heightmap& heightmap);

} // namespace carve
} // namespace dw
```

### `src/core/carve/surface_analysis.cpp` (~150 lines)

**analyzeCurvature()**:

1. For each interior grid cell (skip border cells):
   - Compute second derivatives in X and Y using central differences:
     ```
     d2z_dx2 = (Z[r][c+1] - 2*Z[r][c] + Z[r][c-1]) / (res * res)
     d2z_dy2 = (Z[r+1][c] - 2*Z[r][c] + Z[r-1][c]) / (res * res)
     ```
   - Compute mean curvature: `H = (d2z_dx2 + d2z_dy2) / 2`
   - If H > threshold (concave): radius = `1.0 / H`
   - Track minimum radius and running average

2. Return CurvatureResult with minimum, average, and location

**Helper: `computeLocalRadius()`** (~15 lines):
- Given heightmap + grid position, compute radius of curvature
- Uses 3x3 neighborhood for robustness (Gaussian-weighted central differences)
- Returns positive value for concave, negative for convex, 0 for flat

**Noise filtering**:
- Ignore cells where curvature magnitude is below a noise threshold
  (calculated as `2.0 / (resolution * resolution)` — the minimum detectable curvature)
- Ignore isolated concave cells (require 2+ concave neighbors)

### Tests

`src/core/carve/surface_analysis_test.cpp` (~100 lines):

- `TEST(CurvatureAnalysis, FlatSurface)` — flat heightmap returns 0 concave points
- `TEST(CurvatureAnalysis, SphericalBowl)` — hemispherical depression returns radius matching sphere radius
- `TEST(CurvatureAnalysis, VGroove)` — V-shaped groove returns radius approaching 0
- `TEST(CurvatureAnalysis, LargeRadius)` — gentle curve returns large radius
- `TEST(CurvatureAnalysis, MinRadiusLocation)` — min radius position matches known groove location

## Coding Standards Compliance

- surface_analysis.h ~80 lines, .cpp ~150 lines
- Free functions (no unnecessary class — stateless analysis)
- analyzeCurvature delegates to computeLocalRadius helper
- No hardcoded thresholds (derived from resolution)

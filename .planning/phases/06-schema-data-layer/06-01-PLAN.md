# Plan 06-01: Schema v9 — Project G-code, Cut Plans, Notes

## Goal
Migrate schema from v8 to v9 adding `project_gcode` junction table, `cut_plans` table, and `notes` column on `projects`. Create `CutPlanRepository` and extend `GCodeRepository` with project-aware queries. Full unit test coverage.

## Context

**Existing infrastructure:**
- Schema v8 with migration framework (`schema.cpp:migrate()` handles v5→v6→v7→v8)
- `gcode_files` table exists with hash, bounds, stats, tools
- `GCodeRepository` has full CRUD but no project association
- `cost_estimates` table already links to projects via `project_id` FK
- `CutOptimizer` produces `CutPlan` struct (in-memory only, not persisted)
- `projects` table has: id, name, description, file_path, created_at, modified_at

**Files to read before implementing:**
- `src/core/database/schema.h` — Schema class, CURRENT_VERSION constant
- `src/core/database/schema.cpp` — createTables(), migrate() with v5-v8 migrations
- `src/core/database/gcode_repository.h` — GCodeRecord, OperationGroup structs, GCodeRepository API
- `src/core/database/gcode_repository.cpp` — existing CRUD, JSON helpers
- `src/core/database/cost_repository.h` — CostEstimate/CostItem structs (pattern reference)
- `src/core/database/cost_repository.cpp` — JSON serialization pattern reference
- `src/core/optimizer/sheet.h` — Part, Sheet, Placement, SheetResult, CutPlan structs
- `tests/test_database.cpp` — existing DB test patterns
- `tests/test_cost_repository.cpp` — repository test patterns

## Tasks

### Task 1: Schema v9 migration (schema.h, schema.cpp)

**schema.h:**
- Change `CURRENT_VERSION` from 8 to 9

**schema.cpp — createTables():**
Add after `cost_estimates` table creation:

```sql
CREATE TABLE IF NOT EXISTS project_gcode (
    project_id INTEGER NOT NULL,
    gcode_id INTEGER NOT NULL,
    sort_order INTEGER DEFAULT 0,
    added_at TEXT DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (project_id, gcode_id),
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (gcode_id) REFERENCES gcode_files(id) ON DELETE CASCADE
)
```

```sql
CREATE INDEX IF NOT EXISTS idx_project_gcode_project ON project_gcode(project_id)
```

```sql
CREATE INDEX IF NOT EXISTS idx_project_gcode_gcode ON project_gcode(gcode_id)
```

```sql
CREATE TABLE IF NOT EXISTS cut_plans (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER,
    name TEXT NOT NULL,
    algorithm TEXT NOT NULL,
    sheet_config TEXT NOT NULL,
    parts TEXT NOT NULL,
    result TEXT NOT NULL,
    allow_rotation INTEGER DEFAULT 1,
    kerf REAL DEFAULT 0,
    margin REAL DEFAULT 0,
    sheets_used INTEGER DEFAULT 0,
    efficiency REAL DEFAULT 0,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    modified_at TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE SET NULL
)
```

```sql
CREATE INDEX IF NOT EXISTS idx_cut_plans_project ON cut_plans(project_id)
```

**schema.cpp — migrate():**
Add v8→v9 case in the migration switch:

```cpp
if (fromVersion < 9) {
    const char* v9[] = {
        "CREATE TABLE IF NOT EXISTS project_gcode ("
        "project_id INTEGER NOT NULL, gcode_id INTEGER NOT NULL, "
        "sort_order INTEGER DEFAULT 0, added_at TEXT DEFAULT CURRENT_TIMESTAMP, "
        "PRIMARY KEY (project_id, gcode_id), "
        "FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE, "
        "FOREIGN KEY (gcode_id) REFERENCES gcode_files(id) ON DELETE CASCADE)",
        "CREATE INDEX IF NOT EXISTS idx_project_gcode_project ON project_gcode(project_id)",
        "CREATE INDEX IF NOT EXISTS idx_project_gcode_gcode ON project_gcode(gcode_id)",
        "CREATE TABLE IF NOT EXISTS cut_plans ("
        "id INTEGER PRIMARY KEY AUTOINCREMENT, project_id INTEGER, "
        "name TEXT NOT NULL, algorithm TEXT NOT NULL, "
        "sheet_config TEXT NOT NULL, parts TEXT NOT NULL, result TEXT NOT NULL, "
        "allow_rotation INTEGER DEFAULT 1, kerf REAL DEFAULT 0, margin REAL DEFAULT 0, "
        "sheets_used INTEGER DEFAULT 0, efficiency REAL DEFAULT 0, "
        "created_at TEXT DEFAULT CURRENT_TIMESTAMP, modified_at TEXT DEFAULT CURRENT_TIMESTAMP, "
        "FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE SET NULL)",
        "CREATE INDEX IF NOT EXISTS idx_cut_plans_project ON cut_plans(project_id)",
        "ALTER TABLE projects ADD COLUMN notes TEXT DEFAULT ''",
    };
    for (const auto* sql : v9) {
        if (!db.execute(sql)) return false;
    }
}
```

Also add `notes TEXT DEFAULT ''` to the `projects` CREATE TABLE in createTables().

### Task 2: Extend GCodeRepository with project methods (gcode_repository.h, gcode_repository.cpp)

**gcode_repository.h — add methods:**
```cpp
// Project association
bool addToProject(i64 projectId, i64 gcodeId, int sortOrder = 0);
bool removeFromProject(i64 projectId, i64 gcodeId);
std::vector<GCodeRecord> findByProject(i64 projectId);
std::vector<i64> getProjectsForGCode(i64 gcodeId);
bool isInProject(i64 projectId, i64 gcodeId);
```

**gcode_repository.cpp — implement:**

`addToProject`: INSERT OR IGNORE INTO project_gcode (project_id, gcode_id, sort_order) VALUES (?, ?, ?)

`removeFromProject`: DELETE FROM project_gcode WHERE project_id = ? AND gcode_id = ?

`findByProject`: SELECT gf.* FROM gcode_files gf INNER JOIN project_gcode pg ON gf.id = pg.gcode_id WHERE pg.project_id = ? ORDER BY pg.sort_order

`getProjectsForGCode`: SELECT project_id FROM project_gcode WHERE gcode_id = ?

`isInProject`: SELECT 1 FROM project_gcode WHERE project_id = ? AND gcode_id = ? LIMIT 1

### Task 3: Create CutPlanRepository (new files)

**src/core/database/cut_plan_repository.h:**

```cpp
#pragma once
#include <optional>
#include <string>
#include <vector>
#include "../optimizer/sheet.h"
#include "../types.h"

namespace dw {
class Database;

struct CutPlanRecord {
    i64 id = 0;
    std::optional<i64> projectId;
    std::string name;
    std::string algorithm;  // "guillotine" or "first_fit_decreasing"
    // Serialized JSON
    std::string sheetConfigJson;
    std::string partsJson;
    std::string resultJson;
    bool allowRotation = true;
    f32 kerf = 0.0f;
    f32 margin = 0.0f;
    int sheetsUsed = 0;
    f32 efficiency = 0.0f;
    std::string createdAt;
    std::string modifiedAt;
};

class CutPlanRepository {
  public:
    explicit CutPlanRepository(Database& db);

    std::optional<i64> insert(const CutPlanRecord& record);
    std::optional<CutPlanRecord> findById(i64 id);
    std::vector<CutPlanRecord> findAll();
    std::vector<CutPlanRecord> findByProject(i64 projectId);
    bool update(const CutPlanRecord& record);
    bool remove(i64 id);
    i64 count();

    // Serialization helpers
    static std::string sheetToJson(const optimizer::Sheet& sheet);
    static optimizer::Sheet jsonToSheet(const std::string& json);
    static std::string partsToJson(const std::vector<optimizer::Part>& parts);
    static std::vector<optimizer::Part> jsonToParts(const std::string& json);
    static std::string cutPlanToJson(const optimizer::CutPlan& plan);
    static optimizer::CutPlan jsonToCutPlan(const std::string& json);

  private:
    CutPlanRecord rowToRecord(class Statement& stmt);
    Database& m_db;
};
} // namespace dw
```

**src/core/database/cut_plan_repository.cpp:**
- Constructor stores Database reference
- `insert()`: INSERT INTO cut_plans (...) VALUES (?, ?, ...) — bind all fields, return lastInsertId
- `findById()`: SELECT * FROM cut_plans WHERE id = ?
- `findAll()`: SELECT * FROM cut_plans ORDER BY modified_at DESC
- `findByProject()`: SELECT * FROM cut_plans WHERE project_id = ? ORDER BY created_at
- `update()`: UPDATE cut_plans SET ... WHERE id = ?
- `remove()`: DELETE FROM cut_plans WHERE id = ?
- `count()`: SELECT COUNT(*) FROM cut_plans
- `rowToRecord()`: Map Statement columns to CutPlanRecord
- JSON helpers: Use the same manual JSON serialization pattern as CostRepository (no nlohmann dependency in core/database — that's only in export/)

For JSON serialization, use the lightweight approach from cost_repository.cpp:
- `sheetToJson`: `{"width":W,"height":H,"cost":C,"quantity":Q,"name":"N"}`
- `partsToJson`: `[{"id":I,"name":"N","width":W,"height":H,"quantity":Q}, ...]`
- `cutPlanToJson`: Store the SheetResult array with placements — `{"sheets":[...],"unplacedParts":[...],"totalUsedArea":X,...}`

### Task 4: Extend ProjectRepository for notes (project_repository.h, project_repository.cpp)

**project_repository.h — update ProjectRecord:**
Add `std::string notes;` field to `ProjectRecord` struct.

**project_repository.cpp:**
- Update `rowToProject()` to read `notes` column
- Update `insert()` to bind `notes`
- Update `update()` to bind `notes`

### Task 5: Add to CMake (src/CMakeLists.txt)

Add `core/database/cut_plan_repository.h` and `core/database/cut_plan_repository.cpp` to the source list.

### Task 6: Unit tests

**tests/test_cut_plan_repository.cpp** (new file):
- `InsertAndFindById` — insert a record, verify round-trip
- `FindByProject` — insert 2 records for project 1, 1 for project 2, verify filtering
- `Update` — modify name and result, verify
- `Remove` — delete and verify count
- `JsonRoundTrip_Sheet` — serialize/deserialize Sheet
- `JsonRoundTrip_Parts` — serialize/deserialize vector<Part>
- `NullProjectId` — insert with no project, verify findByProject returns empty

**tests/test_gcode_repository.cpp** — add tests:
- `AddToProject` — associate gcode with project, verify findByProject returns it
- `RemoveFromProject` — remove association, verify
- `IsInProject` — verify boolean check
- `CascadeDelete` — delete project, verify project_gcode rows gone

**tests/test_database.cpp** — add:
- `SchemaMigration_v8_to_v9` — verify migration creates new tables and adds notes column

Add new test file to `tests/CMakeLists.txt`.

## Verification

1. `cmake --build build -j$(nproc)` — compiles cleanly
2. `build/tests/dw_tests` — all tests pass including new ones
3. Schema creates cleanly on fresh DB (delete existing test DBs)
4. Migration from v8 to v9 works (existing DB with v8 schema)

## Files Modified

| File | Change |
|------|--------|
| `src/core/database/schema.h` | CURRENT_VERSION 8→9 |
| `src/core/database/schema.cpp` | Add tables + v9 migration |
| `src/core/database/gcode_repository.h` | Add 5 project methods |
| `src/core/database/gcode_repository.cpp` | Implement project methods |
| `src/core/database/project_repository.h` | Add notes to ProjectRecord |
| `src/core/database/project_repository.cpp` | Read/write notes column |
| `src/core/database/cut_plan_repository.h` | **NEW** — CutPlanRecord + CutPlanRepository |
| `src/core/database/cut_plan_repository.cpp` | **NEW** — CRUD + JSON serialization |
| `src/CMakeLists.txt` | Add cut_plan_repository sources |
| `tests/test_cut_plan_repository.cpp` | **NEW** — 7 tests |
| `tests/test_gcode_repository.cpp` | Add 4 project association tests |
| `tests/test_database.cpp` | Add v9 migration test |
| `tests/CMakeLists.txt` | Add test_cut_plan_repository.cpp |

---
phase: 12-extended
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/cnc/cnc_types.h
  - src/ui/panels/cnc_status_panel.h
  - src/ui/panels/cnc_status_panel.cpp
  - src/ui/panels/cnc_console_panel.h
  - src/ui/panels/cnc_console_panel.cpp
  - src/ui/panels/cnc_settings_panel.h
  - src/ui/panels/cnc_settings_panel.cpp
  - src/core/config/config.h
  - src/core/config/config.cpp
  - src/core/utils/log.h
  - src/core/utils/log.cpp
autonomous: true
requirements:
  - EXT-01
  - EXT-02
  - EXT-03
  - EXT-05

must_haves:
  truths:
    - "When GRBL enters alarm state, the alarm code number displays with a full human-readable description and a clickable tooltip or expandable section showing the complete alarm reference table"
    - "When GRBL returns an error response in the console, the error code is shown with its human-readable description inline"
    - "Firmware version info ($I response) is displayed in the CNC settings panel"
    - "Log-to-file can be toggled on/off from the settings panel, routing all log output to a file via the existing setLogFile API"
  artifacts:
    - path: "src/core/cnc/cnc_types.h"
      provides: "Complete GRBL alarm and error reference tables"
      contains: "alarmReference"
    - path: "src/ui/panels/cnc_status_panel.cpp"
      provides: "Alarm reference tooltip/expandable on alarm banner"
      contains: "alarmReference"
    - path: "src/ui/panels/cnc_console_panel.cpp"
      provides: "Error code descriptions inline in console output"
      contains: "errorDescription"
    - path: "src/ui/panels/cnc_settings_panel.cpp"
      provides: "Firmware $I query and version display"
      contains: "firmwareInfo"
    - path: "src/core/config/config.h"
      provides: "Log-to-file toggle config key"
      contains: "getLogToFile"
  key_links:
    - from: "src/ui/panels/cnc_status_panel.cpp"
      to: "src/core/cnc/cnc_types.h"
      via: "alarmReference() for tooltip content"
      pattern: "alarmReference"
    - from: "src/ui/panels/cnc_console_panel.cpp"
      to: "src/core/cnc/cnc_types.h"
      via: "errorDescription() for inline error descriptions"
      pattern: "errorDescription"
    - from: "src/ui/panels/cnc_settings_panel.cpp"
      to: "src/core/cnc/cnc_controller.h"
      via: "sendCommand($I) and onRawLine to capture version"
      pattern: "sendCommand.*\\$I"
---

<objective>
Add complete GRBL alarm/error reference tables, firmware info display, and log-to-file toggle.

Purpose: Give the operator immediate access to human-readable descriptions of every alarm and error code GRBL can produce, plus firmware version info and the ability to save logs to disk for diagnostics.
Output: Expanded alarm/error tables in cnc_types.h, alarm reference tooltip in status panel, inline error descriptions in console, $I firmware info in settings, log-to-file toggle in config/settings.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/core/cnc/cnc_types.h
@src/ui/panels/cnc_status_panel.h
@src/ui/panels/cnc_status_panel.cpp
@src/ui/panels/cnc_console_panel.h
@src/ui/panels/cnc_console_panel.cpp
@src/ui/panels/cnc_settings_panel.h
@src/ui/panels/cnc_settings_panel.cpp
@src/core/config/config.h
@src/core/config/config.cpp
@src/core/utils/log.h
@src/core/utils/log.cpp

<interfaces>
From src/core/cnc/cnc_types.h:
```cpp
// Current alarm descriptions (codes 1-10 only, needs expansion)
inline const char* alarmDescription(int code) { ... }

// Current error descriptions (sparse: 1-3, 9, 14-15, 20, 22-25, 33 — needs full 1-37+)
inline const char* errorDescription(int code) { ... }

// Pin bitmask includes PIN_PROBE = 1 << 3
```

From src/ui/panels/cnc_status_panel.h:
```cpp
class CncStatusPanel : public Panel {
    void renderAlarmBanner();
    int m_lastAlarmCode = 0;
    std::string m_lastAlarmDesc;
};
```

From src/ui/panels/cnc_console_panel.h:
```cpp
class CncConsolePanel : public Panel {
    void onRawLine(const std::string& line, bool isSent);
    void onError(const std::string& message);
    void onAlarm(int code, const std::string& desc);
    void addLine(const std::string& text, int type, MessageSource source);
};
```

From src/ui/panels/cnc_settings_panel.h:
```cpp
class CncSettingsPanel : public Panel {
    void onRawLine(const std::string& line, bool isSent);
    void onConnectionChanged(bool connected, const std::string& version);
    CncController* m_cnc = nullptr;
    bool m_connected = false;
};
```

From src/core/utils/log.h:
```cpp
void setLogFile(const std::string& path); // Already exists, just needs UI exposure
```

From src/core/config/config.h — pattern for adding settings:
```cpp
// Getter + setter with clamp, private member, INI section key in config.cpp
int getStatusPollIntervalMs() const { return m_statusPollIntervalMs; }
void setStatusPollIntervalMs(int ms) { m_statusPollIntervalMs = std::clamp(ms, 50, 200); }
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand GRBL reference tables and add alarm reference tooltip to status panel</name>
  <files>
    src/core/cnc/cnc_types.h
    src/ui/panels/cnc_status_panel.h
    src/ui/panels/cnc_status_panel.cpp
  </files>
  <action>
**cnc_types.h — Complete reference tables (EXT-01, EXT-02):**

1. Expand `alarmDescription()` to include all standard GRBL alarm codes (1-10). The current implementation already has 1-10, so verify completeness. Add more detail to the descriptions:
   - 1: "Hard limit triggered. Machine position lost — re-home required"
   - 2: "G-code motion target exceeds machine travel (soft limit)"
   - 3: "Reset while in motion. Machine position may be lost — re-home recommended"
   - 4: "Probe fail. Probe not contacted within search distance"
   - 5: "Probe fail. Probe already triggered before starting cycle"
   - 6: "Homing fail. Reset during homing cycle"
   - 7: "Homing fail. Safety door opened during homing"
   - 8: "Homing fail. Cycle failed to clear limit switch — check switch wiring and pull-off distance ($27)"
   - 9: "Homing fail. Could not find limit switch — check switch wiring and max travel ($130-$132)"
   - 10: "Homing fail. Second dual-axis limit not found"

2. Expand `errorDescription()` to include ALL standard GRBL error codes 1-37:
   - 1: "G-code word consists of a letter with no value"
   - 2: "Numeric value format is not valid or missing expected value"
   - 3: "Grbl '$' system command was not recognized or supported"
   - 4: "Negative value received for an expected positive value"
   - 5: "Homing cycle is not enabled via settings"
   - 6: "Minimum step pulse time must be greater than 3usec"
   - 7: "EEPROM read failed. Reset and restored to default values"
   - 8: "Grbl '$' command cannot be used unless Grbl is IDLE"
   - 9: "G-code locked out during alarm or jog state"
   - 10: "Homing enabled, soft limits require homing before operation"
   - 11: "Max characters per line exceeded"
   - 12: "Grbl '$' setting value exceeds the maximum step rate supported"
   - 13: "Safety door detected as opened and door state initiated"
   - 14: "Build info or startup line exceeds EEPROM line length limit"
   - 15: "Jog target exceeds machine travel. Jog command has been ignored"
   - 16: "Jog command with no '=' or has prohibited g-code"
   - 17: "Laser mode requires PWM output"
   - 20: "Unsupported or invalid g-code command found in block"
   - 21: "More than one g-code command from same modal group found in block"
   - 22: "Feed rate has not yet been set or is undefined"
   - 23: "G-code command in block requires an integer value"
   - 24: "Two G-code commands that both require the use of the XYZ axis words were detected in the block"
   - 25: "A G-code word was repeated in the block"
   - 26: "A G-code command implicitly or explicitly requires XYZ axis words in the block, but none were found"
   - 27: "N line number value is not within the valid range of 1-9999999"
   - 28: "A G-code command was sent, but is missing some required P or L value words in the line"
   - 29: "Grbl supports six work coordinate systems G54-G59. G59.1, G59.2, and G59.3 are not supported"
   - 30: "The G53 G-code command requires either a G0 seek or G1 feed motion mode to be active"
   - 31: "There are unused axis words in the block and G80 motion mode cancel is active"
   - 32: "A G2 or G3 arc was commanded but there are no XYZ axis words in the selected plane to trace the arc"
   - 33: "The motion command has an invalid target. G2, G3 arcs are incorrectly defined or the target is 0"
   - 34: "A G2 or G3 arc, traced with the radius definition, had a mathematical error computing the arc geometry"
   - 35: "A G2 or G3 arc, traced with the offset definition, is missing the IJK offset word"
   - 36: "There are unused, leftover G-code words that aren't used by any command in the block"
   - 37: "The G43.1 dynamic tool length offset command cannot apply an offset to an axis other than configured"

3. Add a new function that returns the full alarm reference as a static array for the reference table tooltip:

```cpp
struct AlarmEntry {
    int code;
    const char* name;
    const char* description;
};

inline const AlarmEntry* alarmReference(int& count) {
    static const AlarmEntry entries[] = {
        {1, "Hard Limit", "Hard limit triggered. Machine position lost."},
        {2, "Soft Limit", "Motion target exceeds machine travel."},
        // ... all 10 entries with name + description
    };
    count = sizeof(entries) / sizeof(entries[0]);
    return entries;
}

struct ErrorEntry {
    int code;
    const char* description;
};

inline const ErrorEntry* errorReference(int& count) {
    static const ErrorEntry entries[] = {
        {1, "G-code word consists of a letter with no value"},
        // ... all entries
    };
    count = sizeof(entries) / sizeof(entries[0]);
    return entries;
}
```

**CncStatusPanel — Alarm reference tooltip (EXT-01):**

1. In `renderAlarmBanner()`, after the alarm text and unlock button, add a "Reference" button or make the alarm description clickable to show a tooltip with the full alarm reference table:

```cpp
// After the existing unlock button and description:
ImGui::SameLine();
if (ImGui::SmallButton("?##AlarmRef")) {
    // Toggle m_showAlarmRef
}
if (ImGui::IsItemHovered()) {
    ImGui::BeginTooltip();
    ImGui::TextUnformatted("GRBL Alarm Codes");
    ImGui::Separator();
    int count = 0;
    auto* entries = alarmReference(count);
    for (int i = 0; i < count; ++i) {
        bool isActive = (entries[i].code == m_lastAlarmCode);
        if (isActive) ImGui::PushStyleColor(ImGuiCol_Text, ImVec4(1, 0.3f, 0.3f, 1));
        ImGui::Text("ALARM %d: %s — %s", entries[i].code, entries[i].name, entries[i].description);
        if (isActive) ImGui::PopStyleColor();
    }
    ImGui::EndTooltip();
}
```

No new header members needed — the tooltip is stateless.
  </action>
  <verify>cmake --build build -j$(nproc) 2>&1 | tail -5</verify>
  <done>
- alarmDescription() returns detailed descriptions for all 10 GRBL alarm codes
- errorDescription() returns descriptions for all 37 GRBL error codes
- alarmReference() and errorReference() provide structured arrays for UI display
- Alarm banner has a "?" button whose tooltip shows the full alarm reference table with the active alarm highlighted
  </done>
</task>

<task type="auto">
  <name>Task 2: Inline error descriptions in console, firmware info query, and log-to-file toggle</name>
  <files>
    src/ui/panels/cnc_console_panel.h
    src/ui/panels/cnc_console_panel.cpp
    src/ui/panels/cnc_settings_panel.h
    src/ui/panels/cnc_settings_panel.cpp
    src/core/config/config.h
    src/core/config/config.cpp
    src/core/utils/log.h
    src/core/utils/log.cpp
  </files>
  <action>
**CncConsolePanel — Inline error descriptions (EXT-02):**

1. In `onRawLine()`, when a received line matches `"error:N"` pattern, parse the error code N and append the description from `errorDescription(N)`. Modify the addLine call to include the description:

```cpp
// In onRawLine, after detecting "error:" prefix:
if (!isSent && line.substr(0, 6) == "error:") {
    int code = std::atoi(line.c_str() + 6);
    const char* desc = errorDescription(code);
    std::string enhanced = line + " (" + desc + ")";
    // Add as error type with description appended
    addLine(enhanced, ConsoleLine::Error, MessageSource::SYS);
    return; // Don't add the raw line separately
}
```

Include `"../../core/cnc/cnc_types.h"` if not already included (it should be via the header).

2. Also add an error reference tooltip to the console panel. Add a small "Errors" button in the console header area that shows the full error reference table on hover:

```cpp
// In render(), near the Clear button or auto-scroll toggle:
ImGui::SameLine();
if (ImGui::SmallButton("Errors##ref")) {} // Placeholder for click action if needed
if (ImGui::IsItemHovered()) {
    ImGui::BeginTooltip();
    ImGui::TextUnformatted("GRBL Error Codes Reference");
    ImGui::Separator();
    int count = 0;
    auto* entries = errorReference(count);
    for (int i = 0; i < count; ++i) {
        ImGui::Text("%d: %s", entries[i].code, entries[i].description);
    }
    ImGui::EndTooltip();
}
```

**CncSettingsPanel — Firmware info $I (EXT-03):**

1. In cnc_settings_panel.h, add members:
```cpp
std::string m_firmwareInfo;    // Raw $I response
bool m_requestingInfo = false; // Collecting $I response
```

2. In onConnectionChanged(), when connected becomes true, send `$I` to query firmware version:
```cpp
if (connected && m_cnc) {
    m_cnc->sendCommand("$I");
    m_requestingInfo = true;
    m_firmwareInfo.clear();
}
```

3. In onRawLine(), when m_requestingInfo is true, capture lines until an "ok" response:
```cpp
if (m_requestingInfo && !isSent) {
    if (line == "ok") {
        m_requestingInfo = false;
    } else if (line.substr(0, 6) != "error:") {
        if (!m_firmwareInfo.empty()) m_firmwareInfo += "\n";
        m_firmwareInfo += line;
    }
}
```

4. Display firmware info in the settings panel. Add a "Firmware" section at the top of the settings tab, or in the toolbar area:
```cpp
// In renderToolbar() or at the top of render():
if (!m_firmwareInfo.empty()) {
    ImGui::TextDisabled("Firmware:");
    ImGui::SameLine();
    ImGui::TextUnformatted(m_firmwareInfo.c_str());
}
```

**Config — Log-to-file toggle (EXT-05):**

1. In config.h, add getter/setter:
```cpp
bool getLogToFile() const { return m_logToFile; }
void setLogToFile(bool v) { m_logToFile = v; }

const Path& getLogFilePath() const { return m_logFilePath; }
void setLogFilePath(const Path& p) { m_logFilePath = p; }
```

Add private members:
```cpp
bool m_logToFile = false;
Path m_logFilePath; // Empty = default (app data dir / "digital_workshop.log")
```

2. In config.cpp, add to INI [logging] section:
- Key: `log_to_file` (bool, default false)
- Key: `log_file_path` (string, default empty)

3. In log.h / log.cpp, ensure `setLogFile()` is accessible. It already exists. No changes needed to log itself.

4. In cnc_settings_panel.cpp (or a general settings location — the CNC settings panel already has a safety tab, add a logging subsection), add a toggle:
```cpp
// In the safety tab or a new utilities section:
ImGui::SeparatorText("Logging");
auto& cfg = Config::instance();
bool logToFile = cfg.getLogToFile();
if (ImGui::Checkbox("Log to file", &logToFile)) {
    cfg.setLogToFile(logToFile);
    if (logToFile) {
        Path logPath = cfg.getLogFilePath();
        if (logPath.empty()) {
            logPath = app_paths::getDataDir() / "digital_workshop.log";
            cfg.setLogFilePath(logPath);
        }
        log::setLogFile(logPath);
    } else {
        log::setLogFile(""); // Close log file
    }
    cfg.save();
}
if (logToFile) {
    Path logPath = cfg.getLogFilePath();
    ImGui::TextDisabled("Path: %s", logPath.c_str());
}
```

Include `"../../core/utils/log.h"` and `"../../core/config/config.h"` in cnc_settings_panel.cpp if not already present. Also include `"../../core/utils/app_paths.h"` for getDataDir().

**IMPORTANT:** Also apply the log-to-file setting at application startup. In application.cpp (search for where Config is loaded), check if logToFile is enabled and call setLogFile. Since application.cpp is NOT in this plan's files, add a TODO comment in config.cpp noting that the application startup should check getLogToFile() and call log::setLogFile() accordingly. The settings panel toggle handles runtime changes.
  </action>
  <verify>cmake --build build -j$(nproc) 2>&1 | tail -5</verify>
  <done>
- Console shows "error:N (description)" for every GRBL error response
- Console has an "Errors" hover-tooltip showing full error reference table
- Settings panel displays firmware version from $I query after connection
- Log-to-file is togglable from settings, calls existing setLogFile API
- Log file path defaults to app data directory
  </done>
</task>

</tasks>

<verification>
- cmake --build build -j$(nproc) -- builds without errors
- ctest --test-dir build --output-on-failure -- all existing tests pass
</verification>

<success_criteria>
- All 10 GRBL alarm codes have detailed human-readable descriptions
- All 37 GRBL error codes have human-readable descriptions
- Alarm reference table is accessible from the alarm banner via tooltip
- Error reference table is accessible from the console panel
- Firmware $I response is displayed in the settings panel
- Log-to-file toggle persists to Config INI and activates file logging
</success_criteria>

<output>
After completion, create `.planning/phases/12-extended/12-01-SUMMARY.md`
</output>

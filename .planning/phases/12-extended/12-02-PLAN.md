---
phase: 12-extended
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/panels/cnc_settings_panel.cpp
  - src/ui/panels/gcode_panel.h
  - src/ui/panels/gcode_panel.cpp
autonomous: true
requirements:
  - EXT-04
  - EXT-12

must_haves:
  truths:
    - "Operator can export GRBL settings to a plain text file with human-readable $N=value format"
    - "Operator can search loaded G-code text and jump to matching lines"
  artifacts:
    - path: "src/ui/panels/cnc_settings_panel.cpp"
      provides: "Export to plain text file alongside existing JSON backup"
      contains: "exportPlainText"
    - path: "src/ui/panels/gcode_panel.cpp"
      provides: "Search/goto functionality for loaded G-code"
      contains: "m_searchBuf"
  key_links:
    - from: "src/ui/panels/cnc_settings_panel.cpp"
      to: "src/core/cnc/grbl_settings.h"
      via: "GrblSettings iteration for plain-text export"
      pattern: "m_settings"
    - from: "src/ui/panels/gcode_panel.cpp"
      to: "src/ui/panels/gcode_panel.h"
      via: "Search state members drive find/scroll behavior"
      pattern: "m_searchBuf"
---

<objective>
Add plain-text GRBL settings export and G-code search/goto functionality.

Purpose: Operators need to share and archive GRBL settings in a human-readable format (not just JSON), and quickly navigate to specific lines in large G-code files.
Output: Plain text export button in settings panel, search bar with find-next/goto in G-code panel.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/ui/panels/cnc_settings_panel.h
@src/ui/panels/cnc_settings_panel.cpp
@src/core/cnc/grbl_settings.h
@src/ui/panels/gcode_panel.h
@src/ui/panels/gcode_panel.cpp

<interfaces>
From src/core/cnc/grbl_settings.h:
```cpp
struct GrblSetting {
    int id;
    float value;
    std::string description; // Human-readable name
};

class GrblSettings {
    bool empty() const;
    const std::vector<GrblSetting>& all() const;
    std::string toJson() const;
    static GrblSettings fromJson(const std::string& json);
};
```

From src/ui/panels/cnc_settings_panel.h:
```cpp
class CncSettingsPanel : public Panel {
    void backupToFile();       // Existing JSON backup
    FileDialog* m_fileDialog;
    GrblSettings m_settings;
};
```

From src/ui/panels/gcode_panel.h:
```cpp
class GCodePanel : public Panel {
    gcode::Program m_program;  // Parsed program with commands
    std::string m_filePath;    // Loaded file path
    int m_lastAckedLine = -1;  // Progress highlighting
    // renderToolbar() has existing buttons
};

// gcode::Program contains:
// std::vector<gcode::Command> commands;
// Each command has: int lineNumber, std::string rawText
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plain text GRBL settings export and G-code search/goto</name>
  <files>
    src/ui/panels/cnc_settings_panel.cpp
    src/ui/panels/gcode_panel.h
    src/ui/panels/gcode_panel.cpp
  </files>
  <action>
**CncSettingsPanel — Plain text export (EXT-04):**

1. Add an "Export Text" button next to the existing "Backup" button in `renderToolbar()`:

```cpp
if (ImGui::Button("Export Text")) {
    exportPlainText();
}
if (ImGui::IsItemHovered()) ImGui::SetTooltip("Export settings as plain text file");
```

2. Implement `exportPlainText()` as a private method. Use the FileDialog to get a save path with `.txt` extension filter:

```cpp
void CncSettingsPanel::exportPlainText() {
    if (m_settings.empty()) return;

    // Use FileDialog for save path
    m_fileDialog->saveFile("Export GRBL Settings", "*.txt", [this](const std::string& path) {
        std::ofstream file(path);
        if (!file.is_open()) return;

        file << "; GRBL Settings Export\n";
        file << "; Generated by Digital Workshop\n";
        file << ";\n";

        for (const auto& setting : m_settings.all()) {
            file << "$" << setting.id << "=" << setting.value;
            if (!setting.description.empty()) {
                file << " ; " << setting.description;
            }
            file << "\n";
        }
    });
}
```

Check how backupToFile() uses FileDialog. Follow the same pattern. If FileDialog uses a callback pattern, match it. If it opens synchronously, use that. The key is to produce output like:
```
; GRBL Settings Export
$0=10.000 ; Step pulse (usec)
$1=25.000 ; Step idle delay (msec)
$2=0.000 ; Step port invert (mask)
...
```

**GCodePanel — Search/goto (EXT-12):**

1. In gcode_panel.h, add search state members:
```cpp
// G-code search/goto
char m_searchBuf[128] = "";
int m_searchResultLine = -1;  // Line index of current match (-1 if no match)
bool m_searchActive = false;
int m_gotoLine = 0;           // Line number for goto
```

2. In gcode_panel.cpp, add a `renderSearchBar()` private method and call it from the toolbar or below it:

```cpp
void GCodePanel::renderSearchBar() {
    if (!hasGCode()) return;

    // Toggle search with Ctrl+F
    if (ImGui::GetIO().KeyCtrl && ImGui::IsKeyPressed(ImGuiKey_F)) {
        m_searchActive = !m_searchActive;
        if (m_searchActive) {
            ImGui::SetKeyboardFocusHere();
        }
    }

    if (!m_searchActive) return;

    ImGui::Separator();
    ImGui::SetNextItemWidth(200);
    bool searchChanged = ImGui::InputText("##Search", m_searchBuf, sizeof(m_searchBuf),
        ImGuiInputTextFlags_EnterReturnsTrue);

    ImGui::SameLine();
    if (ImGui::SmallButton("Find Next") || searchChanged) {
        findNext();
    }

    ImGui::SameLine();
    ImGui::SetNextItemWidth(80);
    if (ImGui::InputInt("##Goto", &m_gotoLine, 0, 0, ImGuiInputTextFlags_EnterReturnsTrue)) {
        gotoLine(m_gotoLine);
    }
    if (ImGui::IsItemHovered()) ImGui::SetTooltip("Go to line number");

    ImGui::SameLine();
    if (ImGui::SmallButton("X##CloseSearch")) {
        m_searchActive = false;
        m_searchBuf[0] = '\0';
        m_searchResultLine = -1;
    }

    if (m_searchResultLine >= 0) {
        ImGui::SameLine();
        ImGui::TextDisabled("Match at line %d", m_searchResultLine + 1);
    }
}
```

3. Implement `findNext()` — searches from current position forward through raw lines:
```cpp
void GCodePanel::findNext() {
    if (m_searchBuf[0] == '\0') return;

    std::string needle(m_searchBuf);
    // Case-insensitive search: convert needle to upper
    std::string upperNeedle = needle;
    for (auto& c : upperNeedle) c = static_cast<char>(std::toupper(c));

    int startLine = m_searchResultLine + 1;
    auto lines = getRawLines();
    int total = static_cast<int>(lines.size());

    for (int i = 0; i < total; ++i) {
        int idx = (startLine + i) % total;
        std::string upper = lines[idx];
        for (auto& c : upper) c = static_cast<char>(std::toupper(c));
        if (upper.find(upperNeedle) != std::string::npos) {
            m_searchResultLine = idx;
            // Scroll the line list to this line (set ImGui scroll target)
            m_scrollToLine = idx; // Add m_scrollToLine member
            return;
        }
    }
    m_searchResultLine = -1; // No match found
}
```

4. Implement `gotoLine(int lineNum)` — scrolls the G-code listing to that line number:
```cpp
void GCodePanel::gotoLine(int lineNum) {
    int idx = lineNum - 1; // Convert 1-based to 0-based
    if (idx >= 0 && idx < static_cast<int>(m_program.commands.size())) {
        m_scrollToLine = idx;
        m_searchResultLine = idx;
    }
}
```

5. Add `int m_scrollToLine = -1;` member to gcode_panel.h.

6. In the code listing render function (wherever individual lines are rendered), check `m_scrollToLine`:
```cpp
if (m_scrollToLine >= 0 && m_scrollToLine == lineIndex) {
    ImGui::SetScrollHereY(0.5f);
    m_scrollToLine = -1;
}
// Highlight the search result line
if (m_searchResultLine == lineIndex) {
    ImGui::TableSetBgColor(ImGuiTableBgTarget_RowBg0, IM_COL32(60, 60, 0, 128));
}
```

7. Add `renderSearchBar` declaration to the private section of gcode_panel.h, plus `findNext()` and `gotoLine(int)`.

**IMPORTANT:** Check how the G-code listing is currently rendered in gcode_panel.cpp. It likely uses a clipper or table for the line list. The scroll-to and highlight must integrate with that existing rendering pattern. If it uses ImGuiListClipper, use `SetItemDefaultFocus()` or set scroll position manually based on line height.
  </action>
  <verify>cmake --build build -j$(nproc) 2>&1 | tail -5</verify>
  <done>
- Settings panel has "Export Text" button that saves settings as $N=value format with descriptions
- G-code panel has Ctrl+F toggle for search bar
- Search finds text in G-code lines and scrolls to match
- Goto field accepts line number and scrolls to it
- Current search match is highlighted in the listing
  </done>
</task>

</tasks>

<verification>
- cmake --build build -j$(nproc) -- builds without errors
- ctest --test-dir build --output-on-failure -- all existing tests pass
</verification>

<success_criteria>
- Plain text export produces readable $N=value ; description format
- G-code search is case-insensitive and wraps around
- Goto accepts a line number and scrolls to it
- Search match is visually highlighted in the listing
</success_criteria>

<output>
After completion, create `.planning/phases/12-extended/12-02-SUMMARY.md`
</output>
